/* Warning: Table [dbo].[BedMst], Column: [BedId], IDENTITY Column change requires drop & create column. */

/* Warning: Table [dbo].[BedMst], Column: [BedId], IDENTITY Seed value change requires drop & create column. */

/* Warning: Table [dbo].[BedMst], Column: [BedId], IDENTITY Increment value change requires drop & create column. */

/* Warning: Table [dbo].[RoomMst], Column: [RoomId], IDENTITY Column change requires drop & create column. */

/* Warning: Table [dbo].[RoomMst], Column: [RoomId], IDENTITY Seed value change requires drop & create column. */

/* Warning: Table [dbo].[RoomMst], Column: [RoomId], IDENTITY Increment value change requires drop & create column. */

/* Warning: Table [dbo].[RoomType], Column: [RTypeId], IDENTITY Column change requires drop & create column. */

/* Warning: Table [dbo].[RoomType], Column: [RTypeId], IDENTITY Seed value change requires drop & create column. */

/* Warning: Table [dbo].[RoomType], Column: [RTypeId], IDENTITY Increment value change requires drop & create column. */

/* Warning: Table [dbo].[TBL_MenuMaster], Column: [MenuID], IDENTITY Column change requires drop & create column. */

/* Warning: Table [dbo].[TBL_MenuMaster], Column: [MenuID], IDENTITY Seed value change requires drop & create column. */

/* Warning: Table [dbo].[TBL_MenuMaster], Column: [MenuID], IDENTITY Increment value change requires drop & create column. */

ALTER TABLE [dbo].[BedMst] DROP CONSTRAINT [PK_BedMst]
GO

ALTER TABLE [dbo].[ChargeBill_Details] ADD [DrugName] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [InsuCompanyId] int  NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [CoverageDetails] nvarchar(4000) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [Discount] float(53) DEFAULT 0 NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [DiscountAmt] float(53) DEFAULT 0 NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [ActualInsuAmt] float(53) DEFAULT 0 NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [DiscountGivenBy] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [DiscountGivenOn] datetime  NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [DiscountRemark] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [PaymentReceive] bit DEFAULT 0 NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [PaymentReceiveBy] nvarchar(250) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [PaymentReceiveOn] datetime  NULL
GO

ALTER TABLE [dbo].[ChargeBill_Master] ADD [PayRecNo] nvarchar(50) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

CREATE TABLE [dbo].[CompanyMercy] (
  [ID] int  NOT NULL,
  [CompanyName] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [CompanyCode] nvarchar(50) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [Address] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [Phone] nvarchar(50) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [OPD] bit DEFAULT 0 NULL,
  [IPD] bit DEFAULT 0 NULL,
  [Insurance] bit  NULL,
  [Code] nvarchar(50) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
)
GO

ALTER TABLE [dbo].[CompanyMercy] SET (LOCK_ESCALATION = TABLE)
GO

ALTER TABLE [dbo].[IpdRegistration] DROP COLUMN [SurgeryName]
GO

ALTER TABLE [dbo].[LabRegistration] DROP COLUMN [TestReferBy]
GO

ALTER TABLE [dbo].[PatientInformation] ALTER COLUMN [FirstName] varchar(500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO

ALTER TABLE [dbo].[PatientInformation] ALTER COLUMN [MiddleName] varchar(500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO

ALTER TABLE [dbo].[PatientInformation] ALTER COLUMN [LastName] varchar(500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [VaccinationStatus] nvarchar(250) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [Allergy] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [ChiefComplant] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [ReligionId] int  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [HealthCardNo] nvarchar(250) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [PassportNo] nvarchar(250) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [RaceId] int  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [Relation] int  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [RelativeName] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [ContactNo] nvarchar(50) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [RelaAddress] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [Relation1] int  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [RelativeName1] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [ContactNo1] nvarchar(50) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

ALTER TABLE [dbo].[PatientInformation] ADD [RelaAddress1] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL
GO

CREATE TABLE [dbo].[PatientInsu_SubType11] (
  [Id] int  IDENTITY(1,1) NOT NULL,
  [PatientMainType] int  NULL,
  [PatientInsuTypeId] int  NULL,
  [ChildCompanyName] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [ContactNumber] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [CompanyDescription] nvarchar(2550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [CreatedBy] nvarchar(250) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [BranchId] int  NULL,
  [CreatedOn] datetime DEFAULT getdate() NULL
)
GO

ALTER TABLE [dbo].[PatientInsu_SubType11] SET (LOCK_ESCALATION = TABLE)
GO

CREATE TABLE [dbo].[PatientInsu_SubType123] (
  [Id] int  IDENTITY(1,1) NOT NULL,
  [PatientMainType] int  NULL,
  [PatientInsuTypeId] int  NULL,
  [ChildCompanyName] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [ContactNumber] nvarchar(550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [CompanyDescription] nvarchar(2550) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [CreatedBy] nvarchar(250) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [BranchId] int  NULL,
  [CreatedOn] datetime DEFAULT getdate() NULL
)
GO

ALTER TABLE [dbo].[PatientInsu_SubType123] SET (LOCK_ESCALATION = TABLE)
GO

ALTER TABLE [dbo].[RoomType] ADD [status] bit  NULL
GO

ALTER TABLE [dbo].[RoomType] DROP CONSTRAINT [DF_RoomType_Status]
GO

ALTER TABLE [dbo].[RoomType] DROP COLUMN [Status]
GO

ALTER PROCEDURE [dbo].[SP_Announcement]

@DrId nvarchar(50)='',
@Patregid nvarchar(250)='',
@LabPtype nvarchar(50)='',
@ReferBy nvarchar(50)=''
as


select  * from  LabEMRRegistration where ipdno>0 and Isemergency=1 and IsPatientChecked=0 and DrId=@DrId and PatRegId=@Patregid and LabPtype=@LabPtype and ReferBy=@ReferBy
GO

ALTER PROCEDURE [dbo].[SP_BillServiceInsert]
@ServiceName nvarchar(550),
@ServiceOrder int,
@BillGroupid int, 
@IsIpd bit,
@IsOpd bit,
@Isdoc bit,
@IsDirect bit, 
@IsActive bit,
@UnitOfCharges nvarchar(50),
@IsRoomwise bit,
@FId varchar(20), 
@BranchId int,

@CreatedBy varchar(200),
@ISIPDDaily bit=0,
@DailyServiceName nvarchar(550)=null,
@RoomType int=0

AS
BEGIN
IF not exists (SELECT ServiceName FROM  BillService  WHERE ServiceName=@ServiceName and BillGroupid=@BillGroupid ) 
BEGIN


INSERT INTO BillService (
ServiceName ,ServiceOrder ,BillGroupid ,IsIpd ,IsOpd ,Isdoc , IsDirect, IsActive,UnitOfCharges,IsRoomwise,FId, BranchId,CreatedBy,CreatedOn,UpdatedBy,UpdatedOn,ISIPDDaily,DailyServiceName,RoomType)

 VALUES(
@ServiceName,@ServiceOrder,@BillGroupid, @IsIpd ,@IsOpd,@Isdoc,@IsDirect,@IsActive,@UnitOfCharges,@IsRoomwise,@FId, @BranchId,@CreatedBy,getdate(),@CreatedBy,getdate(),@ISIPDDaily,@DailyServiceName,@RoomType)
SELECT '1Record Inserted Successfully'
END
ELSE IF exists (SELECT ServiceName  FROM  BillService  WHERE 
    ServiceName=@ServiceName and BillGroupid=@BillGroupid) 
	
			
BEGIN
SELECT '0BillService Already Exists'
END
END
GO

CREATE PROCEDURE [dbo].[SP_BindPatientInsu_SubType]
@PatientInsuTypeId int=0
as
SELECT '0' AS Id,'Select Title' AS ChildCompanyName FROM PatientInsu_SubType 
UNION 

SELECT        Id,  ChildCompanyName
FROM            PatientInsu_SubType where PatientInsuTypeId=@PatientInsuTypeId
GO

ALTER PROCEDURE [dbo].[Sp_BindRooms] 
	-- Add the parameters for the stored procedure here
	@RTypeId int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	select RoomId,RoomName from RoomMst where RTypeId=@RTypeId
    
END
GO

ALTER PROCEDURE [dbo].[Sp_CancelProcedureBill]    
 -- Add the parameters for the stored procedure here    
         
@BillNo int=0,       
@PatRegId int=0,    
      
@ProcedureId int,    
@BillGroup nvarchar(max),     
@FId int=0,    
@BranchId int,    
@CreatedBy nvarchar(250)=null    
    
     
    
AS    
BEGIN    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 -- interfering with SELECT statements.    
 SET NOCOUNT ON;    
  Declare @OpdNo int  

Declare @BillAmount float
Declare @InsuranceAmt float
declare @ChargeId int
  select @OpdNo=OpdNo from ProcedureBillMaster where ProcedureId=@ProcedureId   
  
  if(@OpdNo>0)  
  begin  
  update OpdRegistration set iscancel=1 where opdno=@OpdNo and PatRegId=@PatRegId   
  end  
 update ProcedureBillMaster set CancelBill=1,CancelBy=@CreatedBy,CancelOn=getdate() where  PatRegId=@PatRegId and ProcedureId=@ProcedureId and BillNo=@BillNo and BranchId=@BranchId --and BillGroup=@BillGroup     
 update ProcedurePaymentTrns set CancelBill=1 where  PatRegId=@PatRegId and ProcedureId=@ProcedureId and BillNo=@BillNo  and BranchId=@BranchId --and BillGroup=@BillGroup    
 update ProcedureServiceDetails set CancelBill=1 where  PatRegId=@PatRegId and ProcedureId=@ProcedureId and BillNo=@BillNo  and BranchId=@BranchId --and BillGroup=@BillGroup 
 
        select @BillAmount=BillAmount,@InsuranceAmt=InsuranceAmt from ProcedureBillMaster where  CancelBill=1 and PatRegId=@PatRegId and ProcedureId=@ProcedureId and BillNo=@BillNo and BranchId=@BranchId 
		 select distinct @ChargeId=ChargeId from ChargeBill_Details where  PatRegId=@PatRegId and BillNo=@BillNo 
		 
		update ChargeBill_Master set BillAmt=BillAmt-@BillAmount,InsuranceAmt=InsuranceAmt-@InsuranceAmt where Patregid=@PatRegId and Id=@ChargeId

	   update ChargeBill_Details set Charges=0,CancelBill=1 where Patregid=@PatRegId and BillNo=@BillNo
END
GO

CREATE PROCEDURE [dbo].[SP_ChangeDr]
@OpdNo int=0,
@Patregid int=0
as
SELECT        OpdRegistration.OpdNo, OpdRegistration.TokenNo, OpdRegistration.PatRegId, OpdRegistration.DrId, OpdRegistration.VisitingNo, OpdRegistration.Entrydate, OpdRegistration.RegistrationType, OpdRegistration.ReferenceDoc, 
OpdRegistration.DeptId, OpdRegistration.PatientComplaints, OpdRegistration.PatientMainCategoryId, OpdRegistration.PatientSubCategoryId, OpdRegistration.FId, OpdRegistration.BranchId, OpdRegistration.CreatedBy, 
OpdRegistration.CreatedOn, OpdRegistration.UpdatedBy, OpdRegistration.UpdatedOn, OpdRegistration.IsPatientChecked, OpdRegistration.VaccinationStatus, OpdRegistration.LetterNo, OpdRegistration.TypeOfVisit, 
OpdRegistration.IsCancel, CAST(OpdRegistration.DrId AS nvarchar(50)) + '-' + Initial.Title + '.' + HospEmpMst.Empname AS DrName, Initial.Title, DepartmentMst.DeptName
,CAST(OpdRegistration.DeptId AS nvarchar(50)) + '-' + DepartmentMst.DeptName AS DeptName
FROM            OpdRegistration INNER JOIN
HospEmpMst ON OpdRegistration.DrId = HospEmpMst.DrId INNER JOIN
Initial ON HospEmpMst.Title = Initial.Title INNER JOIN
DepartmentMst ON HospEmpMst.DeptId = DepartmentMst.DeptId where  OpdRegistration.OpdNo=@OpdNo and OpdRegistration.PatRegId=@Patregid
GO

CREATE PROCEDURE [dbo].[SP_ChargePatientInvoiceDetails]
@Id int
as

select * from Vw_PatientInsuranceDetailsForInvoice_ForOPD_Report where Id=@Id
GO

ALTER PROCEDURE [dbo].[Sp_CheckExistPatient]
	-- Add the parameters for the stored procedure here
	@FirstName nvarchar(300)='',
	@BirthDate datetime =null,
	@MobileNo nvarchar(50)

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	if Exists(select * from PatientInformation where FirstName=@FirstName and MobileNo=@MobileNo and Cast(BirthDate as date)=Cast(@BirthDate as date))
	begin
	Select 'Yes'
	end
END
GO

CREATE PROCEDURE [dbo].[SP_CountNoOfFile]

@Patregid int=0
as
select count(MedicalId)+1 as RecordCount from AddMedicalRecord where PatientType='IPD' and Patregid=@Patregid
GO

CREATE PROCEDURE [dbo].[Sp_DeletePatient_ChargeService]  
@ID int  
AS  
BEGIN  

declare @Charges float=0
declare @ChargeId int=0
select @Charges=Charges*Qty,@ChargeId=ChargeId from ChargeBill_Details where ID=@ID
UPDATE ChargeBill_Master SET BillAmt=Billamt-@Charges,InsuranceAmt=InsuranceAmt-@Charges WHERE ID=@ChargeId 

delete from  ChargeBill_Details where ID=@ID
 
SELECT '1Record Deleted Successfuly'  
END
GO

CREATE PROCEDURE [dbo].[Sp_DeletePatientInsu_SubType]
@Id int
AS
BEGIN
Delete from PatientInsu_SubType WHERE Id=@Id
SELECT '1Record Deleted Successfully'
END
GO

ALTER PROCEDURE [dbo].[Sp_EMRLabServiceDetails]  
@PatRegId int=0,   
@BillGroup nvarchar(50),  
@BillServiceId int=0,  
@BillServiceCharges float=0,  
@TotalCharges float=0,  
@Qty float=0,  
@DrId int=0,  
@FId int=1,  
@BillNo int=0,  
@BranchId int=1,  
@ProcedureId int=0,  
@CreatedBy nvarchar(50)='' ,  
@OPDNo int=0,  
@ReceiptNo int=0,  
@LabNo int=0,  
@MTCode nvarchar(4000)='',  
  
@Initial nvarchar(50)='',  
@PatientName nvarchar(500)='',  
@Age nvarchar(50)='',  
@RefDoc nvarchar(250)='',  
@TestName nvarchar(4000)='',  
@TestRate nvarchar(50)='',  
@MobileNo nvarchar(50)='',  
@MDY nvarchar(50)='',  
@Sex nvarchar(50)='',  
@ReferBy nvarchar(250)='',  
@IPDNO int=0,  
@ReferPhy nvarchar(250)=null,  
@OtherRefDoc nvarchar(250)=null,  
@MainDocId int=0,  
@InsuranceId int=0,  
@InsuranceAmt float=0,  
@PaidAmt float=0,  
@BalanceAmt float=0,  
@DiscountAmt float=0,  
@ModeOfPay nvarchar(50)='',  
@LabPtype nvarchar(50)='',  
@PatAddress nvarchar (550)='',  
@PatBirthDate Datetime =null,  
@ClinicalHistory nvarchar(2550)  
  
AS  
BEGIN  
  
declare @Centercode nvarchar(250)    
if(@LabPtype='P')  
begin  
select top(1) @Centercode=DoctorCode from Pathology.dbo.DrMT where DoctorCode='OPD' and DrType='CC' and Mainflag=1  
end  
if(@LabPtype='R')  
begin  
select top(1) @Centercode=DoctorCode from Radiology.dbo.DrMT where DoctorCode='OPD' and DrType='CC' and Mainflag=1  
end  
if(@LabPtype='M')  
begin  
select top(1) @Centercode=DoctorCode from Laboratory.dbo.DrMT where DoctorCode='OPD' and DrType='CC' and Mainflag=1  
end  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
   
  
if(@LabPtype='P')  
begin  
insert into LabEMRServiceDetails (PatRegId,BillGroup,BillServiceId,Qty,BillServiceCharges,TotalCharges,DrId,FId,BillNo,BranchId,CreatedBy,CreatedOn,ProcedureId,OPDNo,ReceiptNo,LabNo,MTCode,ServiceName,IPDNO,ClinicalHistory) values  
(@PatRegId,19,@BillServiceId,@Qty,@BillServiceCharges,@TotalCharges,@DrId,@FId,@BillNo,@BranchId,@CreatedBy,getdate(),@ProcedureId,@OPDNo,@ReceiptNo,@LabNo,@MTCode,@TestName,@IPDNO,@ClinicalHistory)  
  
end  
if(@LabPtype='R')  
begin  
insert into LabEMRServiceDetails (PatRegId,BillGroup,BillServiceId,Qty,BillServiceCharges,TotalCharges,DrId,FId,BillNo,BranchId,CreatedBy,CreatedOn,ProcedureId,OPDNo,ReceiptNo,LabNo,MTCode,ServiceName,IPDNO,ClinicalHistory) values  
(@PatRegId,20,@BillServiceId,@Qty,@BillServiceCharges,@TotalCharges,@DrId,@FId,@BillNo,@BranchId,@CreatedBy,getdate(),@ProcedureId,@OPDNo,@ReceiptNo,@LabNo,@MTCode,@TestName,@IPDNO,@ClinicalHistory)  
  
end  
if(@LabPtype='M')  
begin  
insert into LabEMRServiceDetails (PatRegId,BillGroup,BillServiceId,Qty,BillServiceCharges,TotalCharges,DrId,FId,BillNo,BranchId,CreatedBy,CreatedOn,ProcedureId,OPDNo,ReceiptNo,LabNo,MTCode,ServiceName,IPDNO,ClinicalHistory) values  
(@PatRegId,16,@BillServiceId,@Qty,@BillServiceCharges,@TotalCharges,@DrId,@FId,@BillNo,@BranchId,@CreatedBy,getdate(),@ProcedureId,@OPDNo,@ReceiptNo,@LabNo,@MTCode,@TestName,@IPDNO,@ClinicalHistory)  
  
end  
select '1Record Saved SuccessFully'  
   
END
GO

CREATE PROCEDURE [dbo].[Sp_FillInsuranceCompInvoice_ForOPD]  
 -- Add the parameters for the stored procedure here  
 --@InvoiceNo int,  
 @FromDate varchar(20) =null,  
 @ToDate varchar(20) =null,  
 @FId int,  
 @BranchId int,  
 @InsuranceCompId int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  
    -- Insert statements for procedure here  
 --insert into PatientInvoiceDetails (InvoiceNo,PatRegId,InsuranceAmount,IpdNo,Sponser,FId,BranchId,TransactionDate)  
--Select @InvoiceNo,PatRegId,Sponsor1Amt,IpdNo,Sponsor1,@FId,@BranchId,getdate() From Vw_InsuranceBillAmountTotal where IsDischarge=1 and SponsorStatus='Accept'  
--and  Sponsor1=@InsuranceCompId and   CONVERT(date, FinalDischargeOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''  
Select * From ChargeBill_Master where CancelBill=0 and GenerateInvoice=0  
and  InsuranceCompId=@InsuranceCompId and   CONVERT(date, CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''  
  
END
GO

CREATE PROCEDURE [dbo].[Sp_FillTypeWiseOPDBillServices]  
 -- Add the parameters for the stored procedure here  
 @ServiceType nvarchar(200),  
 @Search nvarchar(50)  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
    -- Insert statements for procedure here  
  
 if(@ServiceType='Package')  
  begin  
    
  select  cast( PackId as nvarchar(50))  + ' - ' + PackageName as ServiceName from PackMst  where  (PackageName like '%'+@Search+'%')  
  
  end  
 if(@ServiceType='Room')  
 begin  
   
  select cast( BillServiceId as nvarchar(50)) + ' - ' + ServiceName as ServiceName from BillService where IsRoomwise=1 and IsIpd=1 and IsActive=1 and BillGroupid=1 and (ServiceName like '%'+@Search+'%')  
  end  
  if(@ServiceType='Consultation')  
  begin  
    
  select  cast( BillServiceId as nvarchar(50))  + ' - ' + ServiceName as ServiceName from BillService where IsDoc=1 and IsActive=1
  and BillGroupid=1 and (ServiceName like '%'+@Search+'%')  
  
  end  
  if(@ServiceType='Other')  
  begin  
    
  select  cast( BillServiceId as nvarchar(50))  + ' - ' + ServiceName as ServiceName from BillService where IsDirect=1 and IsActive=1 and BillGroupid<>2 and BillGroupid<>1 and (ServiceName like '%'+@Search+'%')  
  
  end  
  if(@ServiceType='Lab')  
  begin  
   
  select  cast( BillServiceId as nvarchar(50))  + ' - ' + ServiceName as ServiceName from BillService where IsDirect=1 and IsIpd=1 and IsActive=1 and BillGroupid=3 and (ServiceName like '%'+@Search+'%')  
  
  end  
  if(@ServiceType='Drugs')  
  begin  
    
  select  cast( DrugId as nvarchar(50))  + ' - ' + ItemDescription as ServiceName from DrugDetails  where (ItemDescription like '%'+@Search+'%')  
  
  end  
  
  if(@ServiceType='OPD')  
  begin  
   SELECT CAST(BillService.BillServiceId AS nvarchar(50)) + ' - ' + BillService.ServiceName AS ServiceName, BillGroup.GroupName  
FROM    BillService LEFT OUTER JOIN  
                 BillGroup ON BillService.BillGroupid = BillGroup.BillGroupId where BillService.IsActive=1 and GroupName='OPD'  and (ServiceName like '%'+@Search+'%')  
  
  end  
  
  if(@ServiceType='EEG OPD')  
  begin  
   SELECT CAST(BillService.BillServiceId AS nvarchar(50)) + ' - ' + BillService.ServiceName AS ServiceName, BillGroup.GroupName  
FROM    BillService LEFT OUTER JOIN  
                 BillGroup ON BillService.BillGroupid = BillGroup.BillGroupId where BillService.IsActive=1 and GroupName='EEG OPD'  and (ServiceName like '%'+@Search+'%')  
  
  end  
  if(@ServiceType='EMERGENCY')  
  begin  
  SELECT CAST(BillService.BillServiceId AS nvarchar(50)) + ' - ' + BillService.ServiceName AS ServiceName, BillGroup.GroupName  
FROM    BillService LEFT OUTER JOIN  
                 BillGroup ON BillService.BillGroupid = BillGroup.BillGroupId where BillService.IsActive=1 and GroupName='EMERGENCY'  and (ServiceName like '%'+@Search+'%')  
  
  end  
  if(@ServiceType='OPTHAL')  
  begin  
   SELECT CAST(BillService.BillServiceId AS nvarchar(50)) + ' - ' + BillService.ServiceName AS ServiceName, BillGroup.GroupName  
FROM    BillService LEFT OUTER JOIN  
                 BillGroup ON BillService.BillGroupid = BillGroup.BillGroupId where BillService.IsActive=1 and GroupName='OPTHAL'  and (ServiceName like '%'+@Search+'%')  
  
  end  
  if(@ServiceType='AMBULANCE')  
  begin  
   SELECT CAST(BillService.BillServiceId AS nvarchar(50)) + ' - ' + BillService.ServiceName AS ServiceName, BillGroup.GroupName  
FROM    BillService LEFT OUTER JOIN  
                 BillGroup ON BillService.BillGroupid = BillGroup.BillGroupId where BillService.IsActive=1 and GroupName='AMBULANCE'  and (ServiceName like '%'+@Search+'%')  
  
  end  
   if(@ServiceType='HOSPITAL')  
  begin  
   SELECT CAST(BillService.BillServiceId AS nvarchar(50)) + ' - ' + BillService.ServiceName AS ServiceName, BillGroup.GroupName  
FROM    BillService LEFT OUTER JOIN  
                 BillGroup ON BillService.BillGroupid = BillGroup.BillGroupId where BillService.IsActive=1 and (GroupName='Hospital' or GroupName='HOSPITAL')  and (ServiceName like '%'+@Search+'%')  
  
  end  
END
GO

CREATE PROCEDURE [dbo].[Sp_FillTypeWiseOPDBillServices_Charge]      
 -- Add the parameters for the stored procedure here      
 @ServiceType nvarchar(200),      
 @Search nvarchar(50)      
AS      
BEGIN      
 -- SET NOCOUNT ON added to prevent extra result sets from      
 -- interfering with SELECT statements.      
 SET NOCOUNT ON;      
    -- Insert statements for procedure here      
      

	    SELECT CAST(BillService.BillServiceId AS nvarchar(50)) + ' - ' + BillService.ServiceName AS ServiceName, BillGroup.GroupName      
FROM    BillService LEFT OUTER JOIN      
                 BillGroup ON BillService.BillGroupid = BillGroup.BillGroupId where BillService.IsActive=1   and (ServiceName like '%'+@Search+'%')      
 
     
END
GO

ALTER PROCEDURE [dbo].[Sp_FillUsers] 
	-- Add the parameters for the stored procedure here
	@UserId int,
	@BranchId int,
	@FId int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	declare @Usertype1 nvarchar(50)
set @Usertype1 =( Select Usertype from CTuser where CUId=@UserId and branchid=@BranchId)
if(@Usertype1='Administrator' or @Usertype1='admin' or @Usertype1='Accounts Clerks'or @Usertype1='Accounts Manager'or @Usertype1='Audit'or @Usertype1='LAB MANAGER'or @Usertype1='Accountant'or @Usertype1='Head Cashier'or @Usertype1='Radiology Manager'or @Usertype1='Cashier'or @Usertype1='Radiology Staff')
begin

select '0' as CUId,'Select User' as username  from CTuser union
Select username as CUId,username from CTuser where Usertype <>'Administrator' and Usertype <>'admin'


end
else
begin 
select username as CUId,username from  CTuser where CUId=@UserId
end       
END
GO

CREATE PROCEDURE [dbo].[Sp_GenerateChargeNumber]                   
 -- Add the parameters for the stored procedure here                  
                   
 @PatRegId int,                  
                  
 @PatientInsuTypeId int ,
 @InsuCompanyId int ,
 @CoverageDetails nvarchar(4000)='',
 @CreatedBy nvarchar(250)
             
                   
                  
AS                  
BEGIN 
    declare @ChargeNumber nvarchar(50)=''
	declare @PatMainTypeId int=0
   if(not exists( select Patregid from ChargeBill_Master where Patregid=@PatRegId and InsuranceCompId= @PatientInsuTypeId and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)))            
   begin            
   declare @ChargeId int=0            
   declare @Code nvarchar(50)=0            
   select @ChargeId=isnull(max(ChargeId),0)+1 from ChargeBill_Master where InsuranceCompId= @PatientInsuTypeId and year(createdon)=year(getdate())    
    
   --and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)            
            
   select @Code=Code, @PatMainTypeId=PatMainTypeId from PatientInsuType where  PatientInsuTypeId= @PatientInsuTypeId            
            
       insert into ChargeBill_Master(ChargeId, ChargeNo,PatientMainType, InsuranceCompId, Patregid, BillAmt, InsuranceAmt, CreatedBy,  CancelBill,BillGroupName,BillNo,InsuCompanyId,CoverageDetails)            
   values(@ChargeId,cast(@Code as nvarchar(50))+'-'+cast( @ChargeId as nvarchar(50)) ,@PatMainTypeId,@PatientInsuTypeId,@PatRegId,0,0,@CreatedBy,0,'',0,@InsuCompanyId,@CoverageDetails)            
   end

   select 'Record Save successfully= '+ Convert(varchar(250), cast(@Code as nvarchar(50))+'-'+cast( @ChargeId as nvarchar(50))) 
   End
   --else            
   --begin            
   --update ChargeBill_Master set BillAmt=BillAmt+@BillAmount,InsuranceAmt=InsuranceAmt+@InsuranceAmount where Patregid=@PatRegId and InsuranceCompId= @PatientInsuTypeId        
   --and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2))  AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)      
   --end
GO

CREATE PROCEDURE [dbo].[Sp_GenerateCompanyInvoice_ForOPD]     
 -- Add the parameters for the stored procedure here    
 @FromDate varchar(50),    
 @ToDate varchar(50),    
 @InsuranceId int,    
 @FId int,    
 @BranchId int,    
 @flag nvarchar(20)    
AS    
BEGIN    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 -- interfering with SELECT statements.    
 SET NOCOUNT ON;    
    
    -- Insert statements for procedure here    
 if(@flag='Generate')    
 begin    
SELECT        GenerateCompanyInvoice_ForOPD.InvoiceId, GenerateCompanyInvoice_ForOPD.InvoiceNo, GenerateCompanyInvoice_ForOPD.BillAmount, GenerateCompanyInvoice_ForOPD.FromDate, 
                         GenerateCompanyInvoice_ForOPD.ToDate, GenerateCompanyInvoice_ForOPD.InsuranceCompId, GenerateCompanyInvoice_ForOPD.InvoiceDate, GenerateCompanyInvoice_ForOPD.FId, 
                         GenerateCompanyInvoice_ForOPD.BranchId, GenerateCompanyInvoice_ForOPD.CreatedBy, GenerateCompanyInvoice_ForOPD.CreatedOn, GenerateCompanyInvoice_ForOPD.UpdatedBy, 
                         GenerateCompanyInvoice_ForOPD.UpdatedOn, PatientInsuType.PatientInsuType
FROM            GenerateCompanyInvoice_ForOPD INNER JOIN
                         PatientInsuType ON GenerateCompanyInvoice_ForOPD.InsuranceCompId = PatientInsuType.PatientInsuTypeId where     
 CONVERT(date, FromDate)=CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) and     
 CONVERT(date, ToDate) = CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) and    
 InsuranceCompId=@InsuranceId and GenerateCompanyInvoice_ForOPD.FId=@FId and GenerateCompanyInvoice_ForOPD.BranchId=@BranchId    
 end    
 if(@flag='Search')    
 begin    
SELECT        GenerateCompanyInvoice_ForOPD.InvoiceId, GenerateCompanyInvoice_ForOPD.InvoiceNo, GenerateCompanyInvoice_ForOPD.BillAmount, GenerateCompanyInvoice_ForOPD.FromDate, 
                         GenerateCompanyInvoice_ForOPD.ToDate, GenerateCompanyInvoice_ForOPD.InsuranceCompId, GenerateCompanyInvoice_ForOPD.InvoiceDate, GenerateCompanyInvoice_ForOPD.FId, 
                         GenerateCompanyInvoice_ForOPD.BranchId, GenerateCompanyInvoice_ForOPD.CreatedBy, GenerateCompanyInvoice_ForOPD.CreatedOn, GenerateCompanyInvoice_ForOPD.UpdatedBy, 
                         GenerateCompanyInvoice_ForOPD.UpdatedOn, PatientInsuType.PatientInsuType
FROM            GenerateCompanyInvoice_ForOPD INNER JOIN
                         PatientInsuType ON GenerateCompanyInvoice_ForOPD.InsuranceCompId = PatientInsuType.PatientInsuTypeId where     
 CONVERT(date, FromDate)>=CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) and     
 CONVERT(date, ToDate) <= CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) and    
 InsuranceCompId=@InsuranceId and GenerateCompanyInvoice_ForOPD.FId=@FId and GenerateCompanyInvoice_ForOPD.BranchId=@BranchId    
    
     
 end    
    
    
END
GO

CREATE PROCEDURE [dbo].[SP_Get_ChildCompany_Description]
@Id int=0
as
select * from PatientInsu_SubType where Id=@Id
GO

ALTER PROCEDURE [dbo].[Sp_Get_EMR_LabPatients_IPD]
	@FromDate datetime =null,
    @ToDate datetime =null,
    @PaymentStatus nvarchar(50) =null,
	@PatRegId int=null,
    @MobileNo nvarchar(50) =null,
    @FId int=null,
    @BranchId int =null,
	@LabPtype varchar(5),
	@UserName nvarchar(50) =null,
	 @TestStatus nvarchar(50) =null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    Declare @sql varchar(4000)
   -- set @sql='select * from Vw_InvoiceList'
    set @sql='
SELECT DISTINCT 
ISNULL(Initial.Title, '''') + '' '' + PatientInformation.FirstName + '' '' + ISNULL(PatientInformation.MiddleName, '''') + '' '' + ISNULL(PatientInformation.LastName, '''') AS PatientName, 
LabEMRServiceDetails.TotalCharges AS BillServiceCharges,convert(varchar(20), LabEMRRegistration.Entrydate,103)+'' ''+convert(varchar(20),convert(time, LabEMRRegistration.Entrydate),100) as Entrydate, LabEMRServiceDetails.OPDNo, LabEMRServiceDetails.PatRegId, LabEMRServiceDetails.BillNo, 
HospEmpMst.Title + '' '' + HospEmpMst.Empname AS Empname, ISNULL(Gender.GenderName, '''') AS GenderName, LabEMRRegistration.PatientMainCategoryId, LabEMRRegistration.PatientSubCategoryId, 
PatMainType.PatMainType, PatientInsuType.PatientInsuType, PatientInformation.Age, PatientInformation.AgeType, PatientInformation.MobileNo, PatientInformation.BloodGroup, PatientInformation.BirthDate, 
LabEMRRegistration.FId, LabEMRRegistration.BranchId, LabEMRRegistration.DrId, LabEMRRegistration.LabNo, LabEMRRegistration.LabPtype, LabEMRRegistration.ReferBy, LabEMRRegistration.CreatedBy,
LabEMRRegistration.CancelBill,LabEMRRegistration.IPDNO, RoomType.RType, RoomMst.RoomName, BedMst.BedName,patstatus,LabEMRRegistration.ClinicalHistory
						FROM            LabEMRServiceDetails INNER JOIN
						LabEMRRegistration ON LabEMRServiceDetails.PatRegId = LabEMRRegistration.PatRegId AND LabEMRServiceDetails.LabNo = LabEMRRegistration.LabNo INNER JOIN
						AlloctnOfBed ON LabEMRRegistration.IPDNO = AlloctnOfBed.IpdNo INNER JOIN
						BedMst ON AlloctnOfBed.BedId = BedMst.BedId INNER JOIN
						RoomMst ON BedMst.RoomId = RoomMst.RoomId INNER JOIN
						RoomType ON RoomMst.RTypeId = RoomType.RTypeId LEFT OUTER JOIN
						HospEmpMst ON LabEMRServiceDetails.DrId = HospEmpMst.DrId LEFT OUTER JOIN
						PatientInformation ON LabEMRRegistration.PatRegId = PatientInformation.PatRegId LEFT OUTER JOIN
						PatientInsuType ON LabEMRRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN
						PatMainType ON LabEMRRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN
						Gender ON PatientInformation.GenderId = Gender.GenderId LEFT OUTER JOIN
						Initial ON PatientInformation.TitleId = Initial.TitleId where  patstatus=''Admitted'' and LabEMRRegistration.IPDNO>0 and  LabEMRRegistration.FId='''+ convert(varchar(10),@FId)+''' and LabEMRRegistration.BranchId='''+ convert(varchar(10),@BranchId)+''''
   
     if((@FromDate is not null) and  (@ToDate is not null))
    begin
    set @sql=@Sql +' and (CAST(CAST(YEAR(LabEMRRegistration.EntryDate) AS varchar(4)) + ''/'' + CAST(MONTH(LabEMRRegistration.EntryDate) AS varchar(2)) + ''/'' + CAST(DAY(LabEMRRegistration.EntryDate) AS varchar(2)) AS datetime)) between ''' + convert(varchar(10),cast(@FromDate as date))+ '''  and ''' + convert(varchar(10),cast(@ToDate as date)) + ''''
      --Exec(@sql + ' Order by InvoiceNo desc ')
    end
	if(@PatRegId<>0)
	begin
	 set @sql=@Sql +' and LabEMRRegistration.PatRegId = ''' +  convert(varchar(10),@PatRegId)  + '''' 
	end
     if(@MobileNo <>'')
    begin
    set @sql=@Sql +' and PatientInformation.MobileNo = ''' + @MobileNo + '''' 
    --Exec(@sql + ' Order by InvoiceNo desc ')
   end
	if(@LabPtype <> 'O')
	begin   
    set @sql=@Sql +' and LabEMRRegistration.LabPtype = ''' +  convert(varchar(10),@LabPtype)  + ''''    
    end
	 if(@TestStatus ='P')
    begin
    set @sql=@sql +' and LabEMRRegistration.CancelBill=0' 
   
    end
	 if(@TestStatus ='C')
    begin
    set @sql=@sql +' and LabEMRRegistration.CancelBill=1' 
   
    end
	 --if(@UserName <>'0')
  --  begin
  --  set @sql=@sql +' and LabEMRRegistration.CreatedBy = ''' + @UserName + '''' 
   
  --  end

	--if(@PaymentStatus = '1')
	--begin
   
 --   set @sql=@Sql +' and BalanceAmt >0'
    
 --   end
	--if(@PaymentStatus = '1')
	--begin
   
 --   set @sql=@Sql +' and BalanceAmt >0'
    
 --   end
	--if(@PaymentStatus = '0')
	--begin
   
 --   set @sql=@Sql +' and BalanceAmt =0'
    
 --   end
   
   print(@sql)
    Exec(@sql + ' Order by LabEMRRegistration.Labno desc ')
    
    
END
GO

ALTER PROCEDURE [dbo].[SP_GetAllPatientInfo]

@Patientregid nvarchar(250)=null,
@OpdNo int=0,
@IPdNo int=0,
@Branchid int=1

as
if(@OpdNo>0)
begin
SELECT DISTINCT 
                         Initial.Title, PatientInformation.PatientInfoId, PatientInformation.PatRegId, PatientInformation.BarcodeId, PatientInformation.TitleId, PatientInformation.FirstName, Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, 
                         PatientInformation.MiddleName, PatientInformation.LastName, PatientInformation.PatMainTypeId, PatientInformation.PatientInsuTypeId, PatientInformation.PolicyNo, PatientInformation.GenderId, PatientInformation.BirthDate, 
                         PatientInformation.IsConfirmBirthDate, PatientInformation.BloodGroup, PatientInformation.MaritalStatus, PatientInformation.GuardianTitleId, PatientInformation.GuardianName, PatientInformation.MobileNo, 
                         PatientInformation.PhoneNo, PatientInformation.PatientAddress, PatientInformation.CountryId, PatientInformation.StateId, PatientInformation.CityId, PatientInformation.Email, PatientInformation.EntryDate, 
                         PatientInformation.ImagePath, PatientInformation.CancelReason, PatientInformation.IsActive, PatientInformation.CreatedBy, PatientInformation.CreatedOn, PatientInformation.UpdatedBy, PatientInformation.UpdatedOn, 
                         PatientInformation.Age, PatientInformation.AgeType, OpdRegistration.OpdNo, Gender.GenderName, HospEmpMst.Title + ' ' + HospEmpMst.Empname AS DrName, OpdRegistration.TokenNo, OpdRegistration.VisitingNo, 
                         DepartmentMst.DeptName, OpdRegistration.DrId, 0 AS IpdNo, OpdRegistration.VaccinationStatus
FROM            PatientInformation INNER JOIN
                         OpdRegistration ON PatientInformation.PatRegId = OpdRegistration.PatRegId LEFT OUTER JOIN
                         DepartmentMst ON OpdRegistration.DeptId = DepartmentMst.DeptId LEFT OUTER JOIN
                         Initial ON PatientInformation.TitleId = Initial.TitleId LEFT OUTER JOIN
                         Gender ON PatientInformation.GenderId = Gender.GenderId LEFT OUTER JOIN
                         HospEmpMst ON OpdRegistration.DrId = HospEmpMst.DrId where PatientInformation.PatRegId=@Patientregid and OpdRegistration.OpdNo=@OpdNo

				 end 
				 else
				 begin
				 SELECT DISTINCT  Initial.Title,
                 PatientInformation.PatientInfoId, PatientInformation.PatRegId, PatientInformation.BarcodeId, PatientInformation.TitleId, PatientInformation.FirstName,
                 Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, PatientInformation.MiddleName, PatientInformation.LastName, 
                 PatientInformation.PatMainTypeId, PatientInformation.PatientInsuTypeId, PatientInformation.PolicyNo, PatientInformation.GenderId, 
                 PatientInformation.BirthDate, PatientInformation.IsConfirmBirthDate, PatientInformation.BloodGroup, PatientInformation.MaritalStatus, 
                 PatientInformation.GuardianTitleId, PatientInformation.GuardianName, PatientInformation.MobileNo, PatientInformation.PhoneNo, 
                 PatientInformation.PatientAddress, PatientInformation.CountryId, PatientInformation.StateId, PatientInformation.CityId, PatientInformation.Email, 
                 PatientInformation.EntryDate, PatientInformation.ImagePath, PatientInformation.CancelReason, PatientInformation.IsActive, PatientInformation.CreatedBy, 
                 PatientInformation.CreatedOn, PatientInformation.UpdatedBy, PatientInformation.UpdatedOn, PatientInformation.Age, PatientInformation.AgeType, 
                 0 as OpdNo, Gender.GenderName, HospEmpMst.Title + ' ' + HospEmpMst.Empname AS DrName, 0 as TokenNo, 
                 IpdRegistration.VisitingNo, DepartmentMst.DeptName,IpdRegistration.PrimaryDoc as DrId,IpdRegistration.IpdNo,'' as VaccinationStatus
FROM    PatientInformation INNER JOIN
                 IpdRegistration ON PatientInformation.PatRegId = IpdRegistration.PatRegId LEFT OUTER JOIN
              DepartmentMst ON IpdRegistration.DeptId = DepartmentMst.DeptId LEFT OUTER JOIN
                 Initial ON PatientInformation.TitleId = Initial.TitleId LEFT OUTER JOIN
                 Gender ON PatientInformation.GenderId = Gender.GenderId LEFT OUTER JOIN
                 HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId
				 where PatientInformation.PatRegId=@Patientregid and IpdRegistration.IpdNo=@IPdNo
				end
GO

CREATE PROCEDURE [dbo].[SP_GetAllPatientInformation]  
  
@Patientregid nvarchar(250)=null
  
as  

SELECT DISTINCT 
                         Initial.Title, PatientInformation.PatientInfoId, PatientInformation.PatRegId, PatientInformation.BarcodeId, PatientInformation.TitleId, PatientInformation.FirstName, Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, 
                         PatientInformation.MiddleName, PatientInformation.LastName, PatientInformation.PatMainTypeId, PatientInformation.PatientInsuTypeId, PatientInformation.PolicyNo, PatientInformation.GenderId, PatientInformation.BirthDate, 
                         PatientInformation.IsConfirmBirthDate, PatientInformation.BloodGroup, PatientInformation.MaritalStatus, PatientInformation.GuardianTitleId, PatientInformation.GuardianName, PatientInformation.MobileNo, 
                         PatientInformation.PhoneNo, PatientInformation.PatientAddress, PatientInformation.CountryId, PatientInformation.StateId, PatientInformation.CityId, PatientInformation.Email, PatientInformation.EntryDate, 
                         PatientInformation.ImagePath, PatientInformation.CancelReason, PatientInformation.IsActive, PatientInformation.CreatedBy, PatientInformation.CreatedOn, PatientInformation.UpdatedBy, PatientInformation.UpdatedOn, 
                         PatientInformation.Age, PatientInformation.AgeType, Gender.GenderName, 0 AS IpdNo
FROM            PatientInformation LEFT OUTER JOIN
                         Initial ON PatientInformation.TitleId = Initial.TitleId LEFT OUTER JOIN
                         Gender ON PatientInformation.GenderId = Gender.GenderId where PatientInformation.PatRegId=@Patientregid
GO

CREATE PROCEDURE [dbo].[Sp_GetAllPatientInsu_SubType]
AS

BEGIN

SELECT        PatientInsuType.PatientInsuType, PatMainType.PatMainType, PatientInsuType.PatientInsuTypeId, PatientInsuType.PatMainTypeId, PatientInsu_SubType.ChildCompanyName, PatientInsu_SubType.ContactNumber, 
PatientInsu_SubType.CompanyDescription, PatientInsu_SubType.CreatedBy, PatientInsu_SubType.CreatedOn,PatientInsu_SubType.Id
     FROM            PatientInsuType INNER JOIN
PatMainType ON PatientInsuType.PatMainTypeId = PatMainType.PatMainTypeId INNER JOIN
PatientInsu_SubType ON PatientInsuType.PatientInsuTypeId = PatientInsu_SubType.PatientInsuTypeId AND 
PatientInsuType.PatMainTypeId = PatientInsu_SubType.PatientMainType
END
GO

CREATE PROCEDURE [dbo].[Sp_GetAllPatientInsu_SubType_Search_ChildComp]  

@InsuranceChildName nvarchar(50)=''
AS  
  
BEGIN  
  
SELECT        PatientInsuType.PatientInsuType, PatMainType.PatMainType, PatientInsuType.PatientInsuTypeId, PatientInsuType.PatMainTypeId, PatientInsu_SubType.ChildCompanyName, PatientInsu_SubType.ContactNumber,   
PatientInsu_SubType.CompanyDescription, PatientInsu_SubType.CreatedBy, PatientInsu_SubType.CreatedOn,PatientInsu_SubType.Id  
     FROM            PatientInsuType INNER JOIN  
PatMainType ON PatientInsuType.PatMainTypeId = PatMainType.PatMainTypeId INNER JOIN  
PatientInsu_SubType ON PatientInsuType.PatientInsuTypeId = PatientInsu_SubType.PatientInsuTypeId AND   
PatientInsuType.PatMainTypeId = PatientInsu_SubType.PatientMainType  where PatientInsu_SubType.ChildCompanyName LIKE '%' + @InsuranceChildName + '%'
END
GO

CREATE PROCEDURE [dbo].[Sp_GetAllPatientInsu_SubType_Search_InsuranceComp]  

@PatientInsuTypeId int=0
AS  
  
BEGIN  
  
SELECT        PatientInsuType.PatientInsuType, PatMainType.PatMainType, PatientInsuType.PatientInsuTypeId, PatientInsuType.PatMainTypeId, PatientInsu_SubType.ChildCompanyName, PatientInsu_SubType.ContactNumber,   
PatientInsu_SubType.CompanyDescription, PatientInsu_SubType.CreatedBy, PatientInsu_SubType.CreatedOn,PatientInsu_SubType.Id  
     FROM            PatientInsuType INNER JOIN  
PatMainType ON PatientInsuType.PatMainTypeId = PatMainType.PatMainTypeId INNER JOIN  
PatientInsu_SubType ON PatientInsuType.PatientInsuTypeId = PatientInsu_SubType.PatientInsuTypeId AND   
PatientInsuType.PatMainTypeId = PatientInsu_SubType.PatientMainType  where PatientInsuType.PatientInsuTypeId=@PatientInsuTypeId
END
GO

CREATE PROCEDURE [dbo].[Sp_GetAllPatientInsuType]
AS

BEGIN

SELECT * FROM PatientInsuType where PatMainTypeId<>1

END
GO

CREATE PROCEDURE [dbo].[Sp_GetAllPatientInsuType_withCategory]

@PatMainTypeId int=0
as
BEGIN

SELECT * FROM PatientInsuType where PatMainTypeId<>1 and PatMainTypeId=@PatMainTypeId

END
GO

CREATE PROCEDURE [dbo].[SP_GetAllRadiology_Charges]

@Patientregid nvarchar(250)=null,
@LabNo int=0,

@Branchid int=1

as

                      SELECT        BillPaymentId, BillNo, ReceiptNo, PatRegId, PaymentDate, ReceivedAmount, DiscountAmt, BalanceAmt, OpdNo, IpdNo, IsOpd, IsIpd, BillType, FId, BranchId, PaymentMode, ChequeNo, ChequeDate, BankName, CreatedBy, 
                         CreatedOn, UpdatedBy, UpdatedOn, ReasonForDisc, ReasonForBalance, DiscGivenBy, InsuranceCompId, InsuranceAmount, IsInsurance, DrId, Remark, IsDischarge, IsClose, IsDeposit, CancelAdmission, LabNo, BillAmount, 
                         PaymentReceivedBy, PaymentReceivedon, RadioPayReceive
FROM            LabBillPaymentTrns
WHERE        (LabBillPaymentTrns.LabNo = @LabNo) and LabBillPaymentTrns.PatRegId=@Patientregid
GO

CREATE PROCEDURE [dbo].[SP_GetAllRadiology_Test]

@Patientregid nvarchar(250)=null,
@LabNo int=0,

@Branchid int=1

as
SELECT DISTINCT 
                         LabServiceDetails.BillServiceCharges, LabRegistration.Entrydate, LabServiceDetails.OPDNo, LabServiceDetails.PatRegId, LabServiceDetails.BillNo, LabRegistration.PatientMainCategoryId, 
                         LabRegistration.PatientSubCategoryId, LabRegistration.FId, LabRegistration.BranchId, LabRegistration.DrId, LabRegistration.LabNo, LabRegistration.LabPtype, LabRegistration.ReferBy, 
                         LabRegistration.CreatedBy, LabRegistration.CancelBill, LabServiceDetails.MTCode, LabServiceDetails.ServiceName, LabRegistration.IPDNO, LabRegistration.ClinicalHistory
FROM            LabServiceDetails INNER JOIN
                         LabRegistration ON LabServiceDetails.PatRegId = LabRegistration.PatRegId AND LabServiceDetails.LabNo = LabRegistration.LabNo
WHERE        (LabRegistration.LabNo = @LabNo) and LabRegistration.PatRegId=@Patientregid
GO

ALTER PROCEDURE [dbo].[SP_GetAttendentdata]
as
select  * from  LabEMRRegistration where ipdno>0 and Isemergency=1 and IsPatientChecked=0 and LabpType='R'
GO

CREATE PROCEDURE [dbo].[SP_GetChargeNumber]      
@Patregid int      
as    
SELECT        ProcedureBillMaster.ProcedureId, ProcedureBillMaster.PatRegId, ProcedureBillMaster.PatientSubType, ProcedureBillMaster.BillAmount, ProcedureBillMaster.AmountPaid, ProcedureBillMaster.Discount, 
ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.BillGroup, ProcedureBillMaster.BillNo, ProcedureBillMaster.FId, ProcedureBillMaster.BranchId, ProcedureBillMaster.CreatedBy, ProcedureBillMaster.CreatedOn, 
ProcedureBillMaster.UpdatedBy, ProcedureBillMaster.UpdatedOn, ProcedureBillMaster.CancelBill, ProcedureBillMaster.DiscountGivenById, ProcedureBillMaster.ReasonForBalanceId, 
ProcedureBillMaster.ReasonForDiscountId, ProcedureBillMaster.CancelBy, ProcedureBillMaster.CancelOn, ProcedureBillMaster.Details, ProcedureBillMaster.ProcedureNo, ProcedureBillMaster.OPDNo, 
ProcedureBillMaster.BillGroupId, ProcedureBillMaster.InsuranceChargeCompamt, ProcedureBillMaster.LetterNo, ProcedureBillMaster.TypeOfVisit, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.PatientMainType, 
ChargeBill_Master.ChargeNo, PatientInsuType.PatientInsuType, CAST(ChargeBill_Master.InsuranceCompId AS nvarchar(50)) + ' - ' + PatientInsuType.PatientInsuType AS InsuranceCompanyName
FROM            PatientInsuType INNER JOIN
ChargeBill_Master ON PatientInsuType.PatientInsuTypeId = ChargeBill_Master.InsuranceCompId LEFT OUTER JOIN
ProcedureBillMaster ON ChargeBill_Master.Patregid = ProcedureBillMaster.PatRegId
 where ChargeBill_Master.Patregid=@Patregid and CAST(CAST(YEAR(ChargeBill_Master.Createdon) AS varchar(4)) + '/' + CAST(MONTH(ChargeBill_Master.Createdon) AS varchar(2)) + '/' + CAST(DAY(ChargeBill_Master.Createdon) AS varchar(2))  AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)  
ORDER BY ChargeBill_Master.ID DESC
GO

CREATE PROCEDURE [dbo].[SP_GetChargeNumber_ForLAb]        
@Patregid int        
as      
SELECT        ChargeBill_Master.InsuranceCompId, ChargeBill_Master.PatientMainType, ChargeBill_Master.ChargeNo, PatientInsuType.PatientInsuType, CAST(ChargeBill_Master.InsuranceCompId AS nvarchar(50))   
                         + ' - ' + PatientInsuType.PatientInsuType AS InsuranceCompanyName, ChargeBill_Master.ID  ,'' as LetterNo
FROM            PatientInsuType INNER JOIN  
                         ChargeBill_Master ON PatientInsuType.PatientInsuTypeId = ChargeBill_Master.InsuranceCompId  
 where ChargeBill_Master.Patregid=@Patregid and CAST(CAST(YEAR(ChargeBill_Master.Createdon) AS varchar(4)) + '/' + CAST(MONTH(ChargeBill_Master.Createdon) AS varchar(2)) + '/' + CAST(DAY(ChargeBill_Master.Createdon) AS varchar(2))  AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)    
ORDER BY ChargeBill_Master.ID DESC
GO

CREATE PROCEDURE [dbo].[SP_GetChargePAtientDetails]
@InvoiceNo int

as
SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt, 
                         ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, ChargeBill_Master.BillGroupName, ChargeBill_Master.BillNo, 
                         ChargeBill_Master.PatientMainType, PatientInsuType.PatientInsuType, PatientInformation.FirstName, PatientInformation.MiddleName, PatientInformation.LastName, PatientInformation.MobileNo, PatientInformation.PhoneNo, 
                         PatientInformation.PatientAddress, PatientInformation.Age, PatientInformation.AgeType, PatientInformation.BirthDate, Gender.GenderName
FROM            ChargeBill_Master INNER JOIN
                         PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN
                         PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId INNER JOIN
                         Gender ON PatientInformation.GenderId = Gender.GenderId where ChargeBill_Master.ID=@InvoiceNo
GO

ALTER PROCEDURE [dbo].[Sp_GetDr_Name]  
 @ServiceId int=0,  
 @BranchId int =0,  
 @RateTypeId int=0,  
 @PatientType int =0  
  
AS  
BEGIN  

if exists(select ServiceId from BillSeviceCharges where ServiceId=@ServiceId and IsDocWise=1 and BranchId=@BranchId and RateTypeId=@RateTypeId and PatientType=@PatientType)  
 begin  
   SELECT HospEmpMst.Empname, HospEmpMst.DrId, ISNULL(BillSeviceCharges.rate, 0) AS rate, ISNULL(BillSeviceCharges.DrCompamt, 0) AS DrCompamt,   
            ISNULL(BillSeviceCharges.DrCompPer, 0) AS DrCompPer, BillSeviceCharges.ServiceId, BillSeviceCharges.BranchId, BillSeviceCharges.FId,   
            BillSeviceCharges.PatientType, HospEmpMst.EmployeeType, BillSeviceCharges.RateTypeId,   
            BillSeviceCharges.CreatedBy, BillSeviceCharges.CreatedOn, BillSeviceCharges.UpdatedBy, BillSeviceCharges.UpdatedOn, BillService.ServiceName  
            FROM  BillService RIGHT OUTER JOIN BillSeviceCharges ON BillService.BillServiceId = BillSeviceCharges.ServiceId RIGHT OUTER JOIN  
            HospEmpMst ON BillSeviceCharges.DrId = HospEmpMst.DrId  
            WHERE (HospEmpMst.EmployeeType = 'Consultant') and ServiceId=@ServiceId --AND (BillSeviceCharges.ServiceId = @ServiceId) and (BillSeviceCharges.BranchId=@BranchId) and (BillSeviceCharges.RateTypeId=@RateTypeId) and (BillSeviceCharges.PatientType=@PatientType)  
 end  
 else  
 begin  
  
 SELECT Empname, DrId, EmployeeType,0 as rate,0 as DrCompPer,0 as DrCompamt  
FROM    HospEmpMst  
WHERE (EmployeeType = 'Consultant') AND (BranchId = @BranchId)  
  
 end  
END
GO

CREATE PROCEDURE [dbo].[Sp_GetInsuranceReceiptNo_ForOPD]  
 -- Add the parameters for the stored procedure here  
 @Sponser int,  
 @FId int,  
 @BranchId int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
Select distinct ReceiptNo From InsuranceCompPaymentTransactions_ForOPD where TransactionType='Credit' and Sponser=@Sponser  
  
END
GO

CREATE PROCEDURE [dbo].[Sp_GetInsuranceTransaction_ForOPD]   
 -- Add the parameters for the stored procedure here  
 @Sponser int,  
 @FId int,  
 @BranchId int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  
    select IsNull(Sum(DebitAmount),0) as InsuranceBillAmount,IsNull(Sum(CreditAmount),0) as AmountPaid ,  
 IsNull(Sum(DebitAmount),0)- IsNull(Sum(CreditAmount),0) as Balance from InsuranceCompPaymentTransactions_ForOPD  
 where Sponser=@Sponser and FId=@FId and BranchId=@BranchId  
END
GO

CREATE PROCEDURE [dbo].[Sp_GetInsuranceTransaction_ForOPD_PaymentAccept]     
 -- Add the parameters for the stored procedure here    
 @InsuranceCompId int   
AS    
BEGIN 

SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt, 
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, ChargeBill_Master.BillGroupName, ChargeBill_Master.BillNo, 
ChargeBill_Master.PatientMainType, ChargeBill_Master.InsuCompanyId, ChargeBill_Master.CoverageDetails, ChargeBill_Master.Discount, ChargeBill_Master.DiscountAmt, ChargeBill_Master.ActualInsuAmt, 
ChargeBill_Master.DiscountGivenBy, ChargeBill_Master.DiscountGivenOn, ChargeBill_Master.DiscountRemark, PatientInsuType.PatientInsuType, PatientInformation.FirstName, Gender.GenderName, 
PatientInformation.BirthDate, PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress, PatientInformation.Email, PatientInformation.Age, PatientInformation.AgeType, 
PatientInformation.Nationality, PatientInformation.HealthCardNo, PatientInformation.ChiefComplant, PatientInformation.PassportNo, PatientInsu_SubType.ChildCompanyName,PaymentReceive
FROM            ChargeBill_Master INNER JOIN
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN
PatientInsu_SubType ON ChargeBill_Master.InsuCompanyId = PatientInsu_SubType.ID LEFT OUTER JOIN
Gender ON PatientInformation.GenderId = Gender.GenderId
where PaymentReceive=0 and ChargeBill_Master.InsuranceCompId=@InsuranceCompId order by  ChargeBill_Master.ID desc
end
GO

ALTER PROCEDURE [dbo].[Sp_GetLabBillingReport]     
 -- Add the parameters for the stored procedure here    
 @BillNo int,    
 @ReceiptNo int,    
 @OpdNo int,    
 @PatRegId int,    
 @FId int,    
 @BranchId int    
AS    
BEGIN    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 -- interfering with SELECT statements.    
 SET NOCOUNT ON;    
  Declare @sql varchar(4000)    
 --  Declare @BillNo int=115666,    
 --@ReceiptNo int=201165,    
 --@OpdNo int=224620,    
 --@PatRegId int=20387,    
 --@FId int=1,    
 --@BranchId int=1    
 --Select * from Vw_OpdBillReport where BillNo=@BillNo and ReceiptNo=@ReceiptNo and OpdNo=@OpdNo and PatRegId=@PatRegId and FId=@FId and BranchId=@BranchId    
--    SELECT        Vw_LabBillServiceDetails.BillNo, LabBillPaymentTrns.ReceiptNo, Vw_LabBillServiceDetails.FirstName AS PatientName, Vw_LabBillServiceDetails.PatRegId, Vw_LabBillServiceDetails.LabNo,     
--                         Vw_LabBillServiceDetails.ServiceName, LabBillPaymentTrns.ReceivedAmount, LabBillPaymentTrns.DiscountAmt, LabBillPaymentTrns.BalanceAmt, LabBillPaymentTrns.BankName, LabBillPaymentTrns.ChequeDate,     
--                         LabBillPaymentTrns.ChequeNo, LabBillPaymentTrns.PaymentMode, Vw_LabBillServiceDetails.BillServiceCharges, LabBillPaymentTrns.PaymentDate, Vw_LabBillServiceDetails.Entrydate,     
--                         Vw_LabBillServiceDetails.RegistrationType, Vw_LabBillServiceDetails.ReferenceDoc, LabBillPaymentTrns.CreatedBy, Vw_LabBillServiceDetails.PatientComplaints, Vw_LabBillServiceDetails.Empname,     
--                         Vw_LabBillServiceDetails.DrId, LabBillPaymentTrns.DiscGivenBy, LabBillPaymentTrns.ReasonForBalance, LabBillPaymentTrns.ReasonForDisc, LabBillPaymentTrns.UpdatedOn, HospEmpMst.Empname AS DiscountGivenBy,     
--                         DiscountTypeMst.DiscType, ReasonForBalance.ReasonForBalanceName, LabBillPaymentTrns.BranchId, LabBillPaymentTrns.FId, ModeOfPayment.ModeOfPaymentName, Vw_LabBillServiceDetails.Qty,     
--                         Vw_LabBillServiceDetails.SingleBillServiceCharges, LabBillPaymentTrns.InsuranceCompId, LabBillPaymentTrns.InsuranceAmount, LabBillPaymentTrns.IsInsurance    
--FROM            Vw_LabBillServiceDetails INNER JOIN    
--                         LabBillPaymentTrns ON Vw_LabBillServiceDetails.BillNo = LabBillPaymentTrns.BillNo AND Vw_LabBillServiceDetails.LabNo = LabBillPaymentTrns.LabNo AND     
--                         Vw_LabBillServiceDetails.ReceiptNo = LabBillPaymentTrns.ReceiptNo INNER JOIN    
--                         ModeOfPayment ON LabBillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId LEFT OUTER JOIN    
--                         HospEmpMst ON LabBillPaymentTrns.DiscGivenBy = HospEmpMst.DrId LEFT OUTER JOIN    
--                         DiscountTypeMst ON LabBillPaymentTrns.ReasonForDisc = DiscountTypeMst.DiscTypeId LEFT OUTER JOIN    
--                         ReasonForBalance ON LabBillPaymentTrns.ReasonForBalance = ReasonForBalance.ReasonForBalanceId    
  set @sql =   'alter VIEW [dbo].[Vw_LabBillReport] AS (SELECT        Vw_LabBillServiceDetails.BillNo, LabBillPaymentTrns.ReceiptNo, Vw_LabBillServiceDetails.FirstName AS PatientName, Vw_LabBillServiceDetails.PatRegId, Vw_LabBillServiceDetails.LabNo,   
                         Vw_LabBillServiceDetails.ServiceName, LabBillPaymentTrns.ReceivedAmount, LabBillPaymentTrns.DiscountAmt, LabBillPaymentTrns.BalanceAmt, LabBillPaymentTrns.BankName, LabBillPaymentTrns.ChequeDate,   
                         LabBillPaymentTrns.ChequeNo, LabBillPaymentTrns.PaymentMode, Vw_LabBillServiceDetails.BillServiceCharges, LabBillPaymentTrns.PaymentDate, Vw_LabBillServiceDetails.Entrydate,   
                         Vw_LabBillServiceDetails.RegistrationType, Vw_LabBillServiceDetails.ReferenceDoc, LabBillPaymentTrns.PaymentReceivedBy AS CreatedBy, Vw_LabBillServiceDetails.PatientComplaints, Vw_LabBillServiceDetails.Empname,   
                         Vw_LabBillServiceDetails.DrId, LabBillPaymentTrns.DiscGivenBy, LabBillPaymentTrns.ReasonForBalance, LabBillPaymentTrns.ReasonForDisc, LabBillPaymentTrns.UpdatedOn, HospEmpMst.Empname AS DiscountGivenBy,   
                         DiscountTypeMst.DiscType, ReasonForBalance.ReasonForBalanceName, LabBillPaymentTrns.BranchId, LabBillPaymentTrns.FId, ModeOfPayment.ModeOfPaymentName, Vw_LabBillServiceDetails.Qty,   
                         Vw_LabBillServiceDetails.SingleBillServiceCharges, LabBillPaymentTrns.InsuranceCompId, LabBillPaymentTrns.InsuranceAmount, LabBillPaymentTrns.IsInsurance, Vw_LabBillServiceDetails.GenderName,   
                         Vw_LabBillServiceDetails.PatientAddress, Vw_LabBillServiceDetails.MobileNo, Vw_LabBillServiceDetails.PatMainType, Vw_LabBillServiceDetails.ReferBy, Vw_LabBillServiceDetails.LabPtype,   
                         Vw_LabBillServiceDetails.AgeType, Vw_LabBillServiceDetails.Age, Vw_LabBillServiceDetails.PatientMainCategoryId, Vw_LabBillServiceDetails.PatientSubCategoryId, PatientInsuType.PatientInsuType,   
                         CAST(Vw_LabBillServiceDetails.QRImage AS VARBINARY(8000)) AS QRImage, Vw_LabBillServiceDetails.LetterNo, Vw_LabBillServiceDetails.InsuranceChargeCompany, Vw_LabBillServiceDetails.AfterHrs ,LabBillPaymentTrns.ChargeNumber 
FROM            Vw_LabBillServiceDetails INNER JOIN  
                         LabBillPaymentTrns ON Vw_LabBillServiceDetails.BillNo = LabBillPaymentTrns.BillNo AND Vw_LabBillServiceDetails.LabNo = LabBillPaymentTrns.LabNo AND   
                         Vw_LabBillServiceDetails.ReceiptNo = LabBillPaymentTrns.ReceiptNo INNER JOIN  
                         ModeOfPayment ON LabBillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId INNER JOIN  
                         PatientInsuType ON Vw_LabBillServiceDetails.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId INNER JOIN  
                         PatMainType ON Vw_LabBillServiceDetails.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN  
                         HospEmpMst ON LabBillPaymentTrns.DiscGivenBy = HospEmpMst.DrId LEFT OUTER JOIN  
                         DiscountTypeMst ON LabBillPaymentTrns.ReasonForDisc = DiscountTypeMst.DiscTypeId LEFT OUTER JOIN  
                         ReasonForBalance ON LabBillPaymentTrns.ReasonForBalance = ReasonForBalance.ReasonForBalanceId  
    
                 where Vw_LabBillServiceDetails.BillNo='''+Convert(varchar(100),@BillNo) + ''' and dbo.LabBillPaymentTrns.ReceiptNo= ''' + Convert(varchar(10),@ReceiptNo) + ''' and     
     Vw_LabBillServiceDetails.Labno=''' + Convert(varchar(10),@OpdNo) + ''' and dbo.Vw_LabBillServiceDetails.PatRegId='''+ Convert(varchar(10),@PatRegId) + ''' and dbo.LabBillPaymentTrns.FId=''' + Convert(varchar(10),@FId) + ''' and dbo.LabBillPaymentTrns.BranchId='''+ convert(varchar(10),@BranchId)+''')'    
            
  print(@sql)    
  Exec(@sql)    
  select * from Vw_OpdBillReport    
END
GO

ALTER PROCEDURE [dbo].[Sp_GetLabBillingReportALL]   
 -- Add the parameters for the stored procedure here  
 @BillNo int,   
 @OpdNo int,  
 @PatRegId int,  
 @FId int,  
 @BranchId int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  Declare @sql varchar(4000)  

  set @sql =   'alter VIEW [dbo].[Vw_LabBillReport] AS (SELECT  
                         Vw_LabBillServiceDetails.BillNo, LabBillPaymentTrns.ReceiptNo, Vw_LabBillServiceDetails.FirstName AS PatientName, Vw_LabBillServiceDetails.PatRegId, Vw_LabBillServiceDetails.LabNo, 
                         Vw_LabBillServiceDetails.ServiceName, LabBillPaymentTrns.ReceivedAmount, LabBillPaymentTrns.DiscountAmt, LabBillPaymentTrns.BalanceAmt, LabBillPaymentTrns.BankName, LabBillPaymentTrns.ChequeDate, 
                         LabBillPaymentTrns.ChequeNo, LabBillPaymentTrns.PaymentMode, Vw_LabBillServiceDetails.BillServiceCharges, LabBillPaymentTrns.PaymentDate, Vw_LabBillServiceDetails.Entrydate, 
                         Vw_LabBillServiceDetails.RegistrationType, Vw_LabBillServiceDetails.ReferenceDoc, LabBillPaymentTrns.CreatedBy, Vw_LabBillServiceDetails.PatientComplaints, Vw_LabBillServiceDetails.Empname, 
                         Vw_LabBillServiceDetails.DrId, LabBillPaymentTrns.DiscGivenBy, LabBillPaymentTrns.ReasonForBalance, LabBillPaymentTrns.ReasonForDisc, LabBillPaymentTrns.UpdatedOn, HospEmpMst.Empname AS DiscountGivenBy, 
                         DiscountTypeMst.DiscType, ReasonForBalance.ReasonForBalanceName, LabBillPaymentTrns.BranchId, LabBillPaymentTrns.FId, ModeOfPayment.ModeOfPaymentName, Vw_LabBillServiceDetails.Qty, 
                         Vw_LabBillServiceDetails.SingleBillServiceCharges, LabBillPaymentTrns.InsuranceCompId, LabBillPaymentTrns.InsuranceAmount, LabBillPaymentTrns.IsInsurance, Vw_LabBillServiceDetails.GenderName, 
                         Vw_LabBillServiceDetails.PatientAddress, Vw_LabBillServiceDetails.MobileNo, Vw_LabBillServiceDetails.PatMainType, Vw_LabBillServiceDetails.ReferBy, Vw_LabBillServiceDetails.LabPtype, 
                         Vw_LabBillServiceDetails.AgeType, Vw_LabBillServiceDetails.Age, Vw_LabBillServiceDetails.PatientMainCategoryId, Vw_LabBillServiceDetails.PatientSubCategoryId, PatientInsuType.PatientInsuType, 
                         CAST(Vw_LabBillServiceDetails.QRImage AS VARBINARY(8000)) AS QRImage, Vw_LabBillServiceDetails.QRImage AS Expr1, Vw_LabBillServiceDetails.LetterNo, Vw_LabBillServiceDetails.InsuranceChargeCompany, 
                         Vw_LabBillServiceDetails.AfterHrs,LabBillPaymentTrns.ChargeNumber 
FROM            Vw_LabBillServiceDetails INNER JOIN
                         LabBillPaymentTrns ON Vw_LabBillServiceDetails.BillNo = LabBillPaymentTrns.BillNo AND Vw_LabBillServiceDetails.LabNo = LabBillPaymentTrns.LabNo AND 
                         Vw_LabBillServiceDetails.ReceiptNo = LabBillPaymentTrns.ReceiptNo INNER JOIN
                         ModeOfPayment ON LabBillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId INNER JOIN
                         PatientInsuType ON Vw_LabBillServiceDetails.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId INNER JOIN
                         PatMainType ON Vw_LabBillServiceDetails.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN
                         HospEmpMst ON LabBillPaymentTrns.DiscGivenBy = HospEmpMst.DrId LEFT OUTER JOIN
                         DiscountTypeMst ON LabBillPaymentTrns.ReasonForDisc = DiscountTypeMst.DiscTypeId LEFT OUTER JOIN
                         ReasonForBalance ON LabBillPaymentTrns.ReasonForBalance = ReasonForBalance.ReasonForBalanceId
  
                 where Vw_LabBillServiceDetails.BillNo='''+Convert(varchar(100),@BillNo) + '''  and   
     Vw_LabBillServiceDetails.Labno=''' + Convert(varchar(10),@OpdNo) + ''' and dbo.Vw_LabBillServiceDetails.PatRegId='''+ Convert(varchar(10),@PatRegId) + ''' and dbo.LabBillPaymentTrns.FId=''' + Convert(varchar(10),@FId) + ''' and dbo.LabBillPaymentTrns.BranchId='''+ convert(varchar(10),@BranchId)+''')'  
          
  print(@sql)  
  Exec(@sql)  
  select * from Vw_LabBillReport  
END
GO

CREATE PROCEDURE [dbo].[SP_GetLastVisitDate]  
@Patregid int  
as  
SELECT  top(1)      ProcedureServiceDetails.ProcedureServiceId, ProcedureServiceDetails.PatRegId, ProcedureServiceDetails.BillServiceId, ProcedureServiceDetails.BillServiceCharges, ProcedureServiceDetails.Qty,   
ProcedureServiceDetails.TotalCharges, ProcedureServiceDetails.DrId, ProcedureServiceDetails.FId, ProcedureServiceDetails.BillNo, ProcedureServiceDetails.BranchId, ProcedureServiceDetails.CreatedBy,   
ProcedureServiceDetails.CreatedOn, ProcedureServiceDetails.UpdatedBy, ProcedureServiceDetails.UpdatedOn, ProcedureServiceDetails.DeptId, ProcedureServiceDetails.Description, ProcedureServiceDetails.BillGroup,   
ProcedureServiceDetails.CancelBill, ProcedureServiceDetails.ProcedureId, 'Dr '+HospEmpMst.Empname as DrName  ,
convert(varchar(20),ProcedureServiceDetails.CreatedOn,103)+' '+convert(varchar(20),convert(time,ProcedureServiceDetails.CreatedOn),100) as RegistratonDateTime,

 case when (CAST(CAST(YEAR(ProcedureServiceDetails.CreatedOn+6) AS varchar(4)) + '/' + CAST(MONTH(ProcedureServiceDetails.CreatedOn+6) AS varchar(2)) + '/' + CAST(DAY(ProcedureServiceDetails.CreatedOn+6) AS varchar(2)) AS datetime))
 >(CAST(CAST(YEAR(GetDate()) AS varchar(4)) + '/' + CAST(MONTH(GetDate()) AS varchar(2)) + '/' + CAST(DAY(GetDate()) AS varchar(2)) AS datetime)) then'Follow Up' else 'Consultation' end as ConsultType
FROM            ProcedureServiceDetails INNER JOIN  
HospEmpMst ON ProcedureServiceDetails.DrId = HospEmpMst.DrId where BillGroup='Consultation' 
and PatRegId=@Patregid order by 1 desc
GO

CREATE PROCEDURE [dbo].[SP_GetPreviousHistory]
@PatRegId int=0
as

SELECT        ProcedureServiceDetails.ProcedureServiceId, ProcedureServiceDetails.PatRegId, ProcedureServiceDetails.BillServiceId, ProcedureServiceDetails.BillServiceCharges, ProcedureServiceDetails.Qty, 
ProcedureServiceDetails.TotalCharges, ProcedureServiceDetails.DrId, ProcedureServiceDetails.FId, ProcedureServiceDetails.BillNo, ProcedureServiceDetails.BranchId, ProcedureServiceDetails.CreatedBy, 
ProcedureServiceDetails.CreatedOn, ProcedureServiceDetails.UpdatedBy, ProcedureServiceDetails.UpdatedOn, ProcedureServiceDetails.DeptId, ProcedureServiceDetails.Description, ProcedureServiceDetails.BillGroup, 
ProcedureServiceDetails.CancelBill, ProcedureServiceDetails.ProcedureId, BillService.ServiceName,isnull( HospEmpMst.Empname,'')as DrName
, 
convert(varchar(20),ProcedureServiceDetails.CreatedOn,103)+' '+convert(varchar(20),convert(time,ProcedureServiceDetails.CreatedOn),100) as RegistratonDateTime 
FROM            ProcedureServiceDetails INNER JOIN
BillService ON ProcedureServiceDetails.BillServiceId = BillService.BillServiceId LEFT OUTER JOIN
HospEmpMst ON ProcedureServiceDetails.DrId = HospEmpMst.DrId where ProcedureServiceDetails.PatRegId=@PatRegId
order by ProcedureServiceDetails.ProcedureServiceId desc
GO

CREATE PROCEDURE [dbo].[SP_GetRace]

as

select * from Tbl_Race
GO

CREATE PROCEDURE [dbo].[SP_GetRadiology_PatientInfo]

@Patientregid nvarchar(250)=null,
@LabNo int=0,

@Branchid int=1

as
SELECT DISTINCT 
PatientInformation.FirstName + ' ' + ISNULL(PatientInformation.MiddleName, '') + ' ' + ISNULL(PatientInformation.LastName, '') AS FirstName, ISNULL(Initial.Title, '') 
+ ' ' + PatientInformation.FirstName + ' ' + ISNULL(PatientInformation.MiddleName, '') + ' ' + ISNULL(PatientInformation.LastName, '') AS PatientName, LabServiceDetails.TotalCharges AS BillServiceCharges, 
LabRegistration.Entrydate, LabServiceDetails.OPDNo, LabServiceDetails.PatRegId, LabServiceDetails.BillNo, HospEmpMst.Title + ' ' + HospEmpMst.Empname AS Empname, ISNULL(Gender.GenderName, '') 
AS GenderName, LabRegistration.PatientMainCategoryId, LabRegistration.PatientSubCategoryId, PatMainType.PatMainType, PatientInsuType.PatientInsuType, PatientInformation.Age, PatientInformation.AgeType, 
PatientInformation.MobileNo, PatientInformation.BloodGroup, PatientInformation.BirthDate, LabRegistration.FId, LabRegistration.BranchId, LabRegistration.DrId, LabRegistration.LabNo, 
LabRegistration.LabPtype, LabRegistration.ReferBy, LabRegistration.CreatedBy, LabRegistration.CancelBill, PatientInformation.PatientAddress, PatientInformation.TitleId
FROM            LabServiceDetails INNER JOIN
LabRegistration ON LabServiceDetails.PatRegId = LabRegistration.PatRegId AND LabServiceDetails.LabNo = LabRegistration.LabNo LEFT OUTER JOIN
HospEmpMst ON LabServiceDetails.DrId = HospEmpMst.DrId LEFT OUTER JOIN
PatientInformation ON LabRegistration.PatRegId = PatientInformation.PatRegId LEFT OUTER JOIN
PatientInsuType ON LabRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN
PatMainType ON LabRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN
Gender ON PatientInformation.GenderId = Gender.GenderId LEFT OUTER JOIN
Initial ON PatientInformation.TitleId = Initial.TitleId
WHERE       PatientInformation.PatRegId=@Patientregid and LabRegistration.LabNo=@LabNo
GO

CREATE PROCEDURE [dbo].[Sp_GetRadiologyPayment]
	@FromDate datetime =null,
    @ToDate datetime =null,
    @PaymentStatus nvarchar(50) =null,
	@PatRegId int=null,
    @MobileNo nvarchar(50) =null,
    @FId int=null,
    @BranchId int =null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    Declare @sql varchar(3000)
   -- set @sql='select * from Vw_InvoiceList'
    set @sql='SELECT        LabRegistration.ID, LabRegistration.LabNo, LabRegistration.BillNo, LabRegistration.TokenNo, LabRegistration.PatRegId, LabRegistration.DrId, LabRegistration.VisitingNo, LabRegistration.Entrydate, 
                         LabRegistration.RegistrationType, LabRegistration.ReferenceDoc, LabRegistration.DeptId, LabRegistration.PatientComplaints, LabRegistration.PatientMainCategoryId, LabRegistration.PatientSubCategoryId, LabRegistration.FId, 
                         LabRegistration.BranchId, LabRegistration.CreatedBy, LabRegistration.CreatedOn, LabRegistration.UpdatedBy, LabRegistration.UpdatedOn, LabRegistration.IsPatientChecked, LabRegistration.ReferBy, 
                         LabRegistration.LabPtype, LabRegistration.CancelBill, LabRegistration.CancelBy, LabRegistration.CancelRemark, LabRegistration.CancelOn, LabRegistration.MainDoctor, LabBillPaymentTrns.BillPaymentId, 
                         LabBillPaymentTrns.ReceiptNo, LabBillPaymentTrns.ReceivedAmount, LabBillPaymentTrns.BalanceAmt, LabBillPaymentTrns.BillAmount, PatientInformation.FirstName, PatientInformation.MobileNo, 
                         PatientInformation.PatientAddress, LabBillPaymentTrns.RadioPayReceive, LabBillPaymentTrns.DiscountAmt, LabBillPaymentTrns.InsuranceAmount, 
                         LabBillPaymentTrns.BillAmount - (LabBillPaymentTrns.DiscountAmt + LabBillPaymentTrns.InsuranceAmount+LabBillPaymentTrns.ReceivedAmount) AS FinalBalance
FROM            LabRegistration INNER JOIN
                         LabBillPaymentTrns ON LabRegistration.LabNo = LabBillPaymentTrns.LabNo AND LabRegistration.PatRegId = LabBillPaymentTrns.PatRegId AND LabRegistration.BillNo = LabBillPaymentTrns.BillNo INNER JOIN
                         PatientInformation ON LabRegistration.PatRegId = PatientInformation.PatRegId where LabRegistration.PatientMainCategoryId<>3 and LabPtype=''R'' and CancelBill=0 and LabRegistration.FId='''+ convert(varchar(10),@FId)+''' and LabRegistration.BranchId='''+ convert(varchar(10),@BranchId)+''''
   
     if((@FromDate is not null) and  (@ToDate is not null))
    begin
    set @sql=@Sql +' and (CAST(CAST(YEAR(LabRegistration.EntryDate) AS varchar(4)) + ''/'' + CAST(MONTH(LabRegistration.EntryDate) AS varchar(2)) + ''/'' + CAST(DAY(LabRegistration.EntryDate) AS varchar(2)) AS datetime)) between ''' + convert(varchar(10),cast(@FromDate as date))+ '''  and ''' + convert(varchar(10),cast(@ToDate as date)) + ''''
      --Exec(@sql + ' Order by InvoiceNo desc ')
    end
	if(@PatRegId<>0)
	begin
	 set @sql=@Sql +' and LabRegistration.PatRegId = ''' +  convert(varchar(10),@PatRegId)  + '''' 
	end
     if(@MobileNo <>'')
    begin
    set @sql=@Sql +' and MobileNo = ''' + @MobileNo + '''' 
    --Exec(@sql + ' Order by InvoiceNo desc ')
    end
	if(@PaymentStatus = '1')
	begin
   
    set @sql=@Sql +' and BalanceAmt >0'
    
    end
	if(@PaymentStatus = '0')
	begin
   
    set @sql=@Sql +' and BalanceAmt =0'
    
    end
   
    print(@sql)
    Exec(@sql + ' Order by  LabRegistration.ID desc ')
    
    
END
GO

CREATE PROCEDURE [dbo].[SP_GetReligion]

as

select * from ReligionMst
GO

CREATE PROCEDURE [dbo].[SP_GetSurgeryType]  
  
as  
select * from surgeryType
GO

CREATE PROCEDURE [dbo].[SP_InsertAddMEdicalRecod]

@Patregid int=0, 
@PatientType nvarchar(250)='',
@AdmissionDate datetime=null,
@DischargeDate datetime=null, 
@DrName nvarchar(250)='', 
@DocumentNumber nvarchar(250)='', 
@DocumentFileName nvarchar(4000)='', 
@DocumentFilePath nvarchar(4000), 
@CreatedBy nvarchar(250)='',
@Diagnostics nvarchar(3000)=''


as

insert into AddMedicalRecord(Patregid, PatientType, AdmissionDate, DischargeDate, DrName, DocumentNumber, DocumentFileName, DocumentFilePath, CreatedBy,Diagnostics)
values(@Patregid, @PatientType, @AdmissionDate, @DischargeDate, @DrName, @DocumentNumber, @DocumentFileName, @DocumentFilePath, @CreatedBy,@Diagnostics)
GO

ALTER PROCEDURE [dbo].[SP_InsertBillServiceCharges]
@BillGroupId int=0,
@ServiceID int=0,
@RoomTypeId int=0,
@PatientType int=0,
@RateTypeId int=0,
@Rate float=0,
@Branchid int=1,
@CreatedBy nvarchar(50)=null,
@Drid int=0,
@IsRoomwise bit=0,
@IsDocwise  bit=0,
@IsDirect Bit=0,
@DrCompPer float=0,
@DrCompamt float=0,
@MTCode nvarchar(50)=''
as
begin try
  begin transaction

begin
if(@IsDocwise=1)
begin
		if(not exists(select ServiceID from BillSeviceCharges where ServiceID=@ServiceID and Branchid=@Branchid and IsDocWise=@IsDocwise and Drid=@Drid and RateTypeId=@RateTypeId))
		begin
			insert into BillSeviceCharges(BillGroupId,ServiceID,PatientType,RoomTypeId,RateTypeId,Rate,Branchid,CreatedBy,Drid,DrCompPer,DrCompamt,IsDocWise,IsRoomwise,IsDirect)
			values(@BillGroupId,@ServiceID,@PatientType,@RoomTypeId,@RateTypeId,@Rate,@Branchid,@CreatedBy,@Drid,@DrCompPer,@DrCompamt,@IsDocwise,@IsRoomwise,@IsDirect)
			Select '1Record Saved Successfully!!'
		end
		else
		begin
			update BillSeviceCharges set Rate=@Rate,DrCompamt=@DrCompamt,DrCompPer=@DrCompPer,BillGroupId=@BillGroupId where ServiceID=@ServiceID and Branchid=@Branchid and IsDocWise=@IsDocwise 
			 and Drid=@Drid and RateTypeId=@RateTypeId
			Select '1Record Updated Successfully!!'
		end
end
if(@IsRoomwise=1)
begin
		if(not exists(select ServiceID from BillSeviceCharges where ServiceID=@ServiceID and Branchid=@Branchid and IsRoomwise=@IsRoomwise and RoomTypeId=@RoomTypeId and RateTypeId=@RateTypeId))
		begin
			insert into BillSeviceCharges(BillGroupId,ServiceID,PatientType,RoomTypeId,RateTypeId,Rate,Branchid,CreatedBy,Drid,DrCompPer,DrCompamt,IsDocWise,IsRoomwise,IsDirect)
			values(@BillGroupId,@ServiceID,@PatientType,@RoomTypeId,@RateTypeId,@Rate,@Branchid,@CreatedBy,@Drid,@DrCompPer,@DrCompamt,@IsDocwise,@IsRoomwise,@IsDirect)
			Select '1Record Saved Successfully!!'
		end
		else
		begin
			update BillSeviceCharges set Rate=@Rate,BillGroupId=@BillGroupId where ServiceID=@ServiceID and Branchid=@Branchid and IsRoomwise=@IsRoomwise 
			 and RoomTypeId=@RoomTypeId and RateTypeId=@RateTypeId
			Select '1Record Updated Successfully!!'
		end
end
if(@IsDirect=1)
begin

if(@ServiceID=0)
begin
if(not exists(select ServiceID from BillSeviceCharges where MTCode=@MTCode and Branchid=@Branchid and IsDirect=@IsDirect and RateTypeId=@RateTypeId and PatientType=@PatientType ))
		begin
			insert into BillSeviceCharges(BillGroupId,ServiceID,PatientType,RoomTypeId,RateTypeId,Rate,Branchid,CreatedBy,Drid,DrCompPer,DrCompamt,IsDocWise,IsRoomwise,IsDirect,MTCode)
			values(@BillGroupId,@ServiceID,@PatientType,@RoomTypeId,@RateTypeId,@Rate,@Branchid,@CreatedBy,@Drid,@DrCompPer,@DrCompamt,@IsDocwise,@IsRoomwise,@IsDirect,@MTCode)
			Select '1Record Saved Successfully!!'
		end
		else
		begin
			update BillSeviceCharges set Rate=@Rate,BillGroupId=@BillGroupId where MTCode=@MTCode and ServiceID=@ServiceID and Branchid=@Branchid and IsDirect=@IsDirect and RateTypeId=@RateTypeId and PatientType=@PatientType
		
			Select '1Record Updated Successfully!!'
		end
end
else
begin
		if(not exists(select ServiceID from BillSeviceCharges where ServiceID=@ServiceID and Branchid=@Branchid and IsDirect=@IsDirect and RateTypeId=@RateTypeId and PatientType=@PatientType ))
		begin
			insert into BillSeviceCharges(BillGroupId,ServiceID,PatientType,RoomTypeId,RateTypeId,Rate,Branchid,CreatedBy,Drid,DrCompPer,DrCompamt,IsDocWise,IsRoomwise,IsDirect)
			values(@BillGroupId,@ServiceID,@PatientType,@RoomTypeId,@RateTypeId,@Rate,@Branchid,@CreatedBy,@Drid,@DrCompPer,@DrCompamt,@IsDocwise,@IsRoomwise,@IsDirect)
			Select '1Record Saved Successfully!!'
		end
		else
		begin
			update BillSeviceCharges set Rate=@Rate,BillGroupId=@BillGroupId where ServiceID=@ServiceID and Branchid=@Branchid and IsDirect=@IsDirect and RateTypeId=@RateTypeId and PatientType=@PatientType
		
			Select '1Record Updated Successfully!!'
		end
		end
end
end

commit transaction
end try
begin catch

    declare @err_msg varchar(max), @errnunber varchar(max), @errstate varchar(max)
  select  @err_msg= ERROR_MESSAGE()  ,@errnunber  = ERROR_NUMBER()  , @errstate = ERROR_STATE() 

    raiserror(@err_msg,16,1)

  rollback transaction
  
end catch
GO

CREATE PROCEDURE [dbo].[Sp_InsertInsurancePaymentTransaction_ForOPD]      
     
@Sponser int=0,      
@PaymentMode nvarchar(50)=null,                          
@CreditAmount float,      
-- @PaymentDate datetime,      
@ChequeNo nvarchar(20)=null,      
@ChequeDate nvarchar(20)=null,      
@BankName nvarchar(250)=null,      
@TransactionType nvarchar(10)=null,                         
@BranchId int=0,      
@FId int=0,    
@CreatedBy nvarchar(250)    
              
              
AS      
BEGIN      
    declare @Receiptno int      
      
    select @Receiptno=IsNull(max(Receiptno),0) from InsuranceCompPaymentTransactions_ForOPD where  FId=@FId and BranchId=@BranchId      
    set @Receiptno= @Receiptno + 1;      
      
     
  INSERT INTO InsuranceCompPaymentTransactions_ForOPD      
           (Sponser,PaymentMode,CreditAmount,PaymentDate,ReceiptNo,ChequeNo,ChequeDate, BankName ,TransactionType,BranchId ,FId,CreatedBy,CreatedOn )    
                
     VALUES      
          (@Sponser,@PaymentMode,@CreditAmount,getdate(),@Receiptno,@ChequeNo,@ChequeDate,@BankName ,@TransactionType,@BranchId , @FId,@CreatedBy,getdate())    
                 
          
       select  Convert(varchar(20), @Receiptno);      
END      
      
      
      
      
      
      
--select * from InsurancepaymentTransaction
GO

ALTER PROCEDURE [dbo].[Sp_InsertIPDRegistration] 
	-- Add the parameters for the stored procedure here
	@IpdNo int,	
	@PatRegId	int,	
	@PatMainTypeId	int,
    @PatientInsuTypeId	int,		
	@DeptId	int=0,		
	@EntryTime	nvarchar(50),	
	@PrimaryDoc	int=0,
	@SecodaryDoc int=0,
	@ReferenceDoc int=0,
	@ContactPerson1	nvarchar(250)=null,
	@ContactPerson2	nvarchar(250)=null,
	@Relation1	int=0,
	@Relation2	int=0,	
	@Contact1	nvarchar(50)=null,
	@Contact2	nvarchar(50)=null,	
	@CreatedBy	nvarchar(50)=null,
	@BedId int,
	@IsAdmited bit,	
	@FId	int,
	@BranchId	int	,
	@IsEmergency bit,
	@IsUniversalPrecaution bit,	
	@OperationName nvarchar(250)='',
	@DiseaseName nvarchar(250)='',
	@OperationId int=null,
	@DiseaseId int=null,
	@PatientInsuTypeId2 int=0,
	@EntryDate datetime=null,
	@IpdId int=0 output
	
	

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	declare @VisitingNo int
	select @VisitingNo=IsNull(max(VisitingNo),0)+1 from OpdRegistration where  PatRegId=@PatRegId
	declare @OPID int=0
 declare @DisID int=0
 if(@OperationId=0 and @OperationName <> '')
 begin
  if(not exists(select OperationName from OperationMst where OperationName=@OperationName and IsGeneral=1 ))
 begin
 insert into OperationMst(OperationName,FID,Branchid,CreatedBy,CreatedOn,IsGeneral)
 values(@OperationName,@FID,@Branchid,@Createdby,getdate(),1)
 end
 end
  if(@DiseaseId=0 and @DiseaseName <> '')
 begin
 if(not exists(select DiseaseName from DiseaseMst where DiseaseName=@DiseaseName and IsGeneral=1 ))
 begin
 insert into DiseaseMst(DiseaseName,FID,Branchid,CreatedBy,CreatedOn,IsGeneral)
 values(@DiseaseName,@FID,@Branchid,@Createdby,getdate(),1)
 end
 end

 if(@OperationId=0 and @OperationName <> '')
 begin
  select @OPID=OperationId from OperationMst where OperationName=@OperationName
  end

 if(@DiseaseId=0 and @DiseaseName <> '')
 begin
 
  select @DisID=DiseaseId from DiseaseMst where DiseaseName=@DiseaseName
  end

	if Not exists(Select PatRegId from IpdRegistration where IsAdmited=1 and PatRegId=@PatRegId)
	begin
	Insert into IpdRegistration (
	IpdNo,
	PatRegId,
	Entrydate,	
	EntryTime,
	PrimaryDoc,
	SecodaryDoc,
	ReferenceDoc,
	PatientMainCategoryId,	
    PatientSubCategoryId,
	DeptId,	
	ContactPerson1,
	ContactPerson2,
	Relation1,
	Relation2,
	Contact1,	
	Contact2,
	BedId,
	IsAdmited,
	IsEmergency,
	IsUniversalPrecaution,	
	FId,
	BranchId,	
	CreatedBy,
	CreatedOn,
	Sponsor,
	ProcedureName,
	DiseaseId,
	OperationId,
	PatientSubCategoryId2,
	VisitingNo)
	values
	( 
	@IpdNo,
	@PatRegId,
	@EntryDate,
	@EntryTime,
	@PrimaryDoc,
	@SecodaryDoc,
	@ReferenceDoc,
	@PatMainTypeId,
    @PatientInsuTypeId,
	@DeptId,
	@ContactPerson1,
	@ContactPerson2,
	@Relation1,
	@Relation2,
	@Contact1,	
	@Contact2,
	@BedId,
	@IsAdmited,	
	@IsEmergency,
	@IsUniversalPrecaution,	
	@FId,
	@BranchId,	
	@CreatedBy,
	Getdate(),
	@DiseaseName,
	@OperationName,
	@DisId,
	@OPID,
	@PatientInsuTypeId2,
	@VisitingNo)

    select @IpdId=@@identity
	SELECT '1Patient Admitted Successfully'

	insert into IpdBillMaster (IpdId,IpdNo,PatRegId,BillAmount,AmountReceived,InsuranceAmt,Discount,FId,BillNo,BranchId,CreatedBy,CreatedOn) values
   (@IpdId,@IpdNo,@PatRegId,0,0,0,0,@FId,@IpdNo,@BranchId,@CreatedBy,getdate())
	 end
	 else
	 begin
	  select @IpdId=0
	 SELECT '0Patient is Admitted Already!!'
	 end


END
GO

ALTER PROCEDURE [dbo].[SP_InsertLabBillTransaction]          
 -- Add the parameters for the stored procedure here          
@BillPaymentId int out,          
@BillNo int=0,          
@ReceiptNo int=0,          
@PatRegId int=0,          
--@PaymentDate datetime,          
@ReceivedAmount float=0,          
@DiscountAmt float=0,           
@BalanceAmt float=0,          
@OpdNo int=0,          
@IpdNo int=0,          
@IsOpd bit=0,          
@IsIpd bit=0,          
@BillType  varchar(500)=null,          
@DrId int=0,          
@FId int,          
@Remark nvarchar(2000)=null,          
          
@BranchId int,          
@PaymentMode nvarchar(50)='',          
@CardChequeNo nvarchar(50)=null,          
@ChequeDate datetime=null,          
@BankName nvarchar(255)=null,          
@ReasonForDiscountId int=0,          
@ReasonForBalanceId int=0,          
@DiscountGivenById int=0,          
@CreatedBy varchar(50)=null,          
@InsuranceCompId int=null,          
@IsInsurance bit=0,          
@InsuranceAmount float=0,          
@IsDeposit bit=0,          
@BillAmount float=0,          
@LabNo int=0    ,
@PatientType int=0
          
AS          
BEGIN          
 -- SET NOCOUNT ON added to prevent extra result sets from          
 -- interfering with SELECT statements.          
          
 if(@IpdNo>0)          
 begin          
 set @IsOpd=0          
 set @IsIpd=1          
 end          
 else if(@LabNo>0)          
 begin          
 set @IsOpd=0          
 set @IsIpd=0          
 end          
 else          
 begin          
 set @IsOpd=1          
 set @IsIpd=0          
 end          
 SET NOCOUNT ON;          
 declare @AmountReceived float          
 declare @DisReceived float          
 declare @BillAmtT float          
    declare @ChargeNumber nvarchar(50)=''        
         
   if(@InsuranceCompId>0)        
   begin        
   if(not exists( select Patregid from ChargeBill_Master where Patregid=@PatRegId and InsuranceCompId= @InsuranceCompId and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS
  
 datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)))        
   begin        
   declare @ChargeId int=0        
   declare @Code nvarchar(50)=0        
   select @ChargeId=isnull(max(ChargeId),0)+1 from ChargeBill_Master where InsuranceCompId= @InsuranceCompId and year(createdon)=year(getdate())    
   --and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)        
        
   select @Code=Code from PatientInsuType where  PatientInsuTypeId= @InsuranceCompId        
        
       insert into ChargeBill_Master(ChargeId, ChargeNo, PatientMainType,InsuranceCompId, Patregid, BillAmt, InsuranceAmt, CreatedBy,  CancelBill,Billgroupname,BillNo)        
   values(@ChargeId,cast(@Code as nvarchar(50))+'-'+cast( @ChargeId as nvarchar(50)) ,@PatientType,@InsuranceCompId,@PatRegId,@BillAmount,@InsuranceAmount,@CreatedBy,0,@BillType,@BillNo)        
   end        
   else        
   begin        
   update ChargeBill_Master set BillAmt=BillAmt+@BillAmount,InsuranceAmt=InsuranceAmt+@InsuranceAmount where Patregid=@PatRegId and InsuranceCompId= @InsuranceCompId  and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)      
   end     
   select @ChargeNumber=ChargeNo from ChargeBill_Master where Patregid=@PatRegId and InsuranceCompId= @InsuranceCompId and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS 
 
 datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)  

   end        
    
      
 insert into LabBillPaymentTrns(          
BillNo, ReceiptNo,PatRegId,PaymentDate,ReceivedAmount,DiscountAmt,BalanceAmt,OpdNo,IpdNo,IsOpd,IsIpd,BillType,DrId,Remark,FId,BranchId,PaymentMode,ChequeNo,ChequeDate,BankName,          
ReasonForDisc,ReasonForBalance,DiscGivenBy,CreatedBy,CreatedOn,InsuranceCompId,InsuranceAmount, IsInsurance,IsDeposit,LabNo,BillAmount,PaymentReceivedBy,ChargeNumber)           
values          
(@BillNo,@ReceiptNo,@PatRegId,getdate(),@ReceivedAmount,@DiscountAmt,@BalanceAmt,@OpdNo,@IpdNo,@IsOpd,@IsIpd,@BillType,@DrId,@Remark,@FId,@BranchId,@PaymentMode,@CardChequeNo,          
@ChequeDate,@BankName,@ReasonForDiscountId,@ReasonForBalanceId,@DiscountGivenById,@CreatedBy,getdate(),@InsuranceCompId,@InsuranceAmount,@IsInsurance,@IsDeposit,@LabNo,@BillAmount,@CreatedBy,@ChargeNumber)          
          
set @BillPaymentId =@@IDENTITY          
          
          
--else          
--begin          
-- (Select @AmountReceived=Isnull(AmountReceived,0),@DisReceived=Isnull(Discount,0) ,@BillAmtT =Isnull(BillAmount,0)  from IpdBillMaster where LabNo=@LabNo and OpdNo=@OpdNo and Ipdno=@IpdNo and PatRegId=@PatRegId and FId=@FId and BranchId=@BranchId)      
  
    
          
-- if(@ReceivedAmount<0)          
-- begin          
-- set @ReceivedAmount=@ReceivedAmount*-1          
--  set @AmountReceived=@AmountReceived-@ReceivedAmount          
--  update IpdBillMaster set AmountReceived=@AmountReceived,UpdatedBy=@CreatedBy,UpdatedOn=getdate() where LabNo=@LabNo and OpdNo=@OpdNo and Ipdno=@IpdNo  and PatRegId=@PatRegId and FId=@FId and BranchId=@BranchId          
          
-- end          
-- else          
-- begin          
--  set @AmountReceived=@ReceivedAmount+@AmountReceived          
--  set @DiscountAmt=@DiscountAmt+@DisReceived          
--  set @BillAmount=@BillAmount+@BillAmtT          
-- update IpdBillMaster set BillAmount=@BillAmount,AmountReceived=@AmountReceived,Discount=@DiscountAmt,UpdatedBy=@CreatedBy,UpdatedOn=getdate() where LabNo=@LabNo and OpdNo=@OpdNo and Ipdno=@IpdNo  and PatRegId=@PatRegId and FId=@FId and BranchId=@BranchId          
          
          
          
-- end          
-- end          
    print(@AmountReceived)          
 return @BillPaymentId          
END
GO

CREATE PROCEDURE [dbo].[SP_InsertLabBillTransaction_Radio]        
 -- Add the parameters for the stored procedure here        
@BillPaymentId int out,        
@BillNo int=0,        
@ReceiptNo int=0,        
@PatRegId int=0,        
--@PaymentDate datetime,        
@ReceivedAmount float=0,        
@DiscountAmt float=0,         
@BalanceAmt float=0,        
@OpdNo int=0,        
@IpdNo int=0,        
@IsOpd bit=0,        
@IsIpd bit=0,        
@BillType  varchar(500)=null,        
@DrId int=0,        
@FId int,        
@Remark nvarchar(2000)=null,        
        
@BranchId int,        
@PaymentMode nvarchar(50)='',        
@CardChequeNo nvarchar(50)=null,        
@ChequeDate datetime=null,        
@BankName nvarchar(255)=null,        
@ReasonForDiscountId int=0,        
@ReasonForBalanceId int=0,        
@DiscountGivenById int=0,        
@CreatedBy varchar(50)=null,        
@InsuranceCompId int=null,        
@IsInsurance bit=0,        
@InsuranceAmount float=0,        
@IsDeposit bit=0,        
@BillAmount float=0,        
@LabNo int=0  ,
@PatientType int=0
        
AS        
BEGIN        
 -- SET NOCOUNT ON added to prevent extra result sets from        
 -- interfering with SELECT statements.        
        
 if(@IpdNo>0)        
 begin        
 set @IsOpd=0        
 set @IsIpd=1        
 end        
 else if(@LabNo>0)        
 begin        
 set @IsOpd=0        
 set @IsIpd=0        
 end        
 else        
 begin        
 set @IsOpd=1        
 set @IsIpd=0        
 end        
 SET NOCOUNT ON;        
 declare @AmountReceived float        
 declare @DisReceived float        
 declare @BillAmtT float        
     declare @ChargeNumber nvarchar(50)=''    
        
   if(@InsuranceCompId>0)      
   begin      
   if(not exists( select Patregid from ChargeBill_Master where Patregid=@PatRegId and InsuranceCompId= @InsuranceCompId and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS
 datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)))      
   begin      
   declare @ChargeId int=0      
   declare @Code nvarchar(50)=0      
   select @ChargeId=isnull(max(ChargeId),0)+1 from ChargeBill_Master where InsuranceCompId= @InsuranceCompId and year(createdon)=year(getdate()) --and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)      
      
   select @Code=Code from PatientInsuType where  PatientInsuTypeId= @InsuranceCompId      
      
       insert into ChargeBill_Master(ChargeId, ChargeNo, PatientMainType,InsuranceCompId, Patregid, BillAmt, InsuranceAmt, CreatedBy,  CancelBill,Billgroupname,BillNo)      
   values(@ChargeId,cast(@Code as nvarchar(50))+'-'+cast( @ChargeId as nvarchar(50)) ,@PatientType,@InsuranceCompId,@PatRegId,@BillAmount,@InsuranceAmount,@CreatedBy,0,@BillType,@BillNo)      
   end      
   else      
   begin      
   update ChargeBill_Master set BillAmt=BillAmt+@BillAmount,InsuranceAmt=InsuranceAmt+@InsuranceAmount where Patregid=@PatRegId and InsuranceCompId= @InsuranceCompId and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2))+ '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)     
   end   
    select @ChargeNumber=ChargeNo from ChargeBill_Master where Patregid=@PatRegId and InsuranceCompId= @InsuranceCompId and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS 
 
 datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)  

   end      
      
      
 insert into LabBillPaymentTrns(        
BillNo, ReceiptNo,PatRegId,PaymentDate,ReceivedAmount,DiscountAmt,BalanceAmt,OpdNo,IpdNo,IsOpd,IsIpd,BillType,DrId,Remark,FId,BranchId,PaymentMode,ChequeNo,ChequeDate,BankName,        
ReasonForDisc,ReasonForBalance,DiscGivenBy,CreatedBy,CreatedOn,InsuranceCompId,InsuranceAmount, IsInsurance,IsDeposit,LabNo,BillAmount,ChargeNumber)         
values        
(@BillNo,@ReceiptNo,@PatRegId,getdate(),@ReceivedAmount,@DiscountAmt,@BalanceAmt,@OpdNo,@IpdNo,@IsOpd,@IsIpd,@BillType,@DrId,@Remark,@FId,@BranchId,@PaymentMode,@CardChequeNo,        
@ChequeDate,@BankName,@ReasonForDiscountId,@ReasonForBalanceId,@DiscountGivenById,@CreatedBy,getdate(),@InsuranceCompId,@InsuranceAmount,@IsInsurance,@IsDeposit,@LabNo,@BillAmount,@ChargeNumber)        
        
set @BillPaymentId =@@IDENTITY        
        
        
--else        
--begin        
-- (Select @AmountReceived=Isnull(AmountReceived,0),@DisReceived=Isnull(Discount,0) ,@BillAmtT =Isnull(BillAmount,0)  from IpdBillMaster where LabNo=@LabNo and OpdNo=@OpdNo and Ipdno=@IpdNo and PatRegId=@PatRegId and FId=@FId and BranchId=@BranchId)      
  
        
-- if(@ReceivedAmount<0)        
-- begin        
-- set @ReceivedAmount=@ReceivedAmount*-1        
--  set @AmountReceived=@AmountReceived-@ReceivedAmount        
--  update IpdBillMaster set AmountReceived=@AmountReceived,UpdatedBy=@CreatedBy,UpdatedOn=getdate() where LabNo=@LabNo and OpdNo=@OpdNo and Ipdno=@IpdNo  and PatRegId=@PatRegId and FId=@FId and BranchId=@BranchId        
        
-- end        
-- else        
-- begin        
--  set @AmountReceived=@ReceivedAmount+@AmountReceived        
--  set @DiscountAmt=@DiscountAmt+@DisReceived        
--  set @BillAmount=@BillAmount+@BillAmtT        
-- update IpdBillMaster set BillAmount=@BillAmount,AmountReceived=@AmountReceived,Discount=@DiscountAmt,UpdatedBy=@CreatedBy,UpdatedOn=getdate() where LabNo=@LabNo and OpdNo=@OpdNo and Ipdno=@IpdNo  and PatRegId=@PatRegId and FId=@FId and BranchId=@BranchId        
        
        
        
-- end        
-- end        
    print(@AmountReceived)        
 return @BillPaymentId        
END
GO

ALTER PROCEDURE [dbo].[Sp_InsertLabRegistration]   
 -- Add the parameters for the stored procedure here  
 @LabNo int=0 output,   
 @PatRegId int,  
 @VisitingNo int=0,  
 @TokenNo int=0,  
 @DrId int,  
 @PatMainTypeId int=0,  
 @PatientInsuTypeId int=0,   
 --@RegistrationType nvarchar(50),  
 @ReferenceDoc nvarchar(50)=null,   
 @DeptId int=0,   
 @PatientComplaints nvarchar(2000)=null,  
 @FId varchar(10)=null,  
 @BranchId numeric(18, 0)=0,   
 @CreatedBy nvarchar(250)=null,  
 @ReferBy nvarchar(250)='',  
 @LabPtype nvarchar(250)='',  
 @MainDoctor nvarchar(250)='',  
 @AfterHrs bit=0,  
 @InsuranceChargeCompany int=0 ,
 @LetterNo nvarchar(50)=''
   
  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
 declare @BillNo1 int  
 declare @LABNO1 int  
 Set @BillNo1=(select IsNull(Max(BillNo),0)+1  from LabRegistration where LabPtype=@LabPtype )  
 Set @LABNO1=(select IsNull(Max(LabNO),0)+1  from LabRegistration where FID=@FId and BranchId=@BranchId )  
 Insert into LabRegistration (  
PatRegId,Entrydate,DrId,VisitingNo,TokenNo, ReferenceDoc,PatientMainCategoryId,PatientSubCategoryId,DeptId,PatientComplaints,FId,BranchId,CreatedBy,CreatedOn,BillNo,  
LabNO,ReferBy,LabPtype,MainDoctor,AfterHrs,InsuranceChargeCompany,LetterNo)  
values( @PatRegId,getdate(),@DrId,@VisitingNo,@TokenNo,@ReferenceDoc,@PatMainTypeId,@PatientInsuTypeId, @DeptId,@PatientComplaints,@FId,@BranchId, @CreatedBy,Getdate(),  
@BillNo1,@LABNO1,@ReferBy,@LabPtype,@MainDoctor,@AfterHrs,@InsuranceChargeCompany,@LetterNo)  
  
   select @LabNo=@LABNO1  
 --SELECT 'OPD No= ' + CONVERT(varchar(100),@OPDNO1) + 'Bill No= ' + CONVERT(varchar(100),@BillNo1) + 'and Visiting No = '+ CONVERT(varchar(100),@VisitingNo)  
   
END
GO

CREATE PROCEDURE [dbo].[SP_InsertPatientInsu_SubType]

@PatientMainType int=0, 
@PatientInsuTypeId int=0, 
@ChildCompanyName nvarchar(500)='', 
@ContactNumber nvarchar(50)='', 
@CompanyDescription nvarchar(2500)='', 
@CreatedBy nvarchar(250)='', 
@BranchId int=0

as

insert into PatientInsu_SubType(PatientMainType, PatientInsuTypeId, ChildCompanyName, ContactNumber, CompanyDescription, CreatedBy, BranchId)
values(@PatientMainType, @PatientInsuTypeId, @ChildCompanyName, @ContactNumber, @CompanyDescription, @CreatedBy, @BranchId)
GO

CREATE PROCEDURE [dbo].[Sp_InsertPatientInvoiceDatails_ForOPD]  
 -- Add the parameters for the stored procedure here  
 @InvoiceNo int,  
 @ChargeNo nvarchar(50),  
 @PatRegId int,  
 @BillAmount float,  
 @FId int,  
 @BranchId int,  
 @InsuranceCompId int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
if not exists(Select * from PatientInvoiceDetails_ForOPD where PatRegId=@PatRegId and  ChargeNo=@ChargeNo and Sponser=@InsuranceCompId)  
    begin  
  insert into PatientInvoiceDetails_ForOPD (InvoiceNo,PatRegId,InsuranceAmount,ChargeNo,Sponser,FId,BranchId,TransactionDate) values  
  (@InvoiceNo,@PatRegId,@BillAmount,@ChargeNo,@InsuranceCompId,@FId,@BranchId,getdate())
  
  update ChargeBill_Master set GenerateInvoice=1 where PatRegId=@PatRegId and  ChargeNo=@ChargeNo and InsuranceCompId=@InsuranceCompId
 end  
  
END
GO

ALTER PROCEDURE [dbo].[Sp_InsertProcedureInfo]                 
 -- Add the parameters for the stored procedure here                
 @BillNo int=0 output,                
 @ProcedureId int output,                 
 @PatRegId int,                
 @BillGroup nvarchar(max)=null,                
 @PatMainTypeId int,                
 @PatientInsuTypeId int,                  
 @AmountPaid float,                           
 @DiscountAmt float,                
 @BillAmount float,                
 @ReasonForDiscountId int ,                
 @DiscountGivenById int ,                          
 @ReasonForBalanceId int,                
 @InsuranceAmount float,                
 @FId varchar(10),                
 @BranchId numeric(18, 0),                 
 @CreatedBy nvarchar(30),                
 @Details nvarchar(250)=null ,              
 @OPDNo int=0,              
 @BillGroupId int=0,              
 @InsuranceChargeCompamt int=0  ,            
 @LetterNo nvarchar(250)='',            
 @TypeOfVisit nvarchar(500)=''            
                 
                
AS                
BEGIN                
 -- SET NOCOUNT ON added to prevent extra result sets from                
 -- interfering with SELECT statements.                
 SET NOCOUNT ON;                
 declare @BillNo1 int                
 declare @ProcedureNo int=0   
  declare @ChargeNumber nvarchar(50)=''  
 Set @BillNo1=(select IsNull(Max(BillNo),0)+1 as BillNo from ProcedureBillMaster where BillGroup=@BillGroup)                
                
  if(@BillGroupId<>1)              
  begin              
   Set @ProcedureNo=(select IsNull(Max(ProcedureNo),0)+1 as BillNo from ProcedureBillMaster where BillGroup=@BillGroup)                
   end              
   else              
   begin              
   Set @ProcedureNo=0              
   end              
          
   if(@PatMainTypeId>1)          
   begin          
   if(not exists( select Patregid from ChargeBill_Master where Patregid=@PatRegId and InsuranceCompId= @PatientInsuTypeId and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) 
  
 AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)))          
   begin          
   declare @ChargeId int=0          
   declare @Code nvarchar(50)=0          
   select @ChargeId=isnull(max(ChargeId),0)+1 from ChargeBill_Master where InsuranceCompId= @PatientInsuTypeId and year(createdon)=year(getdate())    
   --and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)          
          
   select @Code=Code from PatientInsuType where  PatientInsuTypeId= @PatientInsuTypeId          
          
       insert into ChargeBill_Master(ChargeId, ChargeNo,PatientMainType, InsuranceCompId, Patregid, BillAmt, InsuranceAmt, CreatedBy,  CancelBill,BillGroupName,BillNo)          
   values(@ChargeId,cast(@Code as nvarchar(50))+'-'+cast( @ChargeId as nvarchar(50)) ,@PatMainTypeId,@PatientInsuTypeId,@PatRegId,@BillAmount,@InsuranceAmount,@CreatedBy,0,@BillGroup,@BillNo1)          
   end          
   else          
   begin          
   update ChargeBill_Master set BillAmt=BillAmt+@BillAmount,InsuranceAmt=InsuranceAmt+@InsuranceAmount where Patregid=@PatRegId and InsuranceCompId= @PatientInsuTypeId      
   and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2))  AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)    
   end    
      select @ChargeNumber=ChargeNo from ChargeBill_Master where Patregid=@PatRegId and InsuranceCompId= @PatientInsuTypeId and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2))   AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)  

   end         
       
          
 Insert into ProcedureBillMaster(                
 PatRegId,  PatientMainType, PatientSubType,  BillAmount, AmountPaid, Discount, InsuranceAmt, Details, ReasonForDiscountId ,  DiscountGivenById ,                          
 ReasonForBalanceId, BillGroup,   BillNo,   FId,   BranchId,    CreatedBy,  CreatedOn,ProcedureNo,OPDNo,BillGroupId,InsuranceChargeCompamt,LetterNo,TypeOfVisit,ChargeNumber)                
 values                
 ( @PatRegId,  @PatMainTypeId,   @PatientInsuTypeId ,   @BillAmount,     @AmountPaid,    @DiscountAmt,@InsuranceAmount, @Details,  @ReasonForDiscountId ,  @DiscountGivenById ,           
 @ReasonForBalanceId , @BillGroup, @BillNo1,  @FId, @BranchId,   @CreatedBy,  getdate(),@ProcedureNo,@OPDNo,@BillGroupId ,@InsuranceChargeCompamt ,@LetterNo,@TypeOfVisit,@ChargeNumber    )              
           
        
                
   select @ProcedureId=@@identity                
   SELECT @BillNo=@BillNo1                
                 
END
GO

CREATE PROCEDURE [dbo].[Sp_InsuranceBillAmountTotal_OPD]  
 -- Add the parameters for the stored procedure here  
 @FromDate varchar(20) =null,  
 @ToDate varchar(20) =null,  
 @FId int,  
 @BranchId int,  
 @InsuranceCompId int,  
 @CreatedBy nvarchar(50),  
 @InvoiceNo1 int out  
   
  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
 declare @BillAmount float  
 declare @InvoiceNo int  
    -- Insert statements for procedure here  
 Set @BillAmount=(SELECT Sum(InsuranceAmt) as InsuranceBillAmount From ChargeBill_Master where GenerateInvoice=0  and   
  InsuranceCompId=@InsuranceCompId and    
  CONVERT(date, CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + '')  
  
  if(@BillAmount >0)   
  begin  
  set @InvoiceNo= (Select IsNull(max(InvoiceNo),0) +1  from GenerateCompanyInvoice_ForOPD )  
  Insert into GenerateCompanyInvoice_ForOPD (InvoiceNo,BillAmount,FromDate,ToDate,InsuranceCompId,InvoiceDate,  
  FId,BranchId,CreatedBy,CreatedOn) values  
  (@InvoiceNo,@BillAmount,CONVERT(datetime, @FromDate, 105),CONVERT(datetime, @ToDate, 105),@InsuranceCompId,getdate(),  
  @FId,@BranchId,@CreatedBy,getdate())  
  
  INSERT INTO [dbo].InsuranceCompPaymentTransactions_ForOPD  
           (Sponser,DebitAmount,PaymentDate,TransactionType,Invoiceno,FId,BranchId,CreatedBy,CreatedOn)  
      VALUES (@InsuranceCompId, @BillAmount,getdate(),'Debit', @InvoiceNo,@FId,@BranchId,@CreatedBy,getdate())  
  select 'Invoice Generated Successfully'  
  Select @InvoiceNo1=@InvoiceNo  
 -- select  CONVERT(datetime, '01/04/2020',105) as fromdate  
   
  end  
  else  
  begin  
  select 'Insurance BillAmount Is 0'  
  select @InvoiceNo1=0  
  end  
    
END
GO

CREATE PROCEDURE [dbo].[Sp_InvoiceGrid_ForOPDPatients]             
 -- Add the parameters for the stored procedure here            
 @FromDate varchar(50),            
 @ToDate varchar(50),            
 @InsuranceId int  ,  
 @ChargeNumber nvarchar(50)='',  
 @Patname nvarchar(50)='' ,
 @GenerateInvoice int=0
AS            
BEGIN            
 -- SET NOCOUNT ON added to prevent extra result sets from            
 -- interfering with SELECT statements.            
 SET NOCOUNT ON;            
            
    -- Insert statements for procedure here            
        if(@GenerateInvoice=0)
		begin
    if(@InsuranceId>0)    
    begin    
 SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where  ChargeBill_Master.GenerateInvoice=0 and           
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''          
 and InsuranceCompId=@InsuranceId   order by ChargeBill_Master.ID desc      
  end    
  else if(@InsuranceId>0 and @ChargeNumber<>'')    
    begin    
 SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where   ChargeBill_Master.GenerateInvoice=0 and           
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''          
 and InsuranceCompId=@InsuranceId   and ChargeBill_Master.ChargeNo= @ChargeNumber   order by ChargeBill_Master.ID desc     
  end    
  else if( @ChargeNumber<>'')    
    begin    
 SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where  ChargeBill_Master.GenerateInvoice=0 and            
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''          
 and  ChargeBill_Master.ChargeNo= @ChargeNumber   order by ChargeBill_Master.ID desc     
  end    
   else if( @Patname<>'')    
    begin    
 SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where  ChargeBill_Master.GenerateInvoice=0 and            
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''          
 and  PatientInformation.FirstName  like '%'+@Patname+'%'  order by ChargeBill_Master.ID desc     
  end    
  else    
  begin    
  SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where  ChargeBill_Master.GenerateInvoice=0 and            
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''      
order by ChargeBill_Master.ID desc     
    
  end    
            
			end
			else
			begin
			  if(@InsuranceId>0)    
    begin    
	--PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP
 SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where        ChargeBill_Master.GenerateInvoice=1 and      
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''          
 and InsuranceCompId=@InsuranceId   order by ChargeBill_Master.ID desc      
  end    
  else if(@InsuranceId>0 and @ChargeNumber<>'')    
    begin    
 SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where      ChargeBill_Master.GenerateInvoice=1 and           
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''          
 and InsuranceCompId=@InsuranceId   and ChargeBill_Master.ChargeNo= @ChargeNumber   order by ChargeBill_Master.ID desc     
  end    
  else if( @ChargeNumber<>'')    
    begin    
 SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where  ChargeBill_Master.GenerateInvoice=1 and               
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''          
 and  ChargeBill_Master.ChargeNo= @ChargeNumber   order by ChargeBill_Master.ID desc     
  end    
   else if( @Patname<>'')    
    begin    
 SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where  ChargeBill_Master.GenerateInvoice=1 and               
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''          
 and  PatientInformation.FirstName  like '%'+@Patname+'%'  order by ChargeBill_Master.ID desc     
  end    
  else    
  begin    
  SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,       
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName      
FROM  ChargeBill_Master INNER JOIN      
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN      
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId where           ChargeBill_Master.GenerateInvoice=1 and      
CONVERT(date, ChargeBill_Master.CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''      
order by ChargeBill_Master.ID desc     
    
  end    
            
			end
            
END
GO

ALTER PROCEDURE [dbo].[Sp_IpdRegSelectOne] 
	-- Add the parameters for the stored procedure here
	@IpdId int,
	@FId int,
	@BranchId int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
SELECT        IpdRegistration.IpdId, PatientInformation.TitleId, PatientInformation.FirstName AS PatientName, PatientInformation.MobileNo, PatientInformation.PatientInfoId, CONVERT(varchar(100), IpdRegistration.EntryDate, 103) 
                         AS EntryDate, IpdRegistration.EntryTime, IpdRegistration.DeptId, IpdRegistration.PrimaryDoc, IpdRegistration.SecodaryDoc, IpdRegistration.ReferenceDoc, IpdRegistration.PatientMainCategoryId, 
                         IpdRegistration.PatientSubCategoryId, IpdRegistration.ContactPerson1, IpdRegistration.ContactPerson2, IpdRegistration.Relation1, IpdRegistration.Contact1, IpdRegistration.Relation2, IpdRegistration.Contact2, 
                         IpdRegistration.FId, IpdRegistration.BranchId, dbo.FnGetAge(PatientInformation.PatientInfoId) AS Age, IpdRegistration.IsUniversalPrecaution, IpdRegistration.IsEmergency, DepartmentMst.DeptName, HospEmpMst.Empname, 
                         CAST(IpdRegistration.PrimaryDoc AS nvarchar(50)) + '-' + HospEmpMst.Empname AS FullDocName, CAST(IpdRegistration.DeptId AS nvarchar(50)) + '-' + DepartmentMst.DeptName AS FullDeptName, IsNull(IpdRegistration.Sponsor, '') as Sponsor,
                         IsNull(IpdRegistration.ProcedureName,'') as ProcedureName,  IpdRegistration.PatientSubCategoryId2,IsNull(IpdRegistration.DiseaseId,0) as DiseaseId ,IsNull(IpdRegistration.OperationId,0) as OperationId
FROM            IpdRegistration INNER JOIN
                         PatientInformation ON IpdRegistration.PatRegId = PatientInformation.PatRegId INNER JOIN
                         DepartmentMst ON IpdRegistration.DeptId = DepartmentMst.DeptId AND IpdRegistration.BranchId = DepartmentMst.BranchId INNER JOIN
                         HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId--where IpdRegistration.FId=1 and IpdRegistration.BranchId=1 and IpdRegistration.IpdId=18
				 where IpdRegistration.FId=@FId and IpdRegistration.BranchId=@BranchId and IpdRegistration.IpdId=@IpdId
   
END
GO

CREATE PROCEDURE [dbo].[Sp_IsBillGroupDaily]

@BillGroupId int=0
AS
BEGIN
	SELECT        BillGroupId, GroupName, isnull(DailyService,0)as DailyService, GroupType
FROM            BillGroup where BillGroupId=@BillGroupId
END
GO

ALTER PROCEDURE [dbo].[Sp_LabServiceDetails]        
@PatRegId int=0,         
@BillGroup nvarchar(50),        
@BillServiceId int=0,        
@BillServiceCharges float=0,        
@TotalCharges float=0,        
@Qty float=0,        
@DrId int=0,        
@FId int=0,        
@BillNo int=0,        
@BranchId int=0,        
@ProcedureId int=0,        
@CreatedBy nvarchar(50)='' ,        
@OPDNo int=0,        
@ReceiptNo int=0,        
@LabNo int=0,        
@MTCode nvarchar(4000)='',        
        
@Initial nvarchar(50)='',        
@PatientName nvarchar(500)='',        
@Age nvarchar(50)='',        
@RefDoc nvarchar(250)='',        
@TestName nvarchar(4000)='',        
@TestRate nvarchar(50)='',        
@MobileNo nvarchar(50)='',        
@MDY nvarchar(50)='',        
@Sex nvarchar(50)='',        
@ReferBy nvarchar(250)='',        
@IPDNO int=0,        
@ReferPhy nvarchar(250)=null,        
@OtherRefDoc nvarchar(250)=null,        
@MainDocId int=0,        
@InsuranceId int=0,        
@InsuranceAmt float=0,        
@PaidAmt float=0,        
@BalanceAmt float=0,        
@DiscountAmt float=0,        
@ModeOfPay nvarchar(50)='',        
@LabPtype nvarchar(50)='',        
@PatAddress nvarchar (550)='',        
@PatBirthDate Datetime =null,        
@RepType nvarchar(250)='',        
@Email nvarchar(550)='',        
@ClinicalHistory nvarchar(2250)=''        
        
AS        
BEGIN        
        
declare @Centercode nvarchar(250)        
if(@LabPtype='P')        
begin        
select top(1) @Centercode=DoctorCode from Pathology.dbo.DrMT where DoctorCode='OPD' and DrType='CC' and Mainflag=1        
end        
if(@LabPtype='R')        
begin        
select top(1) @Centercode=DoctorCode from Radiology.dbo.DrMT where DoctorCode='OPD' and DrType='CC' and Mainflag=1        
end        
if(@LabPtype='M')        
begin        
select top(1) @Centercode=DoctorCode from Laboratory.dbo.DrMT where DoctorCode='OPD' and DrType='CC' and Mainflag=1        
end        
 -- SET NOCOUNT ON added to prevent extra result sets from        
 -- interfering with SELECT statements.        
 SET NOCOUNT ON;        
         
 declare @HEntrydate datetime=null        
 select top(1) @HEntrydate=Entrydate from LabEMRRegistration where PatRegId=@PatRegId order by ID desc        
        
  if(@InsuranceId>0)    
  begin    
  if(exists( select Id from ChargeBill_Master where Patregid=@PatRegId  and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)))        
   begin       
   declare @ChargeId int      
   select @ChargeId=Id from ChargeBill_Master where Patregid=@PatRegId  and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)      
   insert into ChargeBill_Details(PatRegId,ChargeId, BillServiceId, MTCode, DrugId, DrId, Charges,Qty, CreatedBy,  CancelBill,BillGroupName,BillNo)      
   values(@PatRegId,@ChargeId,@BillServiceId,@MTCode,0,@DrId,@BillServiceCharges,@Qty,@CreatedBy,0,@LabPtype,@BillNo)      
  end    
   end      
      
if(@LabPtype='P')        
begin        
insert into LabServiceDetails (PatRegId,BillGroup,BillServiceId,Qty,BillServiceCharges,TotalCharges,DrId,FId,BillNo,BranchId,CreatedBy,CreatedOn,ProcedureId,OPDNo,ReceiptNo,LabNo,MTCode,ServiceName,IPDNO,ClinicalHistory) values        
(@PatRegId,19,@BillServiceId,@Qty,@BillServiceCharges,@TotalCharges,@DrId,@FId,@BillNo,@BranchId,@CreatedBy,getdate(),@ProcedureId,@OPDNo,@ReceiptNo,@LabNo,@MTCode,@TestName,@IPDNO,@ClinicalHistory)        
        
insert into Pathology.dbo.PatientInformation_MediPro(exam_date,DateOfEntry,Intial,FirstName,Age,Sex,RefDoc,mtcode,TestName,TestRate,Coll_Center,Coll_Code,MobileNo,LabRegistrationNo,ReceivedAmt,BalanceAmt,VatAmt,DisAmt,ModeOfPayment,Pusername,PPassWord,   
  
    
     
MDY,invno,IPDNO,BillAmount,ReferPhy,OtherRefDoc,MainDrID,InsuranceId,InsuranceAmt,UserName,PatAddress,PatBirthDate,RepType,Email,ClinicalHistory,HMSEntryDate)        
values(getdate(),getdate(),ltrim(@Initial),@PatientName,@Age,LTRIM(@Sex),@ReferBy,@MTCode,@TestName,@TestRate,@Centercode,@Centercode,@MobileNo,@PatRegId,@PaidAmt,@BalanceAmt,0,@DiscountAmt,@ModeOfPay,'','',ltrim(@MDY),@LabNo,@IPDNO,@TotalCharges,@ReferPhy,@OtherRefDoc,@MainDocId,@InsuranceId,@InsuranceAmt,@CreatedBy,@PatAddress,@PatBirthDate,@RepType,@Email,@ClinicalHistory,@HEntrydate)        
end        
if(@LabPtype='R')        
begin        
insert into LabServiceDetails (PatRegId,BillGroup,BillServiceId,Qty,BillServiceCharges,TotalCharges,DrId,FId,BillNo,BranchId,CreatedBy,CreatedOn,ProcedureId,OPDNo,ReceiptNo,LabNo,MTCode,ServiceName,IPDNO,ClinicalHistory) values        
(@PatRegId,20,@BillServiceId,@Qty,@BillServiceCharges,@TotalCharges,@DrId,@FId,@BillNo,@BranchId,@CreatedBy,getdate(),@ProcedureId,@OPDNo,@ReceiptNo,@LabNo,@MTCode,@TestName,@IPDNO,@ClinicalHistory)        
        
declare @MainCategoryId int        
SELECT     @MainCategoryId=   LabRegistration.PatientMainCategoryId        
FROM  LabRegistration INNER JOIN        
LabServiceDetails ON LabRegistration.PatRegId = LabServiceDetails.PatRegId AND LabRegistration.LabNo = LabServiceDetails.LabNo         
where LabRegistration.PatRegId=@PatRegId and LabRegistration.labNo=@LabNo        
if(@MainCategoryId=3)        
begin        
insert into Radiology.dbo.PatientInformation_MediPro(exam_date,DateOfEntry,Intial,FirstName,Age,Sex,RefDoc,mtcode,TestName,TestRate,Coll_Center,Coll_Code,MobileNo,LabRegistrationNo,ReceivedAmt,BalanceAmt,VatAmt,DisAmt,ModeOfPayment,Pusername,PPassWord,   
  
    
     
MDY,invno,IPDNO,BillAmount,ReferPhy,OtherRefDoc,MainDrID,InsuranceId,InsuranceAmt,UserName,PatAddress,PatBirthDate,RepType,Email,ClinicalHistory,HMSEntryDate)        
values(getdate(),getdate(),ltrim(@Initial),@PatientName,@Age,LTRIM(@Sex),@ReferBy,@MTCode,@TestName,@TestRate,@Centercode,@Centercode,@MobileNo,@PatRegId,@PaidAmt,@BalanceAmt,0,@DiscountAmt,@ModeOfPay,'','',ltrim(@MDY),@LabNo,@IPDNO,@TotalCharges,@ReferPhy,@OtherRefDoc,@MainDocId,@InsuranceId,@InsuranceAmt,@CreatedBy,@PatAddress,@PatBirthDate,@RepType,@Email,@ClinicalHistory,@HEntrydate)        
        
end        
else        
begin        
insert into Radiology.dbo.PatientInformation_MediPro_Temp(exam_date,DateOfEntry,Intial,FirstName,Age,Sex,RefDoc,mtcode,TestName,TestRate,Coll_Center,Coll_Code,MobileNo,LabRegistrationNo,ReceivedAmt,BalanceAmt,VatAmt,DisAmt,ModeOfPayment,Pusername,PPassWord,        
MDY,invno,IPDNO,BillAmount,ReferPhy,OtherRefDoc,MainDrID,InsuranceId,InsuranceAmt,UserName,PatAddress,PatBirthDate,RepType,Email,ClinicalHistory,HMSEntryDate)        
values(getdate(),getdate(),ltrim(@Initial),@PatientName,@Age,LTRIM(@Sex),@ReferBy,@MTCode,@TestName,@TestRate,@Centercode,@Centercode,@MobileNo,@PatRegId,@PaidAmt,@BalanceAmt,0,@DiscountAmt,@ModeOfPay,'','',ltrim(@MDY),@LabNo,@IPDNO,@TotalCharges,@ReferPhy,@OtherRefDoc,@MainDocId,@InsuranceId,@InsuranceAmt,@CreatedBy,@PatAddress,@PatBirthDate,@RepType,@Email,@ClinicalHistory,@HEntrydate)        
end        
end        
if(@LabPtype='M')        
begin        
insert into LabServiceDetails (PatRegId,BillGroup,BillServiceId,Qty,BillServiceCharges,TotalCharges,DrId,FId,BillNo,BranchId,CreatedBy,CreatedOn,ProcedureId,OPDNo,ReceiptNo,LabNo,MTCode,ServiceName,IPDNO,ClinicalHistory) values        
(@PatRegId,16,@BillServiceId,@Qty,@BillServiceCharges,@TotalCharges,@DrId,@FId,@BillNo,@BranchId,@CreatedBy,getdate(),@ProcedureId,@OPDNo,@ReceiptNo,@LabNo,@MTCode,@TestName,@IPDNO,@ClinicalHistory)        
        
insert into Laboratory.dbo.PatientInformation_MediPro(exam_date,DateOfEntry,Intial,FirstName,Age,Sex,RefDoc,mtcode,TestName,TestRate,Coll_Center,Coll_Code,MobileNo,LabRegistrationNo,ReceivedAmt,BalanceAmt,VatAmt,DisAmt,ModeOfPayment,Pusername,PPassWord,  
  
    
      
MDY,invno,IPDNO,BillAmount,ReferPhy,OtherRefDoc,MainDrID,InsuranceId,InsuranceAmt,UserName,PatAddress,PatBirthDate,RepType,Email,ClinicalHistory,HMSEntryDate)        
values(getdate(),getdate(),ltrim(@Initial),@PatientName,@Age,LTRIM(@Sex),@ReferBy,@MTCode,@TestName,@TestRate,@Centercode,@Centercode,@MobileNo,@PatRegId,@PaidAmt,@BalanceAmt,0,@DiscountAmt,@ModeOfPay,'','',ltrim(@MDY),@LabNo,@IPDNO,@TotalCharges,@ReferPhy,@OtherRefDoc,@MainDocId,@InsuranceId,@InsuranceAmt,@CreatedBy,@PatAddress,@PatBirthDate,@RepType,@Email,@ClinicalHistory,@HEntrydate)        
end        
select '1Record Saved SuccessFully'        
         
END
GO

ALTER PROCEDURE [dbo].[Sp_LabTestDelete]  
@ProcedureServiceId int,  
@LabNo int=0,  
@Patregid int=0,  
@Branchid int=0,  
@CancelBy nvarchar(250)=null,  
@CancelRemark nvarchar(550)=null  
AS  
  
BEGIN  
  
declare @LabPtype nvarchar(60)  
declare @BillServiceCharges float  
declare @PID int  
declare @PCount int=0  
declare @ChargeId int
--select top(1) @MTCode=MTCode,@BillServiceCharges=BillServiceCharges from LabServiceDetails where ProcedureServiceId=@ProcedureServiceId and LabNo=@LabNo  
  
  
select top(1) @LabPtype=LabPtype from LabRegistration where labno=@LabNo and Patregid=@Patregid  
  
if(@LabPtype='P')  
begin  
select top(1) @PID=PID from Pathology.dbo.patmst where labregMediPro=@LabNo order by pid desc  
select @PCount=count(PID) from Pathology.dbo.patmstd where PID=@PID and Patauthicante='Registered'  
if(@PCount>0)  
begin  
update Pathology.dbo.patmst set isactive=0 where PID=@PID  
update Pathology.dbo.patmstd set isactive=0 where PID=@PID  
--update Pathology.dbo.Cshmst set isactive=0 where PID=@PID  
update Pathology.dbo.RecM set isactive=0 where PID=@PID  
update LabRegistration set cancelBill=1,CancelBy=@CancelBy,CancelRemark=@CancelRemark,CancelOn=getdate() where labno=@LabNo and Patregid=@Patregid  

select distinct @ChargeId=ChargeId from ChargeBill_Details where  PatRegId=@PatRegId and BillNo=@LabNo 

update ChargeBill_Master set BillAmt=0,InsuranceAmt=0 where Patregid=@PatRegId and ID=@ChargeId

update ChargeBill_Details set Charges=0,CancelBill=1 where Patregid=@PatRegId and BillNo=@LabNo

end  
end  
if(@LabPtype='R')  
begin  
select top(1) @PID=PID from Radiology.dbo.patmst where labregMediPro=@LabNo order by pid desc  
select @PCount=count(PID) from Radiology.dbo.patmstd where PID=@PID and Patauthicante='Registered'  
if(@PCount>0)  
begin  
update Radiology.dbo.patmst set isactive=0 where PID=@PID  
update Radiology.dbo.patmstd set isactive=0 where PID=@PID  
--update Radiology.dbo.Cshmst set isactive=0 where PID=@PID  
update Radiology.dbo.RecM set isactive=0 where PID=@PID  
update LabRegistration set cancelBill=1,CancelBy=@CancelBy,CancelRemark=@CancelRemark,CancelOn=getdate() where labno=@LabNo and Patregid=@Patregid  


select distinct @ChargeId=ChargeId from ChargeBill_Details where  PatRegId=@PatRegId and BillNo=@LabNo 

update ChargeBill_Master set BillAmt=0,InsuranceAmt=0 where Patregid=@PatRegId and ID=@ChargeId

update ChargeBill_Details set Charges=0,CancelBill=1 where Patregid=@PatRegId and BillNo=@LabNo
end  
end  
if(@LabPtype='M')  
begin  
select top(1) @PID=PID from Laboratory.dbo.patmst where labregMediPro=@LabNo order by pid desc  
select @PCount=count(PID) from Laboratory.dbo.patmstd where PID=@PID and Patauthicante='Registered'  
if(@PCount>0)  
begin  
update Laboratory.dbo.patmst set isactive=0 where PID=@PID  
update Laboratory.dbo.patmstd set isactive=0 where PID=@PID  
--update Laboratory.dbo.Cshmst set isactive=0 where PID=@PID  
update Laboratory.dbo.RecM set isactive=0 where PID=@PID  
update LabRegistration set cancelBill=1,CancelBy=@CancelBy,CancelRemark=@CancelRemark,CancelOn=getdate() where labno=@LabNo and Patregid=@Patregid  


select distinct @ChargeId=ChargeId from ChargeBill_Details where  PatRegId=@PatRegId and BillNo=@LabNo 

update ChargeBill_Master set BillAmt=0,InsuranceAmt=0 where Patregid=@PatRegId and ID=@ChargeId

update ChargeBill_Details set Charges=0,CancelBill=1 where Patregid=@PatRegId and BillNo=@LabNo
end  
  
end  
  
--select top(1) @PID=PID from Ambulancelab.dbo.patmst where labregMediPro=@LabNo order by pid desc  
--Delete from Ambulancelab.dbo.patmstd WHERE  PID=@PID and MTCode=@MTCode   
----Delete from LabServiceDetails WHERE  ProcedureServiceId=@ProcedureServiceId  
--update LabServiceDetails set  CancelBill=1 WHERE  ProcedureServiceId=@ProcedureServiceId  
  
  
SELECT '1Record Deleted Successfuly'  
  
END
GO

CREATE PROCEDURE [dbo].[Sp_PatientDr_Update]  
  
@DrId int=0,  
@OPDNo int=0,  
@DeptId int=0,  
@Patregid int=0,  
@ProcedureID int  
as  
  
update OpdRegistration set DrId=@DrId,DeptId=@DeptId where Patregid=@Patregid and OpdNo=@OPDNo  
  
update ProcedureServiceDetails set DrId=@DrId where Patregid=@Patregid and ProcedureId=@ProcedureID
GO

ALTER PROCEDURE [dbo].[SP_PatientInfo_Update]
@PatientInfoId int,
--@BarcodeId varchar(20),
@TitleId int ,
@FirstName varchar(500),
@MiddleName varchar(500)=null,
@LastName varchar(500)=null,
@PatMainTypeId int=0,
@PatientInsuTypeId int=0,
@PolicyNo varchar(50)=null,
@GenderId int,
@BirthDate datetime=null,
@IsConfirmBirthDate bit=null,
@BloodGroup varchar(22)=null,
@MaritalStatus varchar(22)=null,
@GuardianTitleId int=0,
@GuardianName varchar(250)=null,
@MobileNo varchar(22)=null,
@PhoneNo varchar(22)=null,
@PatientAddress varchar(550)=null,
@CountryId int=0,
@StateId int=0,
@CityId int=0,
@Email varchar(150)=null,
--@EntryDate datetime=null ,
@ImagePath varchar(250)=null,
@CancelReason varchar(200)=null,
@UpdatedBy varchar(50),
@Age varchar(30)=null,
@AgeType nvarchar(50)=null,
@BirthPlace nvarchar(250)=null,
@Nationality nvarchar(250)=null,
@RaceId int=0,
@ReligionId int=0,
@HealthCardNo nvarchar(50)=null,
@PassportNo nvarchar(50)=null,
@VaccinationStatus nvarchar(250)=null,
@Allergy nvarchar(550)=null,
@ChiefComplant nvarchar(550)=null,

@Relation int=0,
@RelativeName nvarchar(550)='',
@ContactNo nvarchar(50)='',
@RelaAddress nvarchar(550)='',

@Relation1 int=0,
@RelativeName1 nvarchar(550)='',
@ContactNo1 nvarchar(50)='',
@RelaAddress1 nvarchar(550)=''
AS
BEGIN
IF not exists (SELECT FirstName+' '+MiddleName+' '+LastName AS PatientName  
				FROM  PatientInformation 
				WHERE (FirstName+' '+MiddleName+' '+LastName)=(@FirstName+' '+@MiddleName+' '+@LastName) and PatientInfoId<>@PatientInfoId ) 
BEGIN
UPDATE PatientInformation SET TitleId=@TitleId,FirstName=@FirstName,
	MiddleName=@MiddleName,LastName=@LastName,PatMainTypeId=@PatMainTypeId,
	PatientInsuTypeId=@PatientInsuTypeId,PolicyNo=@PolicyNo,GenderId=@GenderId,BirthDate=@BirthDate,
	IsConfirmBirthDate=@IsConfirmBirthDate,BloodGroup=@BloodGroup,MaritalStatus=@MaritalStatus,
	GuardianTitleId=@GuardianTitleId,GuardianName=@GuardianName,MobileNo=@MobileNo,PhoneNo=@PhoneNo,
	PatientAddress=@PatientAddress,CountryId=@CountryId,StateId=@StateId,CityId=@CityId,
	 Email=@Email,ImagePath=@ImagePath,
	CancelReason=@CancelReason,UpdatedBy=@UpdatedBy,UpdatedOn=getdate(),Age=@Age,AgeType=@AgeType,
	BirthPlace=@BirthPlace,Nationality=@Nationality,RaceId=@RaceId,ReligionId=@ReligionId,HealthCardNo=@HealthCardNo,PassportNo=@PassportNo
	,VaccinationStatus=@VaccinationStatus,ChiefComplant=@ChiefComplant,Allergy=@Allergy
	,Relation=@Relation,RelativeName=@RelativeName,ContactNo=@ContactNo,RelaAddress=@RelaAddress,
	Relation1=@Relation1,RelativeName1=@RelativeName1,ContactNo1=@ContactNo1,RelaAddress1=@RelaAddress1
WHERE PatientInfoId=@PatientInfoId 
SELECT '1Record Updated Sucessfully'
END
ELSE
BEGIN
SELECT '0Patient Name Already Exists'
END
END
GO

ALTER PROCEDURE [dbo].[Sp_PatientInfoInsert]
@PatientInfoId int=0 output,
@PatRegId varchar(20) ,
@BarcodeId varchar(20),
@TitleId int ,
@FirstName varchar(500)=null,
@MiddleName varchar(500)=null,
@LastName varchar(500)=null,
@PatMainTypeId int=0,
@PatientInsuTypeId int=0,
@PolicyNo varchar(50)=null,
@GenderId int=0 ,
@BirthDate datetime=null ,
@Age varchar(20)=null,
@AgeType varchar(20)=null,
@IsConfirmBirthDate bit ,
@BloodGroup Varchar(20)=null,
@MaritalStatus Varchar(20)=null,
@GuardianTitleId int=0 ,
@GuardianName varchar(250)=null,
@MobileNo varchar(22)=null ,
@PhoneNo varchar(22)=null ,
@PatientAddress varchar(550)=null ,
@CountryId int=0 ,
@StateId int=0 ,
@CityId int=0 ,
@Email varchar(150)=null ,
--@EntryDate datetime ,
@ImagePath varchar(250),
@CancelReason varchar(200)=null,
@CreatedBy varchar(22)=null,
@FId int=null,
@BranchId int= null,
@BirthPlace nvarchar(250)=null,
@Nationality nvarchar(250)=null,
@RaceId int=0,
@ReligionId int=0,
@HealthCardNo nvarchar(50)=null,
@PassportNo nvarchar(50)=null,
@VaccinationStatus nvarchar(50)=null,
@Allergy nvarchar(550)=null,
@ChiefComplant nvarchar(550)=null,
@Relation int=0,
@RelativeName nvarchar(550)='',
@ContactNo nvarchar(50)='',
@RelaAddress nvarchar(550)='',

@Relation1 int=0,
@RelativeName1 nvarchar(550)='',
@ContactNo1 nvarchar(50)='',
@RelaAddress1 nvarchar(550)=''
AS
BEGIN
--IF not exists (SELECT FirstName AS PatientName  FROM  PatientInformation  WHERE (FirstName=@FirstName)) 

--BEGIN
if(@CountryId=0)
begin
set @CountryId=(SELECT countryId FROM  CountryMst where IsDefault=1)
set @StateId=(SELECT StateId  FROM  StateMst where IsDefault=1 and CountryId=@CountryId)
set @CityId=(Select CityId from CityMst where IsDefault=1 and stateId=@StateId)
end
INSERT INTO PatientInformation( PatRegId, BarcodeId, TitleId, FirstName, MiddleName, LastName, PatMainTypeId, PatientInsuTypeId, PolicyNo, GenderId, BirthDate, IsConfirmBirthDate, BloodGroup, MaritalStatus, GuardianTitleId, GuardianName, 
                         MobileNo, PhoneNo, PatientAddress, CountryId, StateId, CityId, Email, EntryDate, ImagePath, CancelReason, IsActive, CreatedBy, CreatedOn, UpdatedBy, UpdatedOn, Age, AgeType, BranchId, FId, Nationality, BirthPlace, RaceId, 
                         ReligionId, HealthCardNo, PassportNo, VaccinationStatus, Allergy, ChiefComplant,Relation,RelativeName,ContactNo,RelaAddress,Relation1,RelativeName1,ContactNo1,RelaAddress1)
 VALUES(@PatRegId,@BarcodeId,@TitleId,@FirstName,@MiddleName,@LastName,@PatMainTypeId,@PatientInsuTypeId,@PolicyNo,@GenderId,@BirthDate,@IsConfirmBirthDate,@BloodGroup,@MaritalStatus,
@GuardianTitleId,@GuardianName,@MobileNo,@PhoneNo,@PatientAddress,@CountryId,@StateId,@CityId,	@Email,getdate(),@ImagePath,@CancelReason,1,@CreatedBy,getdate(),@CreatedBy,
getdate(),@Age,@AgeType,@BranchId,@FId,@BirthPlace,@Nationality,@RaceId,@ReligionId,@HealthCardNo,@PassportNo,@VaccinationStatus,@Allergy,@ChiefComplant,@Relation,@RelativeName,@ContactNo,@RelaAddress,@Relation1,@RelativeName1,@ContactNo1,@RelaAddress1)

	select @PatientInfoId=@@identity
	SELECT '1Record Inserted Successfully'
	
--END
--ELSE
--BEGIN
	--SELECT '0Patient Name Already Exists'
--END
END
GO

ALTER PROCEDURE [dbo].[Sp_PatientInfoSelectOne]  
@PatientInfoId int  
AS  
BEGIN  
SELECT        ISNULL(PatientInformation.PatientInfoId, '') AS PatientInfoId, ISNULL(PatientInformation.PatRegId, '') AS PatRegId, ISNULL(PatientInformation.BarcodeId, '') AS BarcodeId, ISNULL(PatientInformation.TitleId, 0) AS TitleId, 
                         ISNULL(Initial.Title, '') AS Title, ISNULL(PatientInformation.FirstName, '') AS FirstName, ISNULL(PatientInformation.MiddleName, '') AS MiddleName, ISNULL(PatientInformation.LastName, '') AS LastName, ISNULL(Initial.Title, '') 
                         + ' ' + ISNULL(PatientInformation.FirstName, '') + ' ' + ISNULL(PatientInformation.MiddleName, '') + ' ' + ISNULL(PatientInformation.LastName, '') AS PatientName, ISNULL(PatientInformation.PatMainTypeId, 0) AS PatMainTypeId, 
                         ISNULL(PatMainType.PatMainType, '') AS PatMainType, ISNULL(PatientInformation.PatientInsuTypeId, 0) AS PatientInsuTypeId, ISNULL(PatientInsuType.PatientInsuType, '') AS PatientInsuType, 
                         ISNULL(PatientInformation.PolicyNo, '') AS PolicyNo, ISNULL(PatientInformation.GenderId, 0) AS GenderId, ISNULL(Gender.GenderName, '') AS GenderName, ISNULL(CONVERT(varchar(10), PatientInformation.BirthDate, 103), '') 
                         AS BirthDate, ISNULL(PatientInformation.IsConfirmBirthDate, '') AS IsConfirmBirthDate, ISNULL(PatientInformation.BloodGroup, '') AS BloodGroup, ISNULL(PatientInformation.MaritalStatus, '') AS MaritalStatus, 
                         ISNULL(PatientInformation.GuardianTitleId, 0) AS GuardianTitleId, ISNULL(PatientInformation.GuardianName, '') AS GuardianName, ISNULL(PatientInformation.MobileNo, '') AS MobileNo, ISNULL(PatientInformation.PhoneNo, '') 
                         AS PhoneNo, ISNULL(PatientInformation.PatientAddress, '') AS PatientAddress, ISNULL(PatientInformation.CountryId, 0) AS CountryId, ISNULL(CountryMst.CountryName, '') AS CountryName, ISNULL(PatientInformation.StateId, 0) 
                         AS StateId, ISNULL(S.StateName, '') AS StateName, ISNULL(PatientInformation.CityId, 0) AS CityId, ISNULL(CityMst.CityName, '') AS CityName, ISNULL(PatientInformation.Email, '') AS Email, ISNULL(PatientInformation.EntryDate, 
                         '') AS EntryDate, ISNULL(PatientInformation.ImagePath, '') AS ImagePath, ISNULL(PatientInformation.IsActive, '') AS IsActive, ISNULL(PatientInformation.CreatedBy, '') AS CreatedBy, ISNULL(PatientInformation.CreatedOn, '') 
                         AS CreatedOn, ISNULL(PatientInformation.UpdatedBy, '') AS UpdatedBy, ISNULL(PatientInformation.UpdatedOn, '') AS UpdatedOn, ISNULL(PatientInformation.BirthPlace, '') AS BirthPlace, ISNULL(PatientInformation.Nationality, '') 
                         AS Nationality, ISNULL(PatientInformation.VaccinationStatus, '') AS VaccinationStatus, ISNULL(PatientInformation.Allergy, '') AS Allergy, ISNULL(PatientInformation.ChiefComplant, '') AS ChiefComplant, PatientInformation.Relation, 
                         PatientInformation.RelativeName, PatientInformation.ContactNo, PatientInformation.RelaAddress, PatientInformation.Relation1, PatientInformation.RelativeName1, PatientInformation.ContactNo1, 
                         PatientInformation.RelaAddress1, PatientInformation.RaceId, PatientInformation.ReligionId, PatientInformation.HealthCardNo, PatientInformation.PassportNo, dbo.FnGetAge(@PatientInfoId) AS Age
FROM            PatientInformation LEFT OUTER JOIN
                         Initial ON Initial.TitleId = PatientInformation.TitleId LEFT OUTER JOIN
                         PatMainType ON PatMainType.PatMainTypeId = PatientInformation.PatMainTypeId LEFT OUTER JOIN
                         PatientInsuType ON PatientInsuType.PatientInsuTypeId = PatientInformation.PatientInsuTypeId LEFT OUTER JOIN
                         Gender ON Gender.GenderId = PatientInformation.GenderId LEFT OUTER JOIN
                         CountryMst ON CountryMst.CountryId = PatientInformation.CountryId LEFT OUTER JOIN
                         StateMst AS S ON S.StateId = PatientInformation.StateId LEFT OUTER JOIN
                         CityMst ON CityMst.CityId = PatientInformation.CityId
WHERE        (PatientInformation.PatientInfoId = @PatientInfoId) AND (PatientInformation.IsActive = 1)
END
GO

CREATE PROCEDURE [dbo].[Sp_PatientInsuranceDetailsForInvoice_OPD]  
 @InvoiceNo int,  
 @Sponser int,  
 @FId int,  
 @BranchId int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
 declare @Sql nvarchar(3000)  
  
set @Sql='alter view Vw_PatientInsuranceDetailsForInvoice_ForOPD as(SELECT        PatientInvoiceDetails_ForOPD.InvoiceNo, PatientInvoiceDetails_ForOPD.PatRegId, PatientInvoiceDetails_ForOPD.InsuranceAmount, PatientInvoiceDetails_ForOPD.Sponser, PatientInvoiceDetails_ForOPD.TransactionDate, 
                         PatientInvoiceDetails_ForOPD.FId, PatientInvoiceDetails_ForOPD.BranchId, PatientInvoiceDetails_ForOPD.ChargeNo, PatientInsuType.PatientInsuType, PatientInformation.FirstName as PatientName
FROM            PatientInsuType RIGHT OUTER JOIN
                         PatientInvoiceDetails_ForOPD LEFT OUTER JOIN
                         PatientInformation ON PatientInvoiceDetails_ForOPD.PatRegId = PatientInformation.PatRegId ON PatientInsuType.PatientInsuTypeId = PatientInvoiceDetails_ForOPD.Sponser) where  
      PatientInvoiceDetails_ForOPD.FId='''+ convert(varchar(10),@FId)+''' and PatientInvoiceDetails_ForOPD.BranchId='''+ convert(varchar(10),@BranchId)+'''  
     and dbo.PatientInvoiceDetails_ForOPD.InvoiceNo ='''+ convert(varchar(10),@InvoiceNo)+''' and PatientInvoiceDetails_ForOPD.Sponser='''+ convert(varchar(10),@Sponser)+''''  
  
  
     Execute (@Sql +')')  
END
GO

CREATE PROCEDURE [dbo].[Sp_PatInsuSub_Type]

@Id int
AS

BEGIN

SELECT * FROM PatientInsu_SubType WHERE  ID=@Id

END
GO

CREATE PROCEDURE [dbo].[Sp_PatInsuTypeChargeFillCombo_Bind]
@PatientInsuTypeId int,
@Search nvarchar(50)=''
AS
BEGIN

SELECT 
CONVERT(varchar(150), Id) + ' - ' + ChildCompanyName as CompanyName
FROM    PatientInsu_SubType
where PatientInsuTypeId=@PatientInsuTypeId and (ChildCompanyName like '%'+@Search+'%') order by id asc

END
GO

ALTER PROCEDURE [dbo].[Sp_PatInsuTypeFillCombo]
@PatMainTypeId int
AS
BEGIN
if(@PatMainTypeId <> 0)
Begin
--SELECT '0' as PatientInsuTypeId,'Select Patient Sub Type' AS PatientInsuType FROM PatientInsuType Union
SELECT PatientInsuType.PatientInsuTypeId, PatientInsuType.PatientInsuType
FROM    PatientInsuType INNER JOIN
                 PatMainType ON PatientInsuType.PatMainTypeId = PatMainType.PatMainTypeId
where PatientInsuType.PatMainTypeId=@PatMainTypeId order by PatientInsuType.OrderNo asc
end
else
Begin
--SELECT '0' as PatientInsuTypeId,'Select Patient Sub Type' AS PatientInsuType FROM PatientInsuType Union
SELECT     PatientInsuType.PatientInsuTypeId, PatientInsuType.PatientInsuType
FROM   PatientInsuType INNER JOIN
PatMainType ON PatientInsuType.PatMainTypeId = PatMainType.PatMainTypeId AND PatientInsuType.BranchId = PatMainType.BranchId order by PatientInsuType.OrderNo asc
end

END
GO

CREATE PROCEDURE [dbo].[Sp_PatInsuTypeFillCombo_Bind]
@PatMainTypeId int,
@Search nvarchar(50)=''
AS
BEGIN
if(@PatMainTypeId <> 0)
Begin
--SELECT '0' as PatientInsuTypeId,'Select Patient Sub Type' AS PatientInsuType FROM PatientInsuType Union
SELECT 
CONVERT(varchar(150), PatientInsuType.PatientInsuTypeId) + ' - ' + PatientInsuType.PatientInsuType as CompanyName
FROM    PatientInsuType INNER JOIN
                 PatMainType ON PatientInsuType.PatMainTypeId = PatMainType.PatMainTypeId
where PatientInsuType.PatMainTypeId=@PatMainTypeId and (PatientInsuType.PatientInsuType like '%'+@Search+'%') order by PatientInsuType.OrderNo asc
end
else
Begin
--SELECT '0' as PatientInsuTypeId,'Select Patient Sub Type' AS PatientInsuType FROM PatientInsuType Union
SELECT     CONVERT(varchar(150), PatientInsuType.PatientInsuTypeId) + ' - ' + PatientInsuType.PatientInsuType as CompanyName
FROM   PatientInsuType INNER JOIN
PatMainType ON PatientInsuType.PatMainTypeId = PatMainType.PatMainTypeId AND PatientInsuType.BranchId = PatMainType.BranchId 
where (PatientInsuType.PatientInsuType like '%'+@Search+'%') order by PatientInsuType.OrderNo asc
end

END
GO

ALTER PROCEDURE [dbo].[SP_phrtroll]

@Usertypeid int=0,
@FormId int=0,
@FormName nvarchar(50)=null,
@Branchid int=0,
@ModuleName nvarchar(250)
as

if exists(select Rightid from Roleright where Usertypeid=@Usertypeid and Branchid=@Branchid and FormId=@FormId and ModuleName=@ModuleName)
begin
delete from Roleright where Usertypeid=@Usertypeid and Branchid=@Branchid and FormId=@FormId and ModuleName=@ModuleName
end
insert into Roleright(Usertypeid, FormId,FormName,Branchid,ModuleName)
values(@Usertypeid, @FormId,@FormName,@Branchid,@ModuleName)
GO

ALTER PROCEDURE [dbo].[Sp_ProcedureServiceDetails]        
@PatRegId int=0,         
@BillGroup nvarchar(50),        
@BillServiceId int=0,        
@BillServiceCharges float=0,        
@TotalCharges float=0,        
@Qty float=0,        
@DrId int=0,        
@FId int=0,        
@BillNo int=0,        
@BranchId int=0,        
@ProcedureId int=0,        
@CreatedBy nvarchar(50)='' ,    
@PatMainTypeId int=0    
AS        
BEGIN        
 -- SET NOCOUNT ON added to prevent extra result sets from        
 -- interfering with SELECT statements.        
 SET NOCOUNT ON;        
  if(@PatMainTypeId>1)    
  begin    
  if(exists( select Id from ChargeBill_Master where Patregid=@PatRegId  and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)))        
   begin       
   declare @ChargeId int      
   select @ChargeId=Id from ChargeBill_Master where Patregid=@PatRegId  and CAST(CAST(YEAR(Createdon) AS varchar(4)) + '/' + CAST(MONTH(Createdon) AS varchar(2)) + '/' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)      
   insert into ChargeBill_Details(PatRegId,ChargeId, BillServiceId, MTCode, DrugId, DrId, Charges,Qty, CreatedBy,  CancelBill,BillGroupName,BillNo)      
   values(@PatRegId,@ChargeId,@BillServiceId,'0',0,@DrId,@BillServiceCharges,@Qty,@CreatedBy,0,@BillGroup,@BillNo)      
  end    
   end      
insert into ProcedureServiceDetails (PatRegId,BillGroup,BillServiceId,Qty,BillServiceCharges,        
TotalCharges,DrId,FId,BillNo,BranchId,CreatedBy,CreatedOn,ProcedureId) values        
(@PatRegId,@BillGroup,@BillServiceId,@Qty,@BillServiceCharges,        
@TotalCharges,@DrId,@FId,@BillNo,@BranchId,@CreatedBy,getdate(),@ProcedureId)        
        
select '1Record Saved SuccessFully'        
         
END
GO

ALTER PROCEDURE [dbo].[SP_ReAdmitDischargePAtient]
@Patregid int,
@Ipdno int,
@BranchId int,
@ReadmitBy nvarchar(250)=''
as


update IpdRegistration set IsAdmited=1,ReAdmitedby=@ReadmitBy ,ReAdmitedOn=getdate() where patregid=@Patregid and Ipdno=@Ipdno
update ipdbillmaster set IsDischarge=0,FinalDischargeBy=null,FinalDischargeOn=null where patregid=@Patregid and Ipdno=@Ipdno
update Alloctnofbed set patstatus='Admitted',DateOfDischarge=null,DischargedBy=null,DischargeTime=null,ReasonforDischarge=null  where patregid=@Patregid and Ipdno=@Ipdno and patstatus='Discharged'
GO

CREATE PROCEDURE [dbo].[Sp_SelectPatientInvoiceDatails_OPD]  
 -- Add the parameters for the stored procedure here  
 --@InvoiceNo int,  
 @FromDate varchar(20) =null,  
 @ToDate varchar(20) =null,  
 @FId int,  
 @BranchId int,  
 @InsuranceCompId int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  
    -- Insert statements for procedure here  
 --insert into PatientInvoiceDetails (InvoiceNo,PatRegId,InsuranceAmount,IpdNo,Sponser,FId,BranchId,TransactionDate)  
--Select @InvoiceNo,PatRegId,Sponsor1Amt,IpdNo,Sponsor1,@FId,@BranchId,getdate() From Vw_InsuranceBillAmountTotal where IsDischarge=1 and SponsorStatus='Accept'  
--and  Sponsor1=@InsuranceCompId and   CONVERT(date, FinalDischargeOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''  
Select * From ChargeBill_Master where GenerateInvoice=0 and CancelBill=0 
and  InsuranceCompId=@InsuranceCompId and   CONVERT(date, CreatedOn)  between ''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + '' and '' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + ''  
  
END
GO

CREATE PROCEDURE [dbo].[SP_Update_RadiologyLabRegistration]

@Patregid int,
@LabNo int,
@BillNo int=0,
@BranchId int=0,
@PatMainTypeId int=0,
@PatientInsuTypeId int=0
as

update LabRegistration set PatientMainCategoryId=@PatMainTypeId,PatientSubCategoryId=@PatientInsuTypeId where BillNo=@BillNo and LabPtype='R' and LabNo=@LabNo and PatRegId=@Patregid and BranchId=@BranchId
GO

CREATE PROCEDURE [dbo].[SP_Update_RadiologyLabRegistration_Transaction]

@Patregid int,
@LabNo int,
@BillNo int=0,
@BranchId int=0,
@PaymentMode nvarchar(50)='',
@DiscountAmt	float=0,
@BalanceAmt	float=0,
@ReasonForDiscountId	int=0,
@DiscountGivenById int=0,
@ReasonForBalanceId int=0,
@CardChequeNo	nvarchar(50)=null,
@ChequeDate	datetime=null,
@BankName	nvarchar(255)=null,
@InsuranceCompId int=null,
@IsInsurance bit=0,
@InsuranceAmount float=0,
@FID int=0


as

update LabBillPaymentTrns set PaymentMode=@PaymentMode,DiscountAmt=@DiscountAmt,BalanceAmt=@BalanceAmt,ReasonForDisc=@ReasonForDiscountId,
DiscGivenBy=@DiscountGivenById,ReasonForBalance=@ReasonForBalanceId,ChequeNo=@CardChequeNo,ChequeDate=@ChequeDate,BankName=@BankName,InsuranceCompId=@InsuranceCompId,
 IsInsurance=@IsInsurance,InsuranceAmount=@InsuranceAmount where BillNo=@BillNo and LabNo=@LabNo and PatRegId=@Patregid and BranchId=@BranchId
GO

ALTER PROCEDURE [dbo].[SP_UpdateBillFinalDischarge]

@Patregid nvarchar(50)=null,
@IpdNo int=0,
@Branchid int=0,
@UserName nvarchar(250)=null
as
declare @InvNo int
declare @InvNoT int
	 select @InvNo=IsNull(max(InvoiceNo),0)+1 from IpdBillMaster   

	 select @InvNoT= IsNull(max(InvoiceNo),0) from IpdBillMaster where PatRegId=@Patregid and IpdNo=@IpdNo and BranchId=@Branchid
	 if(@InvNoT=0)
	 begin
update IpdBillMaster set InvoiceNo=@InvNo ,isDischarge=1,IsClose=1,FinalDischargeBy=@UserName,FinalDischargeOn=getdate() 
where PatRegId=@Patregid and IpdNo=@IpdNo and BranchId=@Branchid
end
else
begin
update IpdBillMaster set isDischarge=1,IsClose=1,FinalDischargeBy=@UserName,FinalDischargeOn=getdate() 
where PatRegId=@Patregid and IpdNo=@IpdNo and BranchId=@Branchid
end
GO

CREATE PROCEDURE [dbo].[Sp_UpdateCharge_InsuranceDiscount]      
     
@InvoiceId int=0,      
@InsuranceAmt float=0, 
@DiscountAmt float=0,
@Discount float=0,   
@ActualInsuAmt float,        
@DisRemark nvarchar(520)=null,      
@DiscGivenBy nvarchar(250) =''
              
AS      
BEGIN      


update ChargeBill_Master set InsuranceAmt =@InsuranceAmt, Discount=@Discount,DiscountAmt=@DiscountAmt,
ActualInsuAmt=@ActualInsuAmt,DiscountRemark=@DisRemark,DiscountGivenBy=@DiscGivenBy,DiscountGivenOn=getdate() where ID=@InvoiceId

   
       select 'Update Successfully!';      
END      
      
      
      
      
      
      
--select * from InsurancepaymentTransaction
GO

ALTER PROCEDURE [dbo].[Sp_UpdateDrugIssueStatusIN_HMS]

@patregid int=0,
@IpdNo	int=0,
@BranchId int=0


AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	

update tbl_Treatment set PaymentStatus='IPDPaid' where PatientRegId=@patregid and Ipd=@IpdNo and BranchId=@BranchId and IsApproveByNurse=1


END
GO

CREATE PROCEDURE [dbo].[Sp_UpdateInvoicePaymentFor_OPD]  
 -- Add the parameters for the stored procedure here      
 @ChargeNo nvarchar(50),      
 @PatRegId int,   
 @FId int,      
 @BranchId int,      
 @InsuranceCompId int  =0,
 @PayRecNo nvarchar(50)='0',
 @PaymentReceiveBy nvarchar(250)
AS      
BEGIN      
 -- SET NOCOUNT ON added to prevent extra result sets from      
 -- interfering with SELECT statements.      
 SET NOCOUNT ON;      
   
      
  update ChargeBill_Master set PaymentReceive=1,PaymentReceiveOn=getdate(),PayRecNo=@PayRecNo,PaymentReceiveBy=@PaymentReceiveBy where PatRegId=@PatRegId and  ChargeNo=@ChargeNo and InsuranceCompId=@InsuranceCompId    
      
      
END
GO

ALTER PROCEDURE [dbo].[Sp_UpdateIPDRegistration] 
	-- Add the parameters for the stored procedure here
	
	@PatRegId	int,	
	@PatMainTypeId	int,
    @PatientInsuTypeId	int,		
	@DeptId	int=0,
	@PrimaryDoc	int=0,
	@SecodaryDoc int=0,
	@ReferenceDoc int=0,
	@ContactPerson1	nvarchar(250)=null,
	@ContactPerson2	nvarchar(250)=null,
	@Relation1	int=0,
	@Relation2	int=0,	
	@Contact1	nvarchar(50)=null,
	@Contact2	nvarchar(50)=null,	
	@UpdatedBy	nvarchar(50)=null,	
	@IsEmergency bit,
	@IsUniversalPrecaution bit,
	@FId	int,
	@BranchId	int	,	
	@IpdId int,
	@OperationName nvarchar(250)=null,
	@DiseaseName nvarchar(250)=null,
	@OperationId int=null,
	@DiseaseId int=null,
	@PatientSubCategoryId2  int=0,
    @EntryDate datetime=null
	
	

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

 declare @OPID int=0
 declare @DisID int=0
 if(@OperationId=0)
 begin
  if(not exists(select OperationName from OperationMst where OperationName=@OperationName and IsGeneral=1 ))
 begin
 insert into OperationMst(OperationName,FID,Branchid,CreatedBy,CreatedOn,IsGeneral)
 values(@OperationName,@FID,@Branchid,@UpdatedBy,getdate(),1)
 end
 end
  if(@DiseaseId=0)
 begin
 if(not exists(select DiseaseName from DiseaseMst where DiseaseName=@DiseaseName and IsGeneral=1 ))
 begin
 insert into DiseaseMst(DiseaseName,FID,Branchid,CreatedBy,CreatedOn,IsGeneral)
 values(@DiseaseName,@FID,@Branchid,@UpdatedBy,getdate(),1)
 end
 end
  select @OPID=OperationId from OperationMst where OperationName=@OperationName
  select @DisID=DiseaseId from DiseaseMst where DiseaseName=@DiseaseName

	update IpdRegistration set 	
	PrimaryDoc=@PrimaryDoc,
	SecodaryDoc=@SecodaryDoc,
	ReferenceDoc=@ReferenceDoc,
	PatientMainCategoryId=@PatMainTypeId,	
    PatientSubCategoryId=@PatientInsuTypeId,
	DeptId=@DeptId,	
	ContactPerson1=@ContactPerson1,
	ContactPerson2=@ContactPerson2,
	Relation1=@Relation1,
	Relation2=@Relation2,
	Contact1=@Contact1,	
	Contact2=@Contact2,
	UpdatedBy=@UpdatedBy,
	UpdatedOn = getdate(),
	IsEmergency=@IsEmergency,
	IsUniversalPrecaution=@IsUniversalPrecaution,Sponsor=@DiseaseName,ProcedureName=@OperationName,
	OperationId=@OPID,DiseaseId=@DisID
	,PatientSubCategoryId2=@PatientSubCategoryId2 ,
		EntryDate=@EntryDate
	where IpdId=@IpdId and FId=@FId and BranchId=@BranchId and PatRegId=@PatRegId
    select '1Record Updated Successfully'
END
GO

CREATE PROCEDURE [dbo].[SP_UpdatePatientInsu_SubType]

@PatientMainType int=0, 
@PatientInsuTypeId int=0, 
@ChildCompanyName nvarchar(500)='', 
@ContactNumber nvarchar(50)='', 
@CompanyDescription nvarchar(2500)='', 
@CreatedBy nvarchar(250)='', 
@BranchId int=0,
@Id int

as


update PatientInsu_SubType set PatientMainType=@PatientMainType, PatientInsuTypeId=@PatientInsuTypeId, ChildCompanyName=@ChildCompanyName,
 ContactNumber=@ContactNumber, CompanyDescription=@CompanyDescription
where Id=@Id
GO

CREATE PROCEDURE [dbo].[Sp_UpdatePatientInvoiceChargeService]        
       
@InvoiceId int=0,        
@BillAmt float=0,    
@BillServiceId int=0, 
@DrId int=0,
@Qty int=0,
@Charges float,          
@CreatedBy nvarchar(520)=null  
                
AS        
BEGIN        
  

  declare @BillGroupName nvarchar(350)
SELECT     distinct  @BillGroupName= BillGroup.GroupName
FROM            BillService INNER JOIN
BillGroup ON BillService.BillGroupid = BillGroup.BillGroupId where BillServiceId=@BillServiceId

update ChargeBill_Master set BillAmt =BillAmt+@BillAmt, InsuranceAmt=InsuranceAmt+@BillAmt where ID=@InvoiceId  

insert ChargeBill_Details(ChargeId,BillServiceId,MTCode,DrugId,DrId,Qty,Charges,CreatedBy,CreatedOn,CancelBill,PatRegId,BillGroupName,BillNo,DrugName)
  SELECT         ID, @BillServiceId,'0',0,@DrId, @Qty,@Charges,@CreatedBy, CreatedOn, 0, Patregid, @BillGroupName,0,''
FROM            ChargeBill_Master where ID=@InvoiceId 
    -- values(@ChargeId,@BillServiceId,'0',0,@DrId,@Qty,@Charges,@CreatedBy,@CreatedOn,0,@PatRegId,@BillGroupName,0,'')
       select 'Update Successfully!';        
END        
        
        
        
        
        
        
--select * from InsurancepaymentTransaction
GO

CREATE PROCEDURE [dbo].[SP_UpdateRadiologyPaymeny]  
  
@Patregid int=0,  
@LabNo int=0,  
@BillPaymentId int=0,  
@PaymentReceivedBy nvarchar(250)='',  
@ReceivedPayment float=0  
as  
  
if( exists(select patregid from LabBillPaymentTrns where Patregid=@Patregid and Labno=@LabNo and BillPaymentId=@BillPaymentId  and RadioPayReceive=0 ))  
begin  
--select 'dd'  
update LabBillPaymentTrns set PaymentReceivedBy=@PaymentReceivedBy,PaymentReceivedon=getdate(),ReceivedAmount=@ReceivedPayment,RadioPayReceive=1,BalanceAmt=0   
where Patregid=@Patregid and Labno=@LabNo and BillPaymentId=@BillPaymentId   
  
 insert into Radiology.dbo.PatientInformation_MediPro(SNO, exam_date, DateOfEntry, Intial, FirstName, Age, Sex, RefDoc, mtcode, TestName, TestRate, Coll_Center, Coll_Code, MobileNo, LabRegistrationNo, ReceivedAmt, BalanceAmt, VatAmt, DisAmt, ModeOfPayment
, Pusername,   
                         PPassWord, MDY, invno, IPDNO, BillAmount, ReferPhy, OtherRefDoc, MainDrID, InsuranceId, InsuranceAmt, UserName, PatAddress, PatBirthDate, RepType, Email, ClinicalHistory, HMSEntryDate)  
SELECT        SNO, exam_date, DateOfEntry, Intial, FirstName, Age, Sex, RefDoc, mtcode, TestName, TestRate, Coll_Center, Coll_Code, MobileNo, LabRegistrationNo, ReceivedAmt, BalanceAmt, VatAmt, DisAmt, ModeOfPayment, Pusername,   
                         PPassWord, MDY, invno, IPDNO, BillAmount, ReferPhy, OtherRefDoc, MainDrID, InsuranceId, InsuranceAmt, UserName, PatAddress, PatBirthDate, RepType, Email, ClinicalHistory, HMSEntryDate  
FROM            Radiology.dbo.PatientInformation_MediPro_Temp where LabRegistrationNo=@Patregid and invno=@LabNo  
end  
--else  
--begin  
--select 'k'  
--end
GO

CREATE PROCEDURE [dbo].[Sp_Vw_AllInvoicePatient_ForOPD]      
 @InvoiceNo int,    
  @FromDate varchar(50),            
 @ToDate varchar(50)    
AS      
BEGIN      
 -- SET NOCOUNT ON added to prevent extra result sets from      
 -- interfering with SELECT statements.      
 SET NOCOUNT ON;      
 declare @Sql nvarchar(3000)      
    if(@InvoiceNo>0)  
 begin  
set @Sql='alter view Vw_AllInvoicePatient_ForOPD as( SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,     
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName,ChargeBill_Master.BillGroupName,  ChargeBill_Master.BillNo  
FROM  ChargeBill_Master INNER JOIN    
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN    
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId    
where           
CONVERT(date, ChargeBill_Master.CreatedOn)  between '''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + ''' and ''' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + '''    and InsuranceCompId='''+ convert(varchar(10),@InvoiceNo)+'''   '    
       end  
    else  
    begin  
set @Sql='alter view Vw_AllInvoicePatient_ForOPD as( SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,     
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName ,ChargeBill_Master.BillGroupName,  ChargeBill_Master.BillNo   
FROM  ChargeBill_Master INNER JOIN    
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN    
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId    
where           
CONVERT(date, ChargeBill_Master.CreatedOn)  between '''+ CONVERT(VARCHAR(10), CONVERT(date, @FromDate, 105), 23) + ''' and ''' + CONVERT(VARCHAR(10), CONVERT(date, @ToDate, 105), 23) + '''      '    
  
    end  
      
      
     Execute (@Sql +')')      
END
GO

CREATE PROCEDURE [dbo].[Sp_VW_GenerateChargeNumber]      
 -- Add the parameters for the stored procedure here      
 @Patregid int=0      
AS      
BEGIN      
 -- SET NOCOUNT ON added to prevent extra result sets from      
 -- interfering with SELECT statements.      
 SET NOCOUNT ON;      
 declare @Sql nvarchar(3000)      
 set @Sql= 'alter view VW_GenerateChargeNumber as (SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt, 
                         ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, ChargeBill_Master.BillGroupName, ChargeBill_Master.BillNo, 
                         ChargeBill_Master.PatientMainType, ChargeBill_Master.InsuCompanyId, ChargeBill_Master.CoverageDetails, PatientInsuType.PatientInsuType, PatientInformation.FirstName, PatientInformation.MobileNo, 
                         PatientInformation.PhoneNo, PatientInformation.PatientAddress, PatientInformation.Age, PatientInformation.AgeType, PatientInformation.BirthDate, PatientInsu_SubType.ChildCompanyName
FROM            ChargeBill_Master INNER JOIN
                         PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN
                         PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN
                         PatientInsu_SubType ON ChargeBill_Master.InsuCompanyId = PatientInsu_SubType.ID         
    where   dbo.ChargeBill_Master.Patregid='''+ Convert(varchar(20),@Patregid) +''' and       
    CAST(CAST(YEAR(ChargeBill_Master.Createdon) AS varchar(4)) + ''/'' + CAST(MONTH(ChargeBill_Master.Createdon) AS varchar(2)) + ''/'' + CAST(DAY(ChargeBill_Master.Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + ''-'' + CAST(MONTH(getdate()) AS varchar(2)) + ''-'' + CAST(DAY(getdate()) AS varchar(2)) AS datetime)'       
      
      
      
  
       
        
      
     execute (@Sql + ')')      
      
END
GO

CREATE PROCEDURE [dbo].[Sp_Vw_InsuranceCompTransactionLedge_ForOPD]  
 -- Add the parameters for the stored procedure here  
 @FromDate varchar(50)=null,  
 @ToDate varchar(50)=null,  
 @FId int=0,  
 @BranchId int=0,  
 @Sponser int=0  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
 declare @Sql nvarchar(3000)  
 set @Sql= 'alter view Vw_InsuranceCompTransactionLedge_ForOPD as (SELECT dbo.InsuranceCompPaymentTransactions_ForOPD.CreditAmount, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentMode,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.ReceiptNo, dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser, dbo.PatientInsuType.PatientInsuType,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.ChequeNo, dbo.InsuranceCompPaymentTransactions_ForOPD.ChequeDate,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.BankName, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentDate,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.TransactionType, dbo.InsuranceCompPaymentTransactions_ForOPD.FId,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.BranchId,dbo.InsuranceCompPaymentTransactions_ForOPD.CreatedBy, dbo.InsuranceCompPaymentTransactions_ForOPD.DebitAmount  
				FROM    dbo.InsuranceCompPaymentTransactions_ForOPD LEFT OUTER JOIN  
				dbo.PatientInsuType ON dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser = dbo.PatientInsuType.PatientInsuTypeId       
				where   dbo.InsuranceCompPaymentTransactions_ForOPD.FId='''+ Convert(varchar(20),@FId) +''' and   
				dbo.InsuranceCompPaymentTransactions_ForOPD.BranchId='''+ Convert(varchar(20),@BranchId) +''''   
  
  
  
 if(@FromDate <>'' and  @ToDate <>'')  
    begin  
    set @Sql=@Sql +' and  CONVERT(date, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentDate)  between ''' + convert(varchar(10),Convert(date,@FromDate,105),23)+ '''  and ''' + convert(varchar(10),Convert(date,@ToDate,105),23) + ''''  
        
    end  
   
     if(@Sponser <>0)  
    begin  
    set @Sql=@Sql +' and dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser=''' +  convert(varchar(10),@Sponser)  + ''''   
       
    Exec(@Sql + ')')  
    end  
  
     execute (@Sql + ')')  
  
END
GO

CREATE PROCEDURE [dbo].[Sp_Vw_InsurancePaymentReceipt_OPD]  
 -- Add the parameters for the stored procedure here  
 @ReceiptNo int=0,  
 @Sponser int=0,  
 @FId int=0,  
 @BranchId int=0  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
 declare @Sql nvarchar(3000)  
 set @Sql= 'alter view Vw_InsurancePaymentReceipt_OPD as (SELECT dbo.InsuranceCompPaymentTransactions_ForOPD.CreditAmount, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentMode,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.ReceiptNo, dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser, dbo.PatientInsuType.PatientInsuType,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.ChequeNo, dbo.InsuranceCompPaymentTransactions_ForOPD.ChequeDate,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.BankName, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentDate,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.TransactionType, dbo.InsuranceCompPaymentTransactions_ForOPD.FId,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.BranchId,dbo.InsuranceCompPaymentTransactions_ForOPD.CreatedBy, dbo.InsuranceCompPaymentTransactions_ForOPD.DebitAmount  
      FROM    dbo.InsuranceCompPaymentTransactions_ForOPD LEFT OUTER JOIN  
                 dbo.PatientInsuType ON dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser = dbo.PatientInsuType.PatientInsuTypeId 
     where InsuranceCompPaymentTransactions_ForOPD.ReceiptNo=  '''+ Convert(varchar(20),@ReceiptNo) +''' and   
     dbo.InsuranceCompPaymentTransactions_ForOPD.FId='''+ Convert(varchar(20),@FId) +''' and   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.BranchId='''+ Convert(varchar(20),@BranchId) +''' and   
     dbo.InsuranceCompPaymentTransactions_ForOPD.TransactionType=''Credit'' and dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser='''+ Convert(varchar(20),@Sponser) +''''  
  
     execute (@Sql + ')')  
  
END
GO

CREATE PROCEDURE [dbo].[Sp_Vw_InsuranceSummaryForLAB_Child]  
  
 @start varchar(20) =null,  
 @end varchar(20) =null,  
 @PatRegId int=null,   
 @FId int=null,  
 @BranchId int=null,  
 @InsuranceId int=null,  
 @BillGroup nvarchar(50)=null  
AS  
BEGIN  
 --declare @start date = '2015-03-27',  
 --@end date = '2015-03-27',  
 --@PatRegId int=null,  
 --@RTypeId int=null,  
 --@FId int=1,  
 --@BranchId int=1  
  Declare @sql varchar(5000)  
    set @sql='alter View Vw_InsuranceSummaryForLabNew_Child as ( SELECT        LabRegistration.LabNo, LabRegistration.BillNo, LabRegistration.TokenNo, LabRegistration.PatRegId, LabRegistration.DrId, LabRegistration.VisitingNo, LabRegistration.Entrydate, LabRegistration.RegistrationType, 
LabRegistration.ReferenceDoc, LabRegistration.DeptId, LabRegistration.PatientComplaints, LabRegistration.PatientMainCategoryId, LabRegistration.PatientSubCategoryId, LabRegistration.FId, LabRegistration.BranchId, 
LabRegistration.CreatedBy, LabRegistration.CreatedOn, LabRegistration.UpdatedBy, LabRegistration.UpdatedOn, LabRegistration.IsPatientChecked, LabRegistration.ReferBy, LabRegistration.LabPtype, 
LabRegistration.CancelBill, LabRegistration.CancelBy, LabRegistration.CancelRemark, LabRegistration.CancelOn, LabRegistration.MainDoctor, LabRegistration.QRImage, LabRegistration.ClinicalHistory, LabRegistration.IPDNO,
LabRegistration.AfterHrs, LabRegistration.InsuranceChargeCompany, LabRegistration.LetterNo, LabServiceDetails.ServiceName
FROM            LabRegistration INNER JOIN
LabServiceDetails ON LabRegistration.PatRegId = LabServiceDetails.PatRegId AND LabRegistration.LabNo = LabServiceDetails.LabNo
  
      WHERE (LabRegistration.CancelBill <> 1)  AND (LabRegistration.PatientSubCategoryId <> 1)   '  
 if(@start<>'' and @end<>'' )  
 begin   
 set @sql=@Sql +' and CONVERT(date, LabRegistration.CreatedOn)  between '''+ CONVERT(VARCHAR(10), CONVERT(date, @start, 105), 23) +'''and '''+CONVERT(VARCHAR(10), CONVERT(date, @end, 105), 23)+''''   
 end  
  
 print(@sql)  
 Exec(@sql + ')')  
  
END
GO

ALTER PROCEDURE [dbo].[Sp_Vw_LabBillPatientsPayment]    
 @FromDate datetime =null,    
    @ToDate datetime =null,    
    @PaymentStatus nvarchar(50) =null,    
 @PatRegId int=null,    
    @MobileNo nvarchar(50) =null,    
    @FId int=null,    
    @BranchId int =null,    
 @BillNo int=0,    
 @LabPtype varchar(5),    
  @UserName nvarchar(50) =null    
AS    
BEGIN    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 -- interfering with SELECT statements.    
 SET NOCOUNT ON;    
    
    Declare @sql varchar(4000)    
   -- set @sql='select * from Vw_InvoiceList'    
    set @sql='    
SELECT DISTINCT     
ISNULL(Initial.Title, '''') + '' '' + PatientInformation.FirstName + '' '' + ISNULL(PatientInformation.MiddleName, '''') + '' '' + ISNULL(PatientInformation.LastName, '''') AS PatientName,     
LabServiceDetails.TotalCharges AS BillServiceCharges, LabRegistration.Entrydate, 0 as OPDNo, LabServiceDetails.PatRegId, LabServiceDetails.BillNo,     
HospEmpMst.Title + '' '' + HospEmpMst.Empname AS Empname, ISNULL(Gender.GenderName, '''') AS GenderName, LabRegistration.PatientMainCategoryId, LabRegistration.PatientSubCategoryId, PatMainType.PatMainType,     
PatientInsuType.PatientInsuType, PatientInformation.Age, PatientInformation.AgeType, PatientInformation.MobileNo, PatientInformation.BloodGroup, PatientInformation.BirthDate, LabRegistration.FId, LabRegistration.BranchId,     
LabRegistration.DrId, LabRegistration.LabNo, LabRegistration.LabPtype, LabRegistration.ReferBy,    
    
(LabBillPaymentTrns.ReceivedAmount) AS ReceivedAmount, SUM(LabBillPaymentTrns.DiscountAmt) AS DiscountAmt,     
sum(LabServiceDetails.BillServiceCharges) - (SUM(LabBillPaymentTrns.DiscountAmt)  + (LabBillPaymentTrns.ReceivedAmount) + (ISNULL(LabBillPaymentTrns.InsuranceAmount, 0))) AS BalanceAmt,    
ISNULL(LabBillPaymentTrns.InsuranceAmount, 0) AS InsuranceAmount,LabBillPaymentTrns.CreatedBy    
FROM            LabServiceDetails INNER JOIN    
LabRegistration ON LabServiceDetails.PatRegId = LabRegistration.PatRegId AND LabServiceDetails.LabNo = LabRegistration.LabNo INNER JOIN    
LabBillPaymentTrns ON LabRegistration.BillNo = LabBillPaymentTrns.BillNo AND LabRegistration.LabNo = LabBillPaymentTrns.LabNo AND LabRegistration.PatRegId = LabBillPaymentTrns.PatRegId AND     
LabRegistration.BranchId = LabBillPaymentTrns.BranchId AND LabServiceDetails.PatRegId = LabBillPaymentTrns.PatRegId LEFT OUTER JOIN    
HospEmpMst ON LabServiceDetails.DrId = HospEmpMst.DrId LEFT OUTER JOIN    
PatientInformation ON LabRegistration.PatRegId = PatientInformation.PatRegId LEFT OUTER JOIN    
PatientInsuType ON LabRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN    
PatMainType ON LabRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN    
Gender ON PatientInformation.GenderId = Gender.GenderId LEFT OUTER JOIN    
Initial ON PatientInformation.TitleId = Initial.TitleId where (LabRegistration.CancelBill = 0) and LabRegistration.FId='''+ convert(varchar(10),@FId)+''' and LabRegistration.BranchId='''+ convert(varchar(10),@BranchId)+''''    
       
     if((@FromDate is not null) and  (@ToDate is not null))    
    begin    
    set @sql=@Sql +' and (CAST(CAST(YEAR(LabRegistration.EntryDate) AS varchar(4)) + ''/'' + CAST(MONTH(LabRegistration.EntryDate) AS varchar(2)) + ''/'' + CAST(DAY(LabRegistration.EntryDate) AS varchar(2)) AS datetime)) between ''' + convert(varchar(10),
  
cast(@FromDate as date))+ '''  and ''' + convert(varchar(10),cast(@ToDate as date)) + ''''    
      --Exec(@sql + ' Order by InvoiceNo desc ')    
    end    
 if(@PatRegId<>0)    
 begin    
  set @sql=@Sql +' and LabRegistration.PatRegId = ''' +  convert(varchar(10),@PatRegId)  + ''''     
 end    
     if(@MobileNo <>'')    
    begin    
set @sql=@Sql +' and PatientInformation.MobileNo = ''' + @MobileNo + ''''     
    --Exec(@sql + ' Order by InvoiceNo desc ')    
   end    
 if(@LabPtype <> 'O')    
 begin       
    set @sql=@Sql +' and LabRegistration.LabPtype = ''' +  convert(varchar(10),@LabPtype)  + ''''        
    end    
 if(@BillNo <>0)    
 begin       
    set @sql=@Sql +' and LabServiceDetails.BillNo = ''' +  convert(varchar(10),@BillNo)  + ''''        
    end    
  if(@UserName <>'0')    
    begin    
    set @sql=@sql +' and LabBillPaymentTrns.CreatedBy = ''' + @UserName + ''''     
       
    end    
    
 set @sql=@sql +' GROUP BY LabBillPaymentTrns.ReceivedAmount,ISNULL(Initial.Title, '''') + '' '' + PatientInformation.FirstName + '' '' + ISNULL(PatientInformation.MiddleName, '''') + '' '' + ISNULL(PatientInformation.LastName, ''''), LabRegistration.Entrydate, LabServiceDetails.OPDNo,     
LabServiceDetails.PatRegId, LabServiceDetails.BillNo, HospEmpMst.Empname, HospEmpMst.Title, Gender.GenderName, LabRegistration.PatientMainCategoryId, LabRegistration.PatientSubCategoryId,     
PatMainType.PatMainType, PatientInsuType.PatientInsuType, PatientInformation.Age, PatientInformation.AgeType, PatientInformation.MobileNo, PatientInformation.BloodGroup, PatientInformation.BirthDate, LabRegistration.FId,     
LabRegistration.BranchId, LabRegistration.DrId, LabRegistration.LabNo,LabServiceDetails.TotalCharges,LabRegistration.LabPtype,LabRegistration.ReferBy,LabBillPaymentTrns.CreatedBy, ISNULL(LabBillPaymentTrns.InsuranceAmount, 0)'     
 --if(@PaymentStatus = '1')    
 --begin    
       
 --   set @sql=@Sql +' and BalanceAmt >0'    
        
 --   end    
 --if(@PaymentStatus = '1')    
 --begin    
       
 --   set @sql=@Sql +' and BalanceAmt >0'    
        
 --   end    
 --if(@PaymentStatus = '0')    
 --begin    
       
 --   set @sql=@Sql +' and BalanceAmt =0'    
        
 --   end    
       
    print(@sql)    
    Exec(@sql + ' Order by LabRegistration.Labno desc ')    
        
        
END
GO

ALTER PROCEDURE [dbo].[Sp_Vw_LabEditPatients]
	@FromDate datetime =null,
    @ToDate datetime =null,
    @PaymentStatus nvarchar(50) =null,
	@PatRegId int=null,
    @MobileNo nvarchar(50) =null,
    @FId int=null,
    @BranchId int =null,
	@BillNo int=0,
	@LabPtype varchar(5),
	@UserName nvarchar(50)=null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    Declare @sql varchar(3000)
   -- set @sql='select * from Vw_InvoiceList'
    set @sql='select * from Vw_LabEditPatients where FId='''+ convert(varchar(10),@FId)+''' and BranchId='''+ convert(varchar(10),@BranchId)+''''
   
     if((@FromDate is not null) and  (@ToDate is not null))
    begin
    set @sql=@Sql +' and (CAST(CAST(YEAR(EntryDate) AS varchar(4)) + ''/'' + CAST(MONTH(EntryDate) AS varchar(2)) + ''/'' + CAST(DAY(EntryDate) AS varchar(2)) AS datetime)) between ''' + convert(varchar(10),cast(@FromDate as date))+ '''  and ''' + convert
(varchar(10),cast(@ToDate as date)) + ''''
      --Exec(@sql + ' Order by InvoiceNo desc ')
    end
	if(@PatRegId<>0)
	begin
	 set @sql=@Sql +' and PatRegId = ''' +  convert(varchar(10),@PatRegId)  + '''' 
	end
     if(@MobileNo <>'')
    begin
    set @sql=@Sql +' and MobileNo = ''' + @MobileNo + '''' 
    --Exec(@sql + ' Order by InvoiceNo desc ')
    end
	   if(@LabPtype <> 'O')
	begin   
    set @sql=@Sql +' and LabPtype = ''' +  convert(varchar(10),@LabPtype)  + ''''    
    end
	if(@BillNo <>0)
	begin   
    set @sql=@Sql +' and BillNo = ''' +  convert(varchar(10),@BillNo)  + ''''    
    end
   if(@UserName <>'0')
    begin
   -- set @sql=@sql +' and CreatedBy = ''' + @UserName + '''' 
	 set @sql=@sql +' and PaymentReceivedBy = ''' + @UserName + '''' 
   
    end

    print(@sql)
    Exec(@sql + ' Order by Labno desc ')
    
    
END
GO

ALTER PROCEDURE [dbo].[Sp_Vw_LabPaymentTransactionRpt_UserWise]    
 @FromDate nvarchar(50) =null,    
    @ToDate nvarchar(50) =null,    
    @PaymentType int =null,    
 @PatRegId int=null,    
 @BillGroup nvarchar(200)=null,    
    @UserName nvarchar(50) =null,    
    @FId int=null,    
    @BranchId int =null    
AS    
BEGIN    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 -- interfering with SELECT statements.    
 SET NOCOUNT ON;    
Declare @sql varchar(3000)    
   set @sql=' alter view  Vw_LabPaymentTransactionRpt_UserWise as(SELECT       
case when ModeOfPayment.ModeOfPaymentName=''Cash'' then LabBillPaymentTrns.ReceivedAmount else 0 end as CashAmt,     
case when ModeOfPayment.ModeOfPaymentName=''Cheque'' then LabBillPaymentTrns.ReceivedAmount else 0 end as ChequeAmt,     
case when ModeOfPayment.ModeOfPaymentName=''RBL Card'' then LabBillPaymentTrns.ReceivedAmount else 0 end as RBLAmt,     
case when ModeOfPayment.ModeOfPaymentName=''Charge To Account'' then LabBillPaymentTrns.ReceivedAmount else 0 end as CTAmt,      ModeOfPayment.ModeOfPaymentName,    
case when LabRegistration.LabPtype=''P'' then ''Pathology'' when LabRegistration.LabPtype=''R'' then ''Radiology'' else ''Medical LAB'' end as BillGroup,    
LabRegistration.LabPtype,     
LabBillPaymentTrns.ReceivedAmount,    
LabBillPaymentTrns.PaymentReceivedon as PaymentDate, LabBillPaymentTrns.PatRegId, Initial.Title,     
PatientInformation.FirstName, LabBillPaymentTrns.CancelAdmission, LabBillPaymentTrns.BillPaymentid,    
    
 case when isnull(PaymentReceivedBy,'''') ='''' then  LabBillPaymentTrns.PaymentReceivedBy else PaymentReceivedBy end as CreatedBy,    
  LabBillPaymentTrns.CreatedOn, LabBillPaymentTrns.ChequeNo,     
LabBillPaymentTrns.PaymentMode, LabBillPaymentTrns.ChequeDate, LabBillPaymentTrns.BankName, LabBillPaymentTrns.FId, LabBillPaymentTrns.BranchId, LabBillPaymentTrns.BillNo,     
    
PatMainType.PatMainType, LabBillPaymentTrns.BillAmount, LabBillPaymentTrns.InsuranceAmount, LabBillPaymentTrns.DiscountAmt,     
LabRegistration.PatientSubCategoryId, PatientInsuType.PatientInsuType,LabRegistration.MainDoctor, VW_GetLabeServiceName.SerVicesName    
FROM            LabBillPaymentTrns INNER JOIN    
LabRegistration ON LabBillPaymentTrns.PatRegId = LabRegistration.PatRegId AND LabBillPaymentTrns.LabNo = LabRegistration.LabNo INNER JOIN    
PatMainType ON LabRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId INNER JOIN    
PatientInsuType ON PatMainType.PatMainTypeId = PatientInsuType.PatMainTypeId AND LabRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN    
VW_GetLabeServiceName ON LabBillPaymentTrns.LabNo = VW_GetLabeServiceName.labno AND LabBillPaymentTrns.PatRegId = VW_GetLabeServiceName.Patregid LEFT OUTER JOIN    
Initial RIGHT OUTER JOIN    
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON LabBillPaymentTrns.PatRegId = PatientInformation.PatientInfoId LEFT OUTER JOIN    
ModeOfPayment ON LabBillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId    
WHERE  LabRegistration.CancelBill=0  and dbo.LabBillPaymentTrns.FId='''+ convert(varchar(10),@FId)+''' and  dbo.LabBillPaymentTrns.BranchId='''+ convert(varchar(10),@BranchId)+''''    
    
        
       
   if(@FromDate <>'' and  @ToDate <>'')    
    begin    
   -- set @sql=@sql +' and (CAST(CAST(YEAR(dbo.LabBillPaymentTrns.PaymentDate) AS varchar(4)) + ''/'' + CAST(MONTH(dbo.LabBillPaymentTrns.PaymentDate) AS varchar(2)) + ''/'' + CAST(DAY(dbo.LabBillPaymentTrns.PaymentDate) AS varchar(2)) AS datetime)) between''' + convert(varchar(10),cast(@FromDate as date))+ '''  and ''' + convert(varchar(10),cast(@ToDate as date)) + ''''    
         set @sql=@sql +' and dbo.LabBillPaymentTrns.PaymentDate between ''' + convert(varchar(50),cast(@FromDate as varchar(50)))+ '''  and ''' + convert(varchar(50),cast(@ToDate as varchar(50))) + ''''      
  
    end    
     
     if(@UserName <>'0')    
    begin    
    set @sql=@sql +' and dbo.LabBillPaymentTrns.PaymentReceivedBy = ''' + @UserName + ''''     
       
    end    
 if(@BillGroup <>'0')    
    begin    
    set @sql=@sql +' and dbo.LabRegistration.LabPtype = ''' + @BillGroup + ''''     
       
    end    
 if(@PaymentType <> 0)    
 begin    
       
    set @sql=@sql +' and dbo.LabBillPaymentTrns.PaymentMode ='''+ convert(varchar(10),@PaymentType)+''''    
        
   end    
     
       
    print(@sql)    
    Exec(@sql + ')' )    
    
END
GO

ALTER PROCEDURE [dbo].[Sp_Vw_OpdBillOutStandingPayment]  
 @FromDate datetime =null,  
    @ToDate datetime =null,  
    @PaymentStatus nvarchar(50) =null,  
 @PatRegId int=null,  
    @MobileNo nvarchar(50) =null,  
    @FId int=null,  
    @BranchId int =null  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  
    Declare @sql varchar(4000)  
   -- set @sql='select * from Vw_InvoiceList'  
    set @sql='select * from Vw_OpdBillOutStandingPayment_Proce where FId='''+ convert(varchar(10),@FId)+''' and BranchId='''+ convert(varchar(10),@BranchId)+''''  
     
     if((@FromDate is not null) and  (@ToDate is not null))  
    begin  
    set @sql=@Sql +' and (CAST(CAST(YEAR(Createdon) AS varchar(4)) + ''/'' + CAST(MONTH(Createdon) AS varchar(2)) + ''/'' + CAST(DAY(Createdon) AS varchar(2)) AS datetime)) between ''' + convert(varchar(10),cast(@FromDate as date))+ '''  and ''' + convert(varchar(10),cast(@ToDate as date)) + ''''  
      --Exec(@sql + ' Order by InvoiceNo desc ')  
    end  
 if(@PatRegId<>0)  
 begin  
  set @sql=@Sql +' and PatRegId = ''' +  convert(varchar(10),@PatRegId)  + ''''   
 end  
     if(@MobileNo <>'')  
    begin  
    set @sql=@Sql +' and MobileNo = ''' + @MobileNo + ''''   
    --Exec(@sql + ' Order by InvoiceNo desc ')  
    end  
 if(@PaymentStatus = '1')  
 begin  
     
    set @sql=@Sql +' and BalanceAmt >0'  
      
    end  
 if(@PaymentStatus = '0')  
 begin  
     
    set @sql=@Sql +' and BalanceAmt =0'  
      
    end  
     
    print(@sql)  
    Exec(@sql + ' Order by PatRegId asc ')  
      
      
END
GO

CREATE PROCEDURE [dbo].[Sp_Vw_PatientInsuranceDetailsForInvoice_ForOPD]  
 @InvoiceNo int,  
 @Sponser int,  
 @FId int,  
 @BranchId int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
 declare @Sql nvarchar(3000)  
  
set @Sql='alter view Vw_PatientInsuranceDetailsForInvoice_ForOPD as(SELECT        PatientInvoiceDetails_ForOPD.InvoiceNo, PatientInvoiceDetails_ForOPD.PatRegId, PatientInvoiceDetails_ForOPD.InsuranceAmount, PatientInvoiceDetails_ForOPD.Sponser,
PatientInvoiceDetails_ForOPD.TransactionDate,   
PatientInvoiceDetails_ForOPD.FId, PatientInvoiceDetails_ForOPD.BranchId, PatientInvoiceDetails_ForOPD.ChargeNo, PatientInsuType.PatientInsuType, PatientInformation.FirstName as PatientName  
FROM  PatientInsuType RIGHT OUTER JOIN  
PatientInvoiceDetails_ForOPD LEFT OUTER JOIN  
PatientInformation ON PatientInvoiceDetails_ForOPD.PatRegId = PatientInformation.PatRegId ON 
PatientInsuType.PatientInsuTypeId = PatientInvoiceDetails_ForOPD.Sponser where  
      PatientInvoiceDetails_ForOPD.FId='''+ convert(varchar(10),@FId)+''' and PatientInvoiceDetails_ForOPD.BranchId='''+ convert(varchar(10),@BranchId)+'''  
     and dbo.PatientInvoiceDetails_ForOPD.InvoiceNo ='''+ convert(varchar(10),@InvoiceNo)+''' and PatientInvoiceDetails_ForOPD.Sponser='''+ convert(varchar(10),@Sponser)+''''  
  
  
     Execute (@Sql +')')  
END
GO

CREATE PROCEDURE [dbo].[Sp_Vw_PatientInsuranceDetailsForInvoice_ForOPD_Report]                
 @InvoiceNo int              
AS                
BEGIN                
 -- SET NOCOUNT ON added to prevent extra result sets from                
 -- interfering with SELECT statements.                
 SET NOCOUNT ON;                
 declare @Sql nvarchar(max)      
 declare @Sql1 nvarchar(4000)      
       
    
    
set @Sql='alter view Vw_PatientInsuranceDetailsForInvoice_ForOPD_Report as(SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt
    
, ChargeBill_Master.InsuranceAmt,             
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, BillService.ServiceName, HospEmpMst.Empname, ChargeBill_Details.BillServiceId,             
ChargeBill_Details.MTCode, PatientInsuType.PatientInsuType,'''' as LabServiceName  ,ChargeBill_Details.BillGroupName,ChargeBill_Details.BillNo,ChargeBill_Details.Charges ,        
PatientInformation.FirstName , PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress   ,ChargeBill_Details.Qty   
,ChargeBill_Master.Discount,DiscountAmt,DiscountGivenBy,DiscountGivenOn,ActualInsuAmt,DiscountRemark,ChargeBill_Details.ID AS ChdetId  
FROM            ChargeBill_Master INNER JOIN        
ChargeBill_Details ON ChargeBill_Master.ID = ChargeBill_Details.ChargeId INNER JOIN        
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN        
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN        
HospEmpMst ON ChargeBill_Details.DrId = HospEmpMst.DrId LEFT OUTER JOIN        
BillService ON ChargeBill_Details.BillServiceId = BillService.BillServiceId          
              
     where ChargeBill_Details.BillServiceId>0 and ChargeBill_Master.ID ='''+ convert(varchar(10),@InvoiceNo)+'''             
 union all            
SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,         
 ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, LabServiceDetails.ServiceName, HospEmpMst.Empname, ChargeBill_Details.BillServiceId,         
 ChargeBill_Details.MTCode, PatientInsuType.PatientInsuType, '''' AS LabServiceName, ChargeBill_Details.BillGroupName, ChargeBill_Details.BillNo, ChargeBill_Details.Charges,        
       PatientInformation.FirstName  ,PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress   ,ChargeBill_Details.Qty     
    ,ChargeBill_Master.Discount,DiscountAmt,DiscountGivenBy,DiscountGivenOn,ActualInsuAmt,DiscountRemark  ,ChargeBill_Details.ID AS ChdetId
FROM            ChargeBill_Master INNER JOIN        
ChargeBill_Details ON ChargeBill_Master.ID = ChargeBill_Details.ChargeId INNER JOIN        
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN        
LabServiceDetails ON ChargeBill_Details.MTCode = LabServiceDetails.MTCode AND ChargeBill_Details.BillServiceId = LabServiceDetails.BillServiceId AND ChargeBill_Details.PatRegId = LabServiceDetails.PatRegId AND         
ChargeBill_Details.BillNo = LabServiceDetails.BillNo INNER JOIN        
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN        
HospEmpMst ON ChargeBill_Details.DrId = HospEmpMst.DrId        
 where  ChargeBill_Master.ID ='''+ convert(varchar(10),@InvoiceNo)+'''     
 union all    
 SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,     
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, ChargeBill_Details.DrugName AS ServiceName, HospEmpMst.Empname,     
ChargeBill_Details.BillServiceId, ChargeBill_Details.MTCode, PatientInsuType.PatientInsuType, '''' AS LabServiceName, ChargeBill_Details.BillGroupName, ChargeBill_Details.BillNo, ChargeBill_Details.Charges,     
PatientInformation.FirstName, PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress ,ChargeBill_Details.Qty   
,ChargeBill_Master.Discount,DiscountAmt,DiscountGivenBy,DiscountGivenOn,ActualInsuAmt,DiscountRemark , ChargeBill_Details.ID AS ChdetId
FROM            ChargeBill_Master INNER JOIN    
ChargeBill_Details ON ChargeBill_Master.ID = ChargeBill_Details.ChargeId INNER JOIN    
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN    
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN    
HospEmpMst ON ChargeBill_Details.DrId = HospEmpMst.DrId where  ChargeBill_Details.DrugId>0 and ChargeBill_Master.ID ='''+ convert(varchar(10),@InvoiceNo)+''' '              
     
                
                
     Execute (@Sql +')')                
END
GO

ALTER PROCEDURE [dbo].[Sp_Vw_ProcedureBillReport]  
 -- Add the parameters for the stored procedure here  
 @BillNo int=0,  
 @PatRegId int=0,  
 @FId int=0,  
 @BranchId int=0,  
 @ProcedureId int=0  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  
 declare @Sql1 nvarchar(3000)  
 declare @Sql2 nvarchar(3000)  
 set @Sql1='alter view Vw_procedureBillMaster as( SELECT        ProcedureBillMaster.PatRegId, Initial.Title, PatientInformation.FirstName, PatientInsuType.PatientInsuType, ProcedureBillMaster.PatientSubType, ProcedureBillMaster.PatientMainType, ProcedureBillMaster.BillAmount,   
ProcedureBillMaster.AmountPaid, ProcedureBillMaster.Discount, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.BillGroup, ProcedureBillMaster.BillNo, ProcedureBillMaster.CreatedBy, ProcedureBillMaster.CreatedOn,   
ProcedureBillMaster.BranchId, ProcedureBillMaster.FId, PatMainType.PatMainType, ProcedureBillMaster.ProcedureId, ProcedurePaymentTrns.ChequeNo, ProcedurePaymentTrns.ChequeDate,   
ProcedurePaymentTrns.BankName, ProcedurePaymentTrns.PaymentMode, ProcedurePaymentTrns.ReceivedAmount, ProcedurePaymentTrns.PaymentDate, ModeOfPayment.ModeOfPaymentName, PatientInformation.MobileNo,   
cast( PatientInformation.Age as varchar(50)) +'' ''+ PatientInformation.AgeType as AgeType, Gender.GenderName ,ProcedureBillMaster.ChargeNumber ,ProcedureBillMaster.LetterNo
FROM            Initial RIGHT OUTER JOIN  
PatientInformation INNER JOIN  
Gender ON PatientInformation.GenderId = Gender.GenderId ON Initial.TitleId = PatientInformation.TitleId RIGHT OUTER JOIN  
ProcedurePaymentTrns INNER JOIN  
ProcedureBillMaster ON ProcedurePaymentTrns.BillNo = ProcedureBillMaster.BillNo AND ProcedurePaymentTrns.PatRegId = ProcedureBillMaster.PatRegId AND   
ProcedurePaymentTrns.ProcedureId = ProcedureBillMaster.ProcedureId LEFT OUTER JOIN  
ModeOfPayment ON ProcedurePaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId LEFT OUTER JOIN  
PatientInsuType ON ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId ON PatientInformation.PatRegId = ProcedureBillMaster.PatRegId LEFT OUTER JOIN  
PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId  
     where ProcedureBillMaster.BillNo='''+ Convert(varchar(100),@BillNo)+''' and ProcedureBillMaster.PatRegId ='''+ Convert(varchar(100),@PatRegId)+'''  
    and  ProcedureBillMaster.FId='''+ Convert(varchar(100),@FId)+''' and ProcedureBillMaster.BranchId ='''+ Convert(varchar(100),@BranchId)+'''  
     and ProcedureBillMaster.ProcedureId ='''+ Convert(varchar(100),@ProcedureId)+''''  
  
 --set @Sql1='Select * from Vw_procedureBillMaster where BillNo='''+ Convert(varchar(100),@BillNo)+''' and PatRegId ='''+ Convert(varchar(100),@PatRegId)+'''  
 --and  FId='''+ Convert(varchar(100),@FId)+''' and BranchId ='''+ Convert(varchar(100),@BranchId)+''''  
  
 --set @Sql2='Select * from Vw_ProcedureBillServiceDetails where BillNo='''+ Convert(varchar(100),@BillNo)+''' and PatRegId ='''+ Convert(varchar(100),@PatRegId)+'''  
 --and  FId='''+ Convert(varchar(100),@FId)+''' and BranchId ='''+ Convert(varchar(100),@BranchId)+''''  
 print (@Sql1 +')')  
 Execute(@Sql1 +')')  
  
 set @Sql2='alter view Vw_ProcedureBillServiceDetails as(SELECT dbo.ProcedureServiceDetails.PatRegId, dbo.BillService.ServiceName, dbo.ProcedureServiceDetails.BillServiceId,   
                 dbo.ProcedureServiceDetails.BillServiceCharges, dbo.ProcedureServiceDetails.Qty, dbo.ProcedureServiceDetails.TotalCharges,   
                 dbo.ProcedureServiceDetails.FId, dbo.ProcedureServiceDetails.BillNo, dbo.ProcedureServiceDetails.BranchId, dbo.ProcedureServiceDetails.CreatedBy,   
                 dbo.ProcedureServiceDetails.CreatedOn, dbo.ProcedureServiceDetails.BillGroup, dbo.ProcedureServiceDetails.ProcedureId,   
                 dbo.HospEmpMst.Title + '' '' + dbo.HospEmpMst.Empname AS DoctorName  
    FROM    dbo.ProcedureServiceDetails LEFT OUTER JOIN  
                 dbo.HospEmpMst ON dbo.ProcedureServiceDetails.DrId = dbo.HospEmpMst.DrId LEFT OUTER JOIN  
                 dbo.BillService ON dbo.ProcedureServiceDetails.BillServiceId = dbo.BillService.BillServiceId  
      where dbo.ProcedureServiceDetails.BillNo='''+ Convert(varchar(100),@BillNo)+''' and dbo.ProcedureServiceDetails.PatRegId ='''+ Convert(varchar(100),@PatRegId)+'''  
    and  dbo.ProcedureServiceDetails.FId='''+ Convert(varchar(100),@FId)+''' and dbo.ProcedureServiceDetails.BranchId ='''+ Convert(varchar(100),@BranchId)+'''  
     and ProcedureServiceDetails.ProcedureId ='''+ Convert(varchar(100),@ProcedureId)+''''  
  
 print (@Sql2 +')')  
 Execute(@Sql2 + ')')  
END
GO

ALTER PROCEDURE [dbo].[Sp_Vw_ProcedurePaymentTransactionRpt_UserWise]          
 @FromDate nvarchar(50) =null,          
    @ToDate nvarchar(50) =null,          
    @PaymentType int =null,          
 @PatRegId int=null,          
 @BillGroup nvarchar(200)=null,          
    @UserName nvarchar(50) =null,          
    @FId int=null,          
    @BranchId int =null          
AS          
BEGIN          
 -- SET NOCOUNT ON added to prevent extra result sets from          
 -- interfering with SELECT statements.          
 SET NOCOUNT ON;          
Declare @sql varchar(3000)          
   set @sql=' alter view  Vw_ProcedurePaymentTransactionRpt_UserWise as(SELECT             
   case when ModeOfPayment.ModeOfPaymentName=''Cash'' then ProcedurePaymentTrns.ReceivedAmount else 0 end as CashAmt,           
case when ModeOfPayment.ModeOfPaymentName=''Cheque'' then ProcedurePaymentTrns.ReceivedAmount else 0 end as ChequeAmt,           
case when ModeOfPayment.ModeOfPaymentName=''RBL Card'' then ProcedurePaymentTrns.ReceivedAmount else 0 end as RBLAmt,           
case when ModeOfPayment.ModeOfPaymentName=''Charge To Account'' then ProcedurePaymentTrns.ReceivedAmount else 0 end as CTAmt,      ModeOfPayment.ModeOfPaymentName, ProcedurePaymentTrns.BillGroup, ProcedurePaymentTrns.ReceivedAmount,      
ProcedurePaymentTrns.PaymentDate, ProcedurePaymentTrns.PatRegId, Initial.Title,           
PatientInformation.FirstName, ProcedurePaymentTrns.CancelBill, ProcedurePaymentTrns.ProcedureId, ProcedurePaymentTrns.CreatedBy, ProcedurePaymentTrns.CreatedOn, ProcedurePaymentTrns.ChequeNo,           
ProcedurePaymentTrns.PaymentMode, ProcedurePaymentTrns.ChequeDate, ProcedurePaymentTrns.BankName, ProcedurePaymentTrns.FId, ProcedurePaymentTrns.BranchId, ProcedurePaymentTrns.BillNo,           
PatMainType.PatMainType, ProcedureBillMaster.BillAmount, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.Discount, ProcedureBillMaster.PatientSubType, PatientInsuType.PatientInsuType          
FROM            ProcedurePaymentTrns INNER JOIN          
ProcedureBillMaster ON ProcedurePaymentTrns.PatRegId = ProcedureBillMaster.PatRegId AND ProcedurePaymentTrns.ProcedureId = ProcedureBillMaster.ProcedureId INNER JOIN          
PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId INNER JOIN          
PatientInsuType ON PatMainType.PatMainTypeId = PatientInsuType.PatMainTypeId AND ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN          
Initial RIGHT OUTER JOIN          
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON ProcedurePaymentTrns.PatRegId = PatientInformation.PatientInfoId LEFT OUTER JOIN          
ModeOfPayment ON ProcedurePaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId          
WHERE  ProcedureBillMaster.CancelBill=0  and dbo.ProcedurePaymentTrns.FId='''+ convert(varchar(10),@FId)+''' and  dbo.ProcedurePaymentTrns.BranchId='''+ convert(varchar(10),@BranchId)+''''          
          
              
             
   if(@FromDate <>'' and  @ToDate <>'')          
    begin          
  --  set @sql=@sql +' and (CAST(CAST(YEAR(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(4)) + ''/'' + CAST(MONTH(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(2)) + ''/'' + CAST(DAY(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(2)) AS datetime))
  
    
      
 --between ''' + convert(varchar(10),cast(@FromDate as date))+ '''  and ''' + convert(varchar(10),cast(@ToDate as date)) + ''''          
    set @sql=@sql +' and dbo.ProcedurePaymentTrns.PaymentDate between ''' + convert(varchar(50),cast(@FromDate as nvarchar(50)))+ '''  and ''' + convert(varchar(50),cast(@ToDate as nvarchar(50))) + ''''          
            
    end          
           
     if(@UserName <>'0')          
    begin          
    set @sql=@sql +' and dbo.ProcedurePaymentTrns.CreatedBy = ''' + @UserName + ''''           
             
    end          
 if(@BillGroup <>'0')          
    begin          
    set @sql=@sql +' and dbo.ProcedurePaymentTrns.BillGroup = ''' + @BillGroup + ''''           
             
    end          
 if(@PaymentType <> 0)          
 begin          
             
    set @sql=@sql +' and dbo.ProcedurePaymentTrns.PaymentMode ='''+ convert(varchar(10),@PaymentType)+''''          
              
    end          
           
             
    print(@sql)          
   Exec(@sql + ')' )          
          
END
GO

ALTER PROCEDURE [dbo].[Sp_Vw_ProcedurePaymentTransactionRpt_UserWise_service]    
 @FromDate nvarchar(50) =null,    
    @ToDate nvarchar(50) =null,    
    @PaymentType int =null,    
 @PatRegId int=null,    
 @BillGroup nvarchar(200)=null,    
    @UserName nvarchar(50) =null,    
    @FId int=null,    
    @BranchId int =null    
AS    
BEGIN    
 -- SET NOCOUNT ON added to prevent extra result sets from    
 -- interfering with SELECT statements.    
 SET NOCOUNT ON;    
Declare @sql varchar(3000)    
Declare @sql1 varchar(3000)    
Declare @sql2 varchar(3000)    
    
set @sql1='alter view  VW_ProcedurePaymentServiceWise as SELECT        ProcedureServiceDetails.PatRegId, ProcedureServiceDetails.BranchId, ProcedureServiceDetails.ProcedureId, BillService.ServiceName    
FROM            ProcedureServiceDetails INNER JOIN BillService ON ProcedureServiceDetails.BillServiceId = BillService.BillServiceId     
WHERE   dbo.ProcedureServiceDetails.FId='''+ convert(varchar(10),@FId)+''' and  dbo.ProcedureServiceDetails.BranchId='''+ convert(varchar(10),@BranchId)+''''    
 if(@FromDate <>'' and  @ToDate <>'')    
    begin    
    set @sql1=@sql1 +' and (CAST(CAST(YEAR(dbo.ProcedureServiceDetails.CreatedOn) AS varchar(4)) + ''/'' + CAST(MONTH(dbo.ProcedureServiceDetails.CreatedOn) AS varchar(2)) + ''/'' + CAST(DAY(dbo.ProcedureServiceDetails.CreatedOn) AS varchar(2)) AS datetime)) between ''' + convert(varchar(10),cast(@FromDate as date))+ '''  and ''' + convert(varchar(10),cast(@ToDate as date)) + ''''    
         
    end    
 print(@sql1)    
    Exec(@sql1  )    
    
     
set @sql2='alter view  VW_ProcedurePayment_AllServiceWise as  SELECT  distinct Patregid,ProcedureId,Branchid,    
 ServiceName = STUFF(    (SELECT '','' + ServiceName    FROM VW_ProcedurePaymentServiceWise t1    WHERE t1.ProcedureId = t2.ProcedureId     
  and t1.Patregid = t2.Patregid   FOR XML PATH (''''))   , 1, 1, '''') from VW_ProcedurePaymentServiceWise t2      
  group by Patregid,ProcedureId,Branchid'    
    
 print(@sql2)    
    Exec(@sql2  )    
    
   set @sql=' alter view  Vw_ProcedurePaymentTransactionRpt_UserWise_service as(SELECT       
   case when ModeOfPayment.ModeOfPaymentName=''Cash'' then ProcedurePaymentTrns.ReceivedAmount else 0 end as CashAmt,     
case when ModeOfPayment.ModeOfPaymentName=''Cheque'' then ProcedurePaymentTrns.ReceivedAmount else 0 end as ChequeAmt,     
case when ModeOfPayment.ModeOfPaymentName=''RBL Card'' then ProcedurePaymentTrns.ReceivedAmount else 0 end as RBLAmt,     
case when ModeOfPayment.ModeOfPaymentName=''Charge To Account'' then ProcedurePaymentTrns.ReceivedAmount else 0 end as CTAmt,      ModeOfPayment.ModeOfPaymentName, ProcedurePaymentTrns.BillGroup, ProcedurePaymentTrns.ReceivedAmount, ProcedurePaymentTrns.P
  
aymentDate, ProcedurePaymentTrns.PatRegId, Initial.Title,     
PatientInformation.FirstName, ProcedurePaymentTrns.CancelBill, ProcedurePaymentTrns.ProcedureId, ProcedurePaymentTrns.CreatedBy, ProcedurePaymentTrns.CreatedOn, ProcedurePaymentTrns.ChequeNo,     
ProcedurePaymentTrns.PaymentMode, ProcedurePaymentTrns.ChequeDate, ProcedurePaymentTrns.BankName, ProcedurePaymentTrns.FId, ProcedurePaymentTrns.BranchId, ProcedurePaymentTrns.BillNo,     
PatMainType.PatMainType, ProcedureBillMaster.BillAmount, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.Discount, ProcedureBillMaster.PatientSubType, PatientInsuType.PatientInsuType,    
VW_ProcedurePayment_AllServiceWise.ServiceName    
FROM            ProcedurePaymentTrns INNER JOIN    
ProcedureBillMaster ON ProcedurePaymentTrns.PatRegId = ProcedureBillMaster.PatRegId AND ProcedurePaymentTrns.ProcedureId = ProcedureBillMaster.ProcedureId INNER JOIN    
PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId INNER JOIN    
PatientInsuType ON PatMainType.PatMainTypeId = PatientInsuType.PatMainTypeId AND ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId INNER JOIN    
VW_ProcedurePayment_AllServiceWise ON ProcedureBillMaster.PatRegId = VW_ProcedurePayment_AllServiceWise.Patregid AND     
ProcedureBillMaster.ProcedureId = VW_ProcedurePayment_AllServiceWise.ProcedureId LEFT OUTER JOIN    
Initial RIGHT OUTER JOIN    
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON ProcedurePaymentTrns.PatRegId = PatientInformation.PatientInfoId LEFT OUTER JOIN    
ModeOfPayment ON ProcedurePaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId    
WHERE  ProcedureBillMaster.CancelBill=0  and dbo.ProcedurePaymentTrns.FId='''+ convert(varchar(10),@FId)+''' and  dbo.ProcedurePaymentTrns.BranchId='''+ convert(varchar(10),@BranchId)+''''    
    
        
       
   if(@FromDate <>'' and  @ToDate <>'')    
    begin    
    --set @sql=@sql +' and (CAST(CAST(YEAR(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(4)) + ''/'' + CAST(MONTH(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(2)) + ''/'' + CAST(DAY(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(2)) AS datetime))
-- between ''' + convert(varchar(10),cast(@FromDate as date))+ '''  and ''' + convert(varchar(10),cast(@ToDate as date)) + ''''    
     set @sql=@sql +' and dbo.ProcedurePaymentTrns.PaymentDate between ''' + convert(varchar(50),cast(@FromDate as nvarchar(50)))+ '''  and ''' + convert(varchar(50),cast(@ToDate as nvarchar(50))) + ''''      
     
    end    
     
     if(@UserName <>'0')    
    begin    
    set @sql=@sql +' and dbo.ProcedurePaymentTrns.CreatedBy = ''' + @UserName + ''''     
       
    end    
 if(@BillGroup <>'0')    
    begin    
    set @sql=@sql +' and dbo.ProcedurePaymentTrns.BillGroup = ''' + @BillGroup + ''''     
       
    end    
 if(@PaymentType <> 0)    
 begin    
       
    set @sql=@sql +' and dbo.ProcedurePaymentTrns.PaymentMode ='''+ convert(varchar(10),@PaymentType)+''''    
        
    end    
     
       
    print(@sql)    
    Exec(@sql + ')' )    
    
END
GO

ALTER PROCEDURE [dbo].[usp_GetGeneralEmrDetailsByPatientId]
	@Patientregid varchar(50),
	@Opd varchar(50),
	@Ipd varchar(50),
	@BranchId varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SELECT *  FROM tbl_GeneralEMR e
	inner join tbl_GeneralEmrTransaction t on e.EmrId = t.EmrId
	where Patientregid = @Patientregid and opd=@Opd and ipd=@Ipd and branchid = @BranchId
END
GO

ALTER PROCEDURE [dbo].[usp_GetIpdPatientList]
	
	@PatRegId int=null,
	@RTypeId int=null,

	@FId int=null,
	@BranchId int=null,
	@DRName int=0
AS
BEGIN
	--declare @start date = '2015-05-01',
	--@end date = '2015-05-20'
	 Declare @sql varchar(3000)
	  Declare @sql1 varchar(3000)


set @sql='SELECT    distinct    RoomType.RType, RoomMst.RoomName, IpdRegistration.IpdNo, IpdRegistration.PatRegId, IpdRegistration.IpdId, IpdRegistration.EntryDate, IpdRegistration.EntryTime, IpdRegistration.DeptId, IpdRegistration.PrimaryDoc, 
                         IpdRegistration.SecodaryDoc, IpdRegistration.ReferenceDoc, IpdRegistration.PatientMainCategoryId, IpdRegistration.ContactPerson1, IpdRegistration.ContactPerson2, IpdRegistration.Relation1, IpdRegistration.Relation2, 
                         IpdRegistration.Contact1, IpdRegistration.Contact2, IpdRegistration.BedId, IpdRegistration.IsAdmited, IpdRegistration.CreatedBy, IpdRegistration.CreatedOn, IpdRegistration.FId, IpdRegistration.BranchId, 
                         IpdRegistration.UpdatedBy, IpdRegistration.UpdatedOn, IpdRegistration.IsUniversalPrecaution, IpdRegistration.IsEmergency, BedMst.BedName, AlloctnOfBed.PatStatus, AlloctnOfBed.DateOfAdmission, HospEmpMst.Empname, 
                         RoomMst.RTypeId, PatientInformation.FirstName, PatientInformation.TitleId, Initial.Title, HospEmpMst.Title AS Expr1, ISNULL(IpdBillMaster.BillAmount, 0) AS BillAmount, ISNULL(IpdBillMaster.InvoiceNo, 0) AS InvoiceNo
						 ,  ISNULL(IpdBillMaster.BillNo, 0) AS BillNo
FROM            IpdBillMaster RIGHT OUTER JOIN
                         IpdRegistration ON IpdBillMaster.IpdId = IpdRegistration.IpdId LEFT OUTER JOIN
                         PatientInformation LEFT OUTER JOIN
                         Initial ON PatientInformation.TitleId = Initial.TitleId ON IpdRegistration.PatRegId = PatientInformation.PatRegId LEFT OUTER JOIN
                         HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId LEFT OUTER JOIN
                         BedMst INNER JOIN
                         AlloctnOfBed ON BedMst.BedId = AlloctnOfBed.BedId INNER JOIN
                         RoomMst ON BedMst.RoomId = RoomMst.RoomId INNER JOIN
                         RoomType ON RoomMst.RTypeId = RoomType.RTypeId ON IpdRegistration.IpdId = AlloctnOfBed.IpdId
WHERE  IpdBillMaster.BranchId>0 and  IpdBillMaster.PatRegId>0 and    (IpdRegistration.IsAdmited = 1) AND (AlloctnOfBed.PatStatus = ''Admitted'')
 and  IpdRegistration.FId='''+ convert(varchar(10),@FId)+''' and IpdRegistration.BranchId='''+ convert(varchar(10),@BranchId)+''''
	if(@PatRegId<>0)
	begin
	 set @sql=@Sql +' and IpdRegistration.PatRegId = ''' +  convert(varchar(10),@PatRegId)  + '''' 
	end
	
	if(@RTypeId<>0 )
	begin
	 set @sql=@Sql +' and RoomMst.RTypeId = ''' +  convert(varchar(10),@RTypeId)  + '''' 
	end
	if(@DRName<>0 )
	begin
	 set @sql=@Sql +' and IpdRegistration.PrimaryDoc = ''' +  convert(varchar(10),@DRName)  + ''' ' 
	end
	else
	begin
	set @sql=@sql +' and  IpdRegistration.ReferBy_Doc =0 ' 
	end
	set @sql1='  union all SELECT   distinct     RoomType.RType, RoomMst.RoomName, IpdRegistration.IpdNo, IpdRegistration.PatRegId, IpdRegistration.IpdId, IpdRegistration.EntryDate, IpdRegistration.EntryTime, IpdRegistration.DeptId, IpdRegistration.PrimaryDoc, 
                         IpdRegistration.SecodaryDoc, IpdRegistration.ReferenceDoc, IpdRegistration.PatientMainCategoryId, IpdRegistration.ContactPerson1, IpdRegistration.ContactPerson2, IpdRegistration.Relation1, IpdRegistration.Relation2, 
                         IpdRegistration.Contact1, IpdRegistration.Contact2, IpdRegistration.BedId, IpdRegistration.IsAdmited, IpdRegistration.CreatedBy, IpdRegistration.CreatedOn, IpdRegistration.FId, IpdRegistration.BranchId, 
                         IpdRegistration.UpdatedBy, IpdRegistration.UpdatedOn, IpdRegistration.IsUniversalPrecaution, IpdRegistration.IsEmergency, BedMst.BedName, AlloctnOfBed.PatStatus, AlloctnOfBed.DateOfAdmission, HospEmpMst.Empname, 
                         RoomMst.RTypeId, PatientInformation.FirstName, PatientInformation.TitleId, Initial.Title, HospEmpMst.Title AS Expr1, ISNULL(IpdBillMaster.BillAmount, 0) AS BillAmount, ISNULL(IpdBillMaster.InvoiceNo, 0) AS InvoiceNo
						 ,  ISNULL(IpdBillMaster.BillNo, 0) AS BillNo
FROM            IpdBillMaster RIGHT OUTER JOIN
                         IpdRegistration ON IpdBillMaster.IpdId = IpdRegistration.IpdId LEFT OUTER JOIN
                         PatientInformation LEFT OUTER JOIN
                         Initial ON PatientInformation.TitleId = Initial.TitleId ON IpdRegistration.PatRegId = PatientInformation.PatRegId LEFT OUTER JOIN
                         HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId LEFT OUTER JOIN
                         BedMst INNER JOIN
                         AlloctnOfBed ON BedMst.BedId = AlloctnOfBed.BedId INNER JOIN
                         RoomMst ON BedMst.RoomId = RoomMst.RoomId INNER JOIN
                         RoomType ON RoomMst.RTypeId = RoomType.RTypeId ON IpdRegistration.IpdId = AlloctnOfBed.IpdId
WHERE      IpdBillMaster.BranchId>0 and  IpdBillMaster.PatRegId>0 and (IpdRegistration.IsAdmited = 1) AND (AlloctnOfBed.PatStatus = ''Admitted'') and
   IpdRegistration.FId='''+ convert(varchar(10),@FId)+''' and IpdRegistration.BranchId='''+ convert(varchar(10),@BranchId)+''''
	if(@PatRegId<>0)
	begin
	 set @sql1=@sql1 +' and IpdRegistration.PatRegId = ''' +  convert(varchar(10),@PatRegId)  + '''' 
	end
	
	if(@RTypeId<>0 )
	begin
	 set @sql1=@sql1 +' and RoomMst.RTypeId = ''' +  convert(varchar(10),@RTypeId)  + '''' 
	end
	if(@DRName<>0 )
	begin
	 set @sql1=@sql1 +' and IpdRegistration.ReferBy_Doc = ''' +  convert(varchar(10),@DRName)  + ''' and IpdRegistration.ReferBy_Doc >0 ' 
	end
	else
	begin
	set @sql1=@sql1 +' and  IpdRegistration.ReferBy_Doc >0 ' 
	end
	print(@sql+@sql1)
	Exec(@sql+@sql1 + ' order by IpdRegistration.IpdId desc ')

END
GO

ALTER PROCEDURE [dbo].[usp_GetTreatment_Insert] 
	@treatId varchar(10),
    @patientId varchar(10),
    @opd varchar(10),
    @ipd varchar(10),
	@DrId int,
    @branchId varchar(10),
    @followUp varchar(10),
    @createdBy varchar(250),
    @createdOn varchar(10),
    @updatedBy varchar(250),
    @updatedOn varchar(10),
    @type varchar(10),
	@DiscMedication bit=0,
	@IsApproveByNurse bit=0
AS
BEGIN 
		IF @type = 'Insert'  
		BEGIN  
		if(@DiscMedication =1)
		begin
		if(not exists( select  opd from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd and DiscMedication=1 and EntryDate between convert(varchar,   DATEADD(SECOND,-20,GETDATE()), 21) and  convert(varchar,  DATEADD(SECOND,20,GETDATE()), 21)))--and  EntryDate between convert(varchar,   DATEADD(SECOND,-30,GETDATE()), 21) and  convert(varchar,  DATEADD(MINUTE,30,GETDATE()), 21)))
		begin
			insert into [tbl_Treatment] (FollowUpDate,PatientRegId,Opd,Ipd,DrId,BranchId,CreatedBy,CreatedOn,UpdatedBy,UpdatedOn,DiscMedication,IsApproveByNurse)
			values(@followUp,@patientId,@opd,@ipd,@DrId,@branchId,@createdBy,@createdOn,@updatedBy,@updatedOn,@DiscMedication,@IsApproveByNurse)  
			SELECT SCOPE_IDENTITY ();
			end
		end
		else
		begin
		if(not exists( select  opd from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd and  EntryDate between convert(varchar,   DATEADD(MINUTE,-3,GETDATE()), 21) and  convert(varchar,  DATEADD(MINUTE,3,GETDATE()), 21)))--and  EntryDate between convert(varchar,   DATEADD(SECOND,-30,GETDATE()), 21) and  convert(varchar,  DATEADD(MINUTE,30,GETDATE()), 21)))
		begin
			insert into [tbl_Treatment] (FollowUpDate,PatientRegId,Opd,Ipd,DrId,BranchId,CreatedBy,CreatedOn,UpdatedBy,UpdatedOn,DiscMedication,IsApproveByNurse)
			values(@followUp,@patientId,@opd,@ipd,@DrId,@branchId,@createdBy,@createdOn,@updatedBy,@updatedOn,@DiscMedication,@IsApproveByNurse)  
			SELECT SCOPE_IDENTITY ();
			end
		END  
		end
		--else
		--begin
		--declare @TreatmentId int
		--select top(1) @TreatmentId=TreatmentId from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd order by TreatmentId desc
		--select @TreatmentId
		--end

		IF @type = 'Select'  
		BEGIN  
			SELECT  m.[TreatmentId] ,[FollowUpDate], [TransId],[ItemId],[DrugName],[Dose],[DoseId],[DoseTimeId],[FrequencyType],[Days],[StartDate],[EndDate],[Note]
			FROM [tbl_Treatment] m
			  inner join tbl_TreatmentTransaction t
			on m.TreatmentId = t.TreatmentId
		END  
		IF @type = 'Update'  
		BEGIN  
			UPDATE [tbl_Treatment] SET  [FollowUpDate] = @followUp
			WHERE [TreatmentId] = @treatId  
			SELECT SCOPE_IDENTITY ();
		END  
		--else IF @type = 'Delete'  
		--BEGIN  
		--	DELETE FROM [tbl_Treatment] WHERE [TreatmentId] = @treatId  
		--END  

END
GO

ALTER PROCEDURE [dbo].[usp_GetTreatment_Insert_Ipd] 
	@treatId varchar(10),
    @patientId varchar(10),
    @opd varchar(10),
    @ipd varchar(10),
	@DrId int,
    @branchId varchar(10),
    @followUp varchar(10),
    @createdBy varchar(250),
    @createdOn varchar(10),
    @updatedBy varchar(250),
    @updatedOn varchar(10),
	@IsApproveByNurse bit=0,
    @type varchar(10)
AS
BEGIN 
		IF @type = 'Insert'  
		BEGIN  
		if(not exists( select  Ipd from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd and  EntryDate between convert(varchar,   DATEADD(MINUTE,-3,GETDATE()), 21) and  convert(varchar,  DATEADD(MINUTE,3,GETDATE()), 21)))--and  EntryDate between convert(varchar,   DATEADD(SECOND,-30,GETDATE()), 21) and  convert(varchar,  DATEADD(MINUTE,30,GETDATE()), 21)))
		begin
			insert into [tbl_Treatment] (FollowUpDate,PatientRegId,Opd,Ipd,DrId,BranchId,CreatedBy,CreatedOn,UpdatedBy,UpdatedOn,IsEmergency,IsApproveByNurse)
			values(@followUp,@patientId,@opd,@ipd,@DrId,@branchId,@createdBy,@createdOn,@updatedBy,@updatedOn,0,@IsApproveByNurse)  
			SELECT SCOPE_IDENTITY ();
			end
		END  
		--else
		--begin
		--declare @TreatmentId int
		--select top(1) @TreatmentId=TreatmentId from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd order by TreatmentId desc
		--select @TreatmentId
		--end

		IF @type = 'Select'  
		BEGIN  
			SELECT  m.[TreatmentId] ,[FollowUpDate], [TransId],[ItemId],[DrugName],[Dose],[DoseId],[DoseTimeId],[FrequencyType],[Days],[StartDate],[EndDate],[Note],m.IsEmergency
			FROM [tbl_Treatment] m
			  inner join tbl_TreatmentTransaction t
			on m.TreatmentId = t.TreatmentId
		END  
		IF @type = 'Update'  
		BEGIN  
			UPDATE [tbl_Treatment] SET  [FollowUpDate] = @followUp
			WHERE [TreatmentId] = @treatId  
			SELECT SCOPE_IDENTITY ();
		END  
		--else IF @type = 'Delete'  
		--BEGIN  
		--	DELETE FROM [tbl_Treatment] WHERE [TreatmentId] = @treatId  
		--END  

END
GO

ALTER PROCEDURE [dbo].[usp_GetTreatment_Insert_Observ] 
	@treatId varchar(10),
    @patientId varchar(10),
    @opd varchar(10),
    @ipd varchar(10),
	@DrId int,
    @branchId varchar(10),
    @followUp varchar(10),
    @createdBy varchar(250),
    @createdOn varchar(10),
    @updatedBy varchar(250),
    @updatedOn varchar(10),
    @type varchar(10)
AS
BEGIN 
		IF @type = 'Insert'  
		BEGIN  
		if(not exists( select  opd from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd and  EntryDate between convert(varchar,   DATEADD(MINUTE,-3,GETDATE()), 21) and  convert(varchar,  DATEADD(MINUTE,3,GETDATE()), 21)))--and  EntryDate between convert(varchar,   DATEADD(SECOND,-30,GETDATE()), 21) and  convert(varchar,  DATEADD(MINUTE,30,GETDATE()), 21)))
		begin
			insert into [tbl_Treatment] (FollowUpDate,PatientRegId,Opd,Ipd,DrId,BranchId,CreatedBy,CreatedOn,UpdatedBy,UpdatedOn,IsEmergency)
			values(@followUp,@patientId,@opd,@ipd,@DrId,@branchId,@createdBy,@createdOn,@updatedBy,@updatedOn,1)  
			SELECT SCOPE_IDENTITY ();
			end
		END  
		--else
		--begin
		--declare @TreatmentId int
		--select top(1) @TreatmentId=TreatmentId from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd order by TreatmentId desc
		--select @TreatmentId
		--end

		IF @type = 'Select'  
		BEGIN  
			SELECT  m.[TreatmentId] ,[FollowUpDate], [TransId],[ItemId],[DrugName],[Dose],[DoseId],[DoseTimeId],[FrequencyType],[Days],[StartDate],[EndDate],[Note],m.IsEmergency
			FROM [tbl_Treatment] m
			  inner join tbl_TreatmentTransaction t
			on m.TreatmentId = t.TreatmentId
		END  
		IF @type = 'Update'  
		BEGIN  
			UPDATE [tbl_Treatment] SET  [FollowUpDate] = @followUp
			WHERE [TreatmentId] = @treatId  
			SELECT SCOPE_IDENTITY ();
		END  
		--else IF @type = 'Delete'  
		--BEGIN  
		--	DELETE FROM [tbl_Treatment] WHERE [TreatmentId] = @treatId  
		--END  

END
GO

ALTER PROCEDURE [dbo].[usp_GetTreatment_Insert_PostPo] 
	@treatId varchar(10),
    @patientId varchar(10),
    @opd varchar(10),
    @ipd varchar(10),
	@DrId int,
    @branchId varchar(10),
    @followUp varchar(10),
    @createdBy varchar(250),
    @createdOn varchar(10),
    @updatedBy varchar(250),
    @updatedOn varchar(10),
    @type varchar(10),
	@DiscMedication bit=0,
	@IsApproveByNurse bit=0,
	@PostpoTreat bit=0
AS
BEGIN 
		IF @type = 'Insert'  
		BEGIN  
		if(@PostpoTreat =1)
		begin
		if(not exists( select  opd from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd and PostpoTreat=1 and  EntryDate between convert(varchar,   DATEADD(SECOND,-20,GETDATE()), 21) and  convert(varchar,  DATEADD(SECOND,20,GETDATE()), 21)))--and  EntryDate between convert(varchar,   DATEADD(SECOND,-30,GETDATE()), 21) and  convert(varchar,  DATEADD(MINUTE,30,GETDATE()), 21)))
		begin
			insert into [tbl_Treatment] (FollowUpDate,PatientRegId,Opd,Ipd,DrId,BranchId,CreatedBy,CreatedOn,UpdatedBy,UpdatedOn,DiscMedication,IsApproveByNurse,PostpoTreat)
			values(@followUp,@patientId,@opd,@ipd,@DrId,@branchId,@createdBy,@createdOn,@updatedBy,@updatedOn,@DiscMedication,@IsApproveByNurse,@PostpoTreat)  
			SELECT SCOPE_IDENTITY ();
			end
		end
		end
		--else
		--begin
		--declare @TreatmentId int
		--select top(1) @TreatmentId=TreatmentId from tbl_Treatment where PatientRegId=@patientId and Opd=@opd and Ipd=@ipd order by TreatmentId desc
		--select @TreatmentId
		--end

		IF @type = 'Select'  
		BEGIN  
			SELECT  m.[TreatmentId] ,[FollowUpDate], [TransId],[ItemId],[DrugName],[Dose],[DoseId],[DoseTimeId],[FrequencyType],[Days],[StartDate],[EndDate],[Note]
			FROM [tbl_Treatment] m
			  inner join tbl_TreatmentTransaction t
			on m.TreatmentId = t.TreatmentId
		END  
		IF @type = 'Update'  
		BEGIN  
			UPDATE [tbl_Treatment] SET  [FollowUpDate] = @followUp
			WHERE [TreatmentId] = @treatId  
			SELECT SCOPE_IDENTITY ();
		END  
		--else IF @type = 'Delete'  
		--BEGIN  
		--	DELETE FROM [tbl_Treatment] WHERE [TreatmentId] = @treatId  
		--END  

END
GO

CREATE VIEW [dbo].[Vw_AllInvoicePatient_ForOPD] AS ( SELECT         ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,     
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, PatientInsuType.PatientInsuType, PatientInformation.FirstName ,ChargeBill_Master.BillGroupName,  ChargeBill_Master.BillNo   
FROM  ChargeBill_Master INNER JOIN    
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN    
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId    
where           
CONVERT(date, ChargeBill_Master.CreatedOn)  between '2023-03-01' and '2023-03-22'      )
GO

ALTER VIEW [dbo].[Vw_BillGroupSalesSummary] AS (SELECT BillGroup.GroupName, IpdBillServiceDetails.BillGroupId, SUM(IpdBillServiceDetails.TotalCharges) AS TotalCharges,Sum(IpdBillServiceDetails.Qty) as Qty, IpdBillServiceDetails.FId, 
           IpdBillServiceDetails.BranchId, IpdBillMaster.IsDischarge FROM    IpdBillServiceDetails LEFT OUTER JOIN
           IpdBillMaster ON IpdBillServiceDetails.IpdNo = IpdBillMaster.IpdNo LEFT OUTER JOIN
           BillGroup ON IpdBillServiceDetails.BillGroupId = BillGroup.BillGroupId where IpdBillMaster.IsDischarge=1  and
		   IpdBillServiceDetails.FId='1' and IpdBillServiceDetails.BranchId='1' 
		   and (CAST(CAST(YEAR( IpdBillMaster.FinalDischargeOn ) AS varchar(4)) + '/' + CAST(MONTH( IpdBillMaster.FinalDischargeOn ) AS varchar(2)) + '/' + CAST(DAY( IpdBillMaster.FinalDischargeOn ) AS varchar(2)) AS datetime))
		   between '2022-11-01'  and '2022-11-30'				
		   GROUP BY BillGroup.GroupName, IpdBillServiceDetails.BillGroupId, IpdBillServiceDetails.FId, IpdBillServiceDetails.BranchId,IpdBillMaster.IsDischarge)
GO

ALTER VIEW [dbo].[Vw_BillTransactions_Bill] AS (SELECT        BillPaymentTrns.BillPaymentId, BillPaymentTrns.BillNo, BillPaymentTrns.ReceiptNo, BillPaymentTrns.PatRegId, BillPaymentTrns.PaymentDate, BillPaymentTrns.ReceivedAmount, BillPaymentTrns.DiscountAmt, 
				BillPaymentTrns.BalanceAmt, BillPaymentTrns.OpdNo, BillPaymentTrns.IpdNo, BillPaymentTrns.IsOpd, BillPaymentTrns.IsIpd, BillPaymentTrns.BillType, BillPaymentTrns.FId, BillPaymentTrns.PaymentMode, 
				BillPaymentTrns.BranchId, BillPaymentTrns.ChequeDate, BillPaymentTrns.ChequeNo, BillPaymentTrns.BankName, BillPaymentTrns.CreatedBy, BillPaymentTrns.DiscGivenBy, BillPaymentTrns.ReasonForBalance, 
				BillPaymentTrns.ReasonForDisc, BillPaymentTrns.UpdatedBy, BillPaymentTrns.UpdatedOn, BillPaymentTrns.CreatedOn, Vw_OPDOutstanding.Entrydate, Vw_OPDOutstanding.DrId, Vw_OPDOutstanding.Empname, 
				Vw_OPDOutstanding.BillServiceCharges, Vw_OPDOutstanding.PatientName, ModeOfPayment.ModeOfPaymentName, Vw_OPDOutstanding.GenderName, Vw_OPDOutstanding.PatientMainCategoryId, 
				Vw_OPDOutstanding.PatientSubCategoryId, Vw_OPDOutstanding.PatMainType, Vw_OPDOutstanding.PatientInsuType, ReasonForBalance.ReasonForBalanceName, DiscountTypeMst.DiscType, 
				HospEmpMst.Empname AS DiscountGivenBy, Vw_OPDOutstanding.Age, Vw_OPDOutstanding.AgeType, Vw_OPDOutstanding.MobileNo, Vw_OPDOutstanding.BloodGroup, Vw_OPDOutstanding.BirthDate
				FROM            BillPaymentTrns LEFT OUTER JOIN
				HospEmpMst ON BillPaymentTrns.DrId = HospEmpMst.DrId LEFT OUTER JOIN
				DiscountTypeMst ON BillPaymentTrns.ReasonForDisc = DiscountTypeMst.DiscTypeId LEFT OUTER JOIN
				ReasonForBalance ON BillPaymentTrns.ReasonForBalance = ReasonForBalance.ReasonForBalanceId LEFT OUTER JOIN
				ModeOfPayment ON BillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId LEFT OUTER JOIN
				Vw_OPDOutstanding ON BillPaymentTrns.OpdNo = Vw_OPDOutstanding.OpdNo 
				AND BillPaymentTrns.BillNo = Vw_OPDOutstanding.BillNo AND BillPaymentTrns.PatRegId = Vw_OPDOutstanding.PatRegId
				 WHERE dbo.BillPaymentTrns.IpdNo= '18298' and BillPaymentTrns.FId='1'
				 and BillPaymentTrns.BranchId='1' and dbo.BillPaymentTrns.PatRegId= '38964')
GO

ALTER VIEW [dbo].[Vw_CancelprocedureBillMaster] AS (SELECT dbo.ProcedureBillMaster.PatRegId, (dbo.Initial.Title+' '+dbo.PatientInformation.FirstName) as FirstName, dbo.PatientInsuType.PatientInsuType, 
                 dbo.ProcedureBillMaster.PatientSubType, dbo.ProcedureBillMaster.PatientMainType, dbo.ProcedureBillMaster.BillAmount, 
                 dbo.ProcedureBillMaster.AmountPaid, dbo.ProcedureBillMaster.Discount, dbo.ProcedureBillMaster.InsuranceAmt, dbo.ProcedureBillMaster.BillGroup, 
                 dbo.ProcedureBillMaster.BillNo, dbo.ProcedureBillMaster.CreatedBy, dbo.ProcedureBillMaster.CreatedOn, dbo.ProcedureBillMaster.BranchId, 
                 dbo.ProcedureBillMaster.FId, dbo.PatMainType.PatMainType,ProcedureBillMaster.ProcedureId,ProcedureBillMaster.CancelBy,ProcedureBillMaster.CancelOn
				 FROM    dbo.PatientInsuType RIGHT OUTER JOIN
                 dbo.ProcedureBillMaster ON dbo.PatientInsuType.PatientInsuTypeId = dbo.ProcedureBillMaster.PatientSubType LEFT OUTER JOIN
                 dbo.PatientInformation LEFT OUTER JOIN
                 dbo.Initial ON dbo.PatientInformation.TitleId = dbo.Initial.TitleId ON dbo.ProcedureBillMaster.PatRegId = dbo.PatientInformation.PatRegId LEFT OUTER JOIN
                 dbo.PatMainType ON dbo.ProcedureBillMaster.PatientMainType = dbo.PatMainType.PatMainTypeId 				  
				where ProcedureBillMaster.CancelBill=1  and (CAST(CAST(YEAR(dbo.ProcedureBillMaster.CancelOn) AS varchar(4)) + '/' + CAST(MONTH(dbo.ProcedureBillMaster.CancelOn) AS varchar(2)) + '/' + CAST(DAY(dbo.ProcedureBillMaster.CancelOn) AS varchar(2)) AS datetime)) between '2023-04-06'  and '2023-02-07')
GO

ALTER VIEW [dbo].[Vw_DailyNurseNote] AS (SELECT  tbl_DailyNurseNote.NurseNoteId, tbl_DailyNurseNote.PatRegId, tbl_DailyNurseNote.IpdNo, tbl_DailyNurseNote.OpdNo, tbl_DailyNurseNote.NurseNote,  tbl_DailyNurseNote.CreatedBy, tbl_DailyNurseNote.DrId, tbl_DailyNurseNote.DateInput, tbl_DailyNurseNote.TimeInput, tbl_DailyNurseNote.UserId,   tbl_DailyNurseNote.FId, tbl_DailyNurseNote.BranchId, tbl_DailyNurseNote.UpdatedBy, tbl_DailyNurseNote.CreatedOn, tbl_DailyNurseNote.UpdatedOn,  CTuser.Name  FROM  tbl_DailyNurseNote LEFT OUTER JOIN  CTuser ON tbl_DailyNurseNote.UserId = CTuser.CUId where tbl_DailyNurseNote.PatRegId=68448 and tbl_DailyNurseNote.IpdNo=18280 and tbl_DailyNurseNote.OpdNo=0)
GO

ALTER VIEW [dbo].[Vw_DepositReport] AS ( SELECT dbo.PatientDepositMaster.DepositAmt, dbo.PatientDepositMaster.DepositDate, dbo.PatientDepositMaster.Type, dbo.PatientDepositMaster.Remark, 
                 dbo.PatientDepositMaster.PaymentMode, dbo.PatientDepositMaster.ChequeNo, dbo.PatientDepositMaster.ChequeDate, dbo.PatientDepositMaster.BankName, 
                 dbo.PatientDepositMaster.CreatedBy, dbo.PatientDepositMaster.CreatedOn, dbo.PatientDepositMaster.FId, dbo.PatientDepositMaster.BranchId, 
                 dbo.PatientInformation.MobileNo, dbo.Initial.Title + ' ' + dbo.PatientInformation.FirstName AS PatientName, dbo.PatientDepositMaster.DepositId, 
                 dbo.PatientDepositMaster.PatRegId, dbo.ModeOfPayment.ModeOfPaymentName
                 FROM    dbo.ModeOfPayment RIGHT OUTER JOIN
                 dbo.PatientDepositMaster ON dbo.ModeOfPayment.ModeOfPaymentId = dbo.PatientDepositMaster.PaymentMode LEFT OUTER JOIN
                 dbo.Initial RIGHT OUTER JOIN
                 dbo.PatientInformation ON dbo.Initial.TitleId = dbo.PatientInformation.TitleId ON dbo.PatientDepositMaster.PatRegId = dbo.PatientInformation.PatRegId
				 where dbo.PatientDepositMaster.DepositId='1338' and dbo.PatientDepositMaster.PatRegId='184104'
				 and  dbo.PatientDepositMaster.FId='1' and dbo.PatientDepositMaster.BranchId='1')
GO

ALTER VIEW [dbo].[VW_DischargeSummary] AS (SELECT DISTINCT 
Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, Gender.GenderName, PatientInformation.BirthDate, PatientInformation.PatientInfoId, IpdRegistration.EntryDate, IpdRegistration.EntryTime, 
HospEmpMst.Title + '  ' + HospEmpMst.Empname AS Empname, ROUND(dbo.FnGetAge(PatientInformation.PatientInfoId), 0) AS Age, IpdRegistration.IpdNo, RoomType.RType, AlloctnOfBed.PatStatus, BranchMst.BranchName, 
IpdRegistration.IpdId, IpdRegistration.FId, IpdRegistration.BranchId,  
 PatMainType.PatMainType, PatientInsuType.PatientInsuType, PatientInformation.PatientAddress, PatientInformation.MobileNo, Tbl_Relation.RelationName, PatientInformation.AgeType, 
IpdRegistration.ReferenceDoc, IpdRegistration.PrimaryDoc, PatientInsuType_1.PatientInsuType AS Sponsor2, HospEmpMst_1.Empname AS SecondaryDoc, BedMst.BedName as BedId, DepartmentMst.DeptName, 
PatientInformation.BloodGroup, PatientInformation.GuardianName, PatientInformation.PhoneNo, IPDDischargeSummary.ProcedureDate, IPDDischargeSummary.ProcedureD, IPDDischargeSummary.ProvDiag, 
IPDDischargeSummary.Complant, IPDDischargeSummary.CaseSummary, IPDDischargeSummary.FinalDiagnosis, IPDDischargeSummary.Surgan, IPDDischargeSummary.OTNote, IPDDischargeSummary.Anesthesia, 
IPDDischargeSummary.Anesthetist, IPDDischargeSummary.OnAdmissionDet, IPDDischargeSummary.Treatment, IPDDischargeSummary.ConDischarge, IPDDischargeSummary.ReasonDischarge, 
IPDDischargeSummary.OperationNote, IPDDischargeSummary.NextFollowUp, IPDDischargeSummary.TreatmentAdvice, IPDDischargeSummary.GeneralRemark, IPDDischargeSummary.CreatedBy, 
IPDDischargeSummary.CreatedOn, IPDDischargeSummary.UpdatedBy, IPDDischargeSummary.UpdatedOn,IpdRegistration.Contactperson1,IpdRegistration.Contact1, AlloctnOfBed.DateOfDischarge, AlloctnOfBed.DischargeTime
FROM            PatMainType RIGHT OUTER JOIN
HospEmpMst AS HospEmpMst_1 RIGHT OUTER JOIN
IPDDischargeSummary INNER JOIN
DepartmentMst INNER JOIN
BranchMst INNER JOIN
IpdRegistration ON BranchMst.BranchId = IpdRegistration.BranchId ON DepartmentMst.DeptId = IpdRegistration.DeptId ON IPDDischargeSummary.PatRegId = IpdRegistration.PatRegId AND 
IPDDischargeSummary.IpdNo = IpdRegistration.IpdNo AND IPDDischargeSummary.BranchId = IpdRegistration.BranchId ON HospEmpMst_1.DrId = IpdRegistration.SecodaryDoc LEFT OUTER JOIN
PatientInsuType ON IpdRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId ON PatMainType.PatMainTypeId = IpdRegistration.PatientMainCategoryId LEFT OUTER JOIN
PatientInsuType AS PatientInsuType_1 ON IpdRegistration.PatientSubCategoryId2 = PatientInsuType_1.PatientInsuTypeId LEFT OUTER JOIN
Tbl_Relation ON IpdRegistration.Relation1 = Tbl_Relation.RelationId LEFT OUTER JOIN
HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId LEFT OUTER JOIN
RoomType INNER JOIN
RoomMst ON RoomType.RTypeId = RoomMst.RTypeId INNER JOIN
BedMst ON RoomMst.RoomId = BedMst.RoomId INNER JOIN
AlloctnOfBed ON BedMst.BedId = AlloctnOfBed.BedId ON IpdRegistration.IpdId = AlloctnOfBed.IpdId LEFT OUTER JOIN
Initial INNER JOIN
PatientInformation ON Initial.TitleId = PatientInformation.TitleId INNER JOIN
Gender ON PatientInformation.GenderId = Gender.GenderId ON IpdRegistration.PatRegId = PatientInformation.PatientInfoId
			where (AlloctnOfBed.PatStatus='Discharged' or AlloctnOfBed.PatStatus='Admitted')  and dbo.IPDDischargeSummary.PatRegId= '214730' and  dbo.IPDDischargeSummary.IPDNO= '18299')
GO

ALTER VIEW [dbo].[Vw_DoctorWiseAdvanceReceipt] AS (SELECT dbo.BillPaymentTrns.BillNo, dbo.BillPaymentTrns.ReceivedAmount, dbo.BillPaymentTrns.PaymentDate, dbo.BillPaymentTrns.PatRegId, 
                 dbo.Initial.Title + ' ' + dbo.PatientInformation.FirstName AS PatientName, dbo.BillPaymentTrns.IsIpd, dbo.BillPaymentTrns.IpdNo, 
                 dbo.BillPaymentTrns.DiscountAmt, dbo.BillPaymentTrns.BalanceAmt, dbo.BillPaymentTrns.PaymentMode, dbo.BillPaymentTrns.BranchId, 
                 dbo.BillPaymentTrns.FId, dbo.BillPaymentTrns.CreatedBy, dbo.BillPaymentTrns.CreatedOn, dbo.BillPaymentTrns.IsDeposit, dbo.BillPaymentTrns.Remark, 
                 dbo.BillPaymentTrns.DrId, dbo.HospEmpMst.Title + ' ' + dbo.HospEmpMst.Empname AS DoctorName, dbo.BillPaymentTrns.IsInsurance, 
                 dbo.BillPaymentTrns.InsuranceAmount, dbo.BillPaymentTrns.InsuranceCompId, dbo.BillPaymentTrns.ReceiptNo
				FROM    dbo.Initial RIGHT OUTER JOIN
                 dbo.HospEmpMst RIGHT OUTER JOIN
                 dbo.BillPaymentTrns ON dbo.HospEmpMst.DrId = dbo.BillPaymentTrns.DrId LEFT OUTER JOIN
                 dbo.PatientInformation ON dbo.BillPaymentTrns.PatRegId = dbo.PatientInformation.PatRegId ON dbo.Initial.TitleId = dbo.PatientInformation.TitleId
				WHERE (dbo.BillPaymentTrns.DrId <> 0) AND (dbo.BillPaymentTrns.BillType = 'Advance Receipt') and BillPaymentTrns.IsIpd=1 and
				BillPaymentTrns.FId='1' and BillPaymentTrns.BranchId='1' and (CAST(CAST(YEAR( dbo.BillPaymentTrns.PaymentDate) AS varchar(4)) + '/' + CAST(MONTH( dbo.BillPaymentTrns.PaymentDate) AS varchar(2)) + '/' + CAST(DAY( dbo.BillPaymentTrns.PaymentDate) AS varchar(2)) AS datetime)) between '2022-08-24'  and '2022-11-23')
GO

ALTER VIEW [dbo].[Vw_DrWiseIncomeReport] AS SELECT        ProcedureServiceDetails.ProcedureServiceId AS BillServiceDetailId, ProcedureBillMaster.OPDNo, 0 AS IpdNo, ProcedureBillMaster.PatRegId, ProcedureBillMaster.BillGroupId, ProcedureServiceDetails.BillServiceId,   
ProcedureServiceDetails.DrId, ProcedureServiceDetails.FId, ProcedureServiceDetails.BranchId, ProcedureServiceDetails.CreatedBy, ProcedureServiceDetails.CreatedOn, ProcedureServiceDetails.UpdatedBy,   
ProcedureServiceDetails.UpdatedOn, HospEmpMst.Title + ' ' + HospEmpMst.Empname AS Empname, Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, ProcedureServiceDetails.CreatedOn AS EntryDate,   
PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress, PatientInformation.Age, PatientInformation.AgeType, PatientInformation.BirthDate, Initial.Title, ProcedureBillMaster.BillAmount,   
ProcedureBillMaster.AmountPaid, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.Details, ProcedureBillMaster.LetterNo, BillService.ServiceName, PatientInformation.ChiefComplant AS FileNumber,   
PatMainType.PatMainType, PatientInsuType.PatientInsuType  
FROM            PatientInformation INNER JOIN  
ProcedureBillMaster ON PatientInformation.PatRegId = ProcedureBillMaster.PatRegId INNER JOIN  
ProcedureServiceDetails ON ProcedureBillMaster.PatRegId = ProcedureServiceDetails.PatRegId AND ProcedureBillMaster.ProcedureId = ProcedureServiceDetails.ProcedureId INNER JOIN  
HospEmpMst ON ProcedureServiceDetails.DrId = HospEmpMst.DrId INNER JOIN  
BillService ON ProcedureServiceDetails.BillServiceId = BillService.BillServiceId INNER JOIN  
PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId INNER JOIN  
PatientInsuType ON ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN  
Initial ON PatientInformation.TitleId = Initial.TitleId  
WHERE        (ProcedureBillMaster.OPDNo > 0)  and ProcedureBillMaster.CancelBill=0
GO

ALTER VIEW [dbo].[Vw_EMRLabBillServiceDetails] AS (SELECT        Initial.Title + ' ' + PatientInformation.FirstName AS FirstName, LabEMRRegistration.PatRegId, LabEMRRegistration.Entrydate, LabEMRRegistration.RegistrationType, LabEMRRegistration.ReferenceDoc, 
LabEMRRegistration.CreatedBy, LabEMRRegistration.FId, LabEMRRegistration.BranchId, LabEMRRegistration.PatientComplaints, LabEMRRegistration.LabNo, LabEMRServiceDetails.BillServiceId, 
LabEMRServiceDetails.ServiceName + '' + CASE WHEN LabEMRServiceDetails.CancelBill = 1 THEN ' [Cancel Service]' ELSE '' END AS ServiceName, LabEMRServiceDetails.DrId, 
HospEmpMst.Title + ' ' + HospEmpMst.Empname AS Empname, LabEMRServiceDetails.BillServiceCharges, LabEMRServiceDetails.BillNo, LabEMRServiceDetails.Qty, 
LabEMRServiceDetails.BillServiceCharges AS SingleBillServiceCharges, LabEMRRegistration.TokenNo, Initial.Title, Gender.GenderName, DepartmentMst.DeptName, HospEmpMst.Title AS DrInitial, 
PatientInformation.PatientAddress, PatientInformation.MobileNo, PatMainType.PatMainType, LabEMRServiceDetails.ReceiptNo, PatientInformation.Age, PatientInformation.AgeType, LabEMRRegistration.LabPtype, 
LabEMRRegistration.ReferBy, LabEMRRegistration.PatientMainCategoryId, LabEMRRegistration.PatientSubCategoryId
FROM            LabEMRRegistration INNER JOIN
LabEMRServiceDetails ON LabEMRRegistration.LabNo = LabEMRServiceDetails.LabNo INNER JOIN
PatientInformation ON LabEMRRegistration.PatRegId = PatientInformation.PatRegId INNER JOIN
Initial ON PatientInformation.TitleId = Initial.TitleId INNER JOIN
Gender ON PatientInformation.GenderId = Gender.GenderId INNER JOIN
PatMainType ON LabEMRRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN
DepartmentMst ON LabEMRRegistration.DeptId = DepartmentMst.DeptId LEFT OUTER JOIN
HospEmpMst ON LabEMRServiceDetails.DrId = HospEmpMst.DrId

                 where 	 LabEMRRegistration.Labno='32052' and dbo.LabEMRRegistration.PatRegId='212820' and dbo.LabEMRRegistration.FId='1' and dbo.LabEMRRegistration.BranchId='1')
GO

CREATE VIEW [dbo].[VW_GenerateChargeNumber] AS (SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt, 
                         ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, ChargeBill_Master.BillGroupName, ChargeBill_Master.BillNo, 
                         ChargeBill_Master.PatientMainType, ChargeBill_Master.InsuCompanyId, ChargeBill_Master.CoverageDetails, PatientInsuType.PatientInsuType, PatientInformation.FirstName, PatientInformation.MobileNo, 
                         PatientInformation.PhoneNo, PatientInformation.PatientAddress, PatientInformation.Age, PatientInformation.AgeType, PatientInformation.BirthDate, PatientInsu_SubType.ChildCompanyName
FROM            ChargeBill_Master INNER JOIN
                         PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN
                         PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN
                         PatientInsu_SubType ON ChargeBill_Master.InsuCompanyId = PatientInsu_SubType.ID         
    where   dbo.ChargeBill_Master.Patregid='46250' and       
    CAST(CAST(YEAR(ChargeBill_Master.Createdon) AS varchar(4)) + '/' + CAST(MONTH(ChargeBill_Master.Createdon) AS varchar(2)) + '/' + CAST(DAY(ChargeBill_Master.Createdon) AS varchar(2)) AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime))
GO

ALTER VIEW [dbo].[VW_GetAllInsurance_details] AS (select isnull(HOSPITAL,0) as HOSPITAL, isnull(EEGOPD,0) as EEGOPD, isnull(OPD,0)as OPD, isnull(EMERGENCY,0)as EMERGENCY, isnull(OPTHAL,0)as OPTHAL,   isnull(AMBULANCE,0)as AMBULANCE,isnull(Radiology,0) as Radiology,isnull(Pathology,0)as Pathology,isnull(MedicalLab,0) as MedicalLab,isnull(Pharmacy,0)as Pharmacy,Patregid,Firstname,PatientInsuType,CreatedOn,BillNo,DateRange   from   (     select InsuranceAmt, Patregid,BillGroup,PatientInsuType,Firstname,CONVERT(DATE, CreatedOn) as CreatedOn, CONVERT(nvarchar(500),BillNo) as BillNo,'01/11/2022 TO 30/11/2022' as DateRange       from VW_GetAllInsurance   ) d   pivot   (     sum(InsuranceAmt)     for BillGroup in (HOSPITAL, EEGOPD, OPD, EMERGENCY, OPTHAL,AMBULANCE,Radiology,Pathology,MedicalLab,Pharmacy)   ) piv )
GO

CREATE VIEW [dbo].[VW_GetDataForm] AS (SELECT        PatientInformation.PatientInfoId, PatientInformation.PatRegId, PatientInformation.BarcodeId, PatientInformation.TitleId, PatientInformation.FirstName, PatientInformation.MiddleName, PatientInformation.LastName,   PatientInformation.PatMainTypeId, PatientInformation.PatientInsuTypeId, PatientInformation.PolicyNo, PatientInformation.GenderId, PatientInformation.BirthDate, PatientInformation.IsConfirmBirthDate,   PatientInformation.BloodGroup, PatientInformation.MaritalStatus, PatientInformation.GuardianTitleId, PatientInformation.GuardianName, PatientInformation.MobileNo, PatientInformation.PhoneNo,   PatientInformation.PatientAddress, PatientInformation.CountryId, PatientInformation.StateId, PatientInformation.CityId, PatientInformation.Email, PatientInformation.EntryDate, PatientInformation.ImagePath,   PatientInformation.CancelReason, PatientInformation.IsActive, PatientInformation.CreatedBy, PatientInformation.CreatedOn, PatientInformation.UpdatedBy, PatientInformation.UpdatedOn, PatientInformation.Age,   PatientInformation.AgeType, PatientInformation.BranchId, PatientInformation.FId, PatientInformation.Nationality, PatientInformation.BirthPlace, PatientInformation.VaccinationStatus, PatientInformation.Allergy,    PatientInformation.ChiefComplant, PatientInformation.ReligionId, PatientInformation.HealthCardNo, PatientInformation.PassportNo, PatientInformation.RaceId, PatientInformation.Relation, PatientInformation.RelativeName,   PatientInformation.ContactNo, PatientInformation.RelaAddress, PatientInformation.Relation1, PatientInformation.RelativeName1, PatientInformation.ContactNo1, PatientInformation.RelaAddress1, Tbl_Race.RaceName,   ReligionMst.Religion, Gender.GenderName, Tbl_Relation.RelationName, Tbl_Relation_1.RelationName AS RelationName2,PatientInformation.ChiefComplant as TTT FROM            PatientInformation LEFT OUTER JOIN   Tbl_Relation ON PatientInformation.Relation = Tbl_Relation.RelationId LEFT OUTER JOIN   Tbl_Relation AS Tbl_Relation_1 ON PatientInformation.Relation1 = Tbl_Relation_1.RelationId LEFT OUTER JOIN   Gender ON PatientInformation.GenderId = Gender.GenderId LEFT OUTER JOIN   ReligionMst ON PatientInformation.ReligionId = ReligionMst.ReligionID LEFT OUTER JOIN   Tbl_Race ON PatientInformation.RaceId = Tbl_Race.RaceID  where PatientInformation.branchid=1  and  PatientInformation.PatRegId= 134677)
GO

ALTER VIEW [dbo].[VW_GetPatientInformation] AS (SELECT        PatientInformation.PatientInfoId, PatientInformation.PatRegId, PatientInformation.BarcodeId, PatientInformation.TitleId,    Initial.Title +' '+PatientInformation.FirstName as PatientName, PatientInformation.MiddleName, PatientInformation.LastName,     PatientInformation.PatMainTypeId, PatientInformation.PatientInsuTypeId, PatientInformation.PolicyNo, PatientInformation.GenderId, PatientInformation.BirthDate, PatientInformation.IsConfirmBirthDate,    PatientInformation.BloodGroup, PatientInformation.MaritalStatus, PatientInformation.GuardianTitleId, PatientInformation.GuardianName, PatientInformation.MobileNo, PatientInformation.PhoneNo,    PatientInformation.PatientAddress, PatientInformation.CountryId, PatientInformation.StateId, PatientInformation.CityId, PatientInformation.Email, PatientInformation.EntryDate, PatientInformation.ImagePath,    PatientInformation.CancelReason, PatientInformation.IsActive, PatientInformation.CreatedBy, PatientInformation.CreatedOn, PatientInformation.UpdatedBy, PatientInformation.UpdatedOn, PatientInformation.Age,    PatientInformation.AgeType, PatientInformation.BranchId, PatientInformation.FId, 0 as TokenNo,  0 as VisitingNo,  ' ' as DeptName,0 as DrId,0 as OpdNo,0 as IpdNo,' ' as DrName, Gender.GenderName    FROM            PatientInformation INNER JOIN    Initial ON PatientInformation.TitleId = Initial.TitleId INNER JOIN    Gender ON PatientInformation.GenderId = Gender.GenderId  where  PatientInformation.PatRegId='11427'  and PatientInformation.branchid ='1'  )
GO

ALTER VIEW [dbo].[Vw_GetPatientPatientHistoryForm] AS (SELECT DISTINCT 
Initial.Title, PatientInformation.PatientInfoId, PatientInformation.PatRegId, PatientInformation.BarcodeId, PatientInformation.TitleId, PatientInformation.FirstName, Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, 
PatientInformation.MiddleName, PatientInformation.LastName, PatientInformation.PatMainTypeId, PatientInformation.PatientInsuTypeId, PatientInformation.PolicyNo, PatientInformation.GenderId, PatientInformation.BirthDate, 
PatientInformation.IsConfirmBirthDate, PatientInformation.BloodGroup, PatientInformation.MaritalStatus, PatientInformation.GuardianTitleId, PatientInformation.GuardianName, PatientInformation.MobileNo, 
PatientInformation.PhoneNo, PatientInformation.PatientAddress, PatientInformation.CountryId, PatientInformation.StateId, PatientInformation.CityId, PatientInformation.Email, PatientInformation.EntryDate, 
PatientInformation.ImagePath, PatientInformation.CancelReason, PatientInformation.IsActive, PatientInformation.UpdatedBy, PatientInformation.UpdatedOn, PatientInformation.Age, PatientInformation.AgeType, 
IpdRegistration.IpdNo, Gender.GenderName, HospEmpMst.Title + ' ' + HospEmpMst.Empname AS DrName, 0 AS TokenNo, IpdRegistration.VisitingNo, DepartmentMst.DeptName, IpdRegistration.PrimaryDoc AS DrId, 
PatientInformation.FId, PatientInformation.BranchId, PatientHistoryForm.OpdNo, PatientHistoryForm.IsMedicalHis, PatientHistoryForm.MedicalHis, PatientHistoryForm.IsMedication, PatientHistoryForm.MedicationHistory, 
PatientHistoryForm.IsSurgical, PatientHistoryForm.SurgicalHistory, PatientHistoryForm.IsGynae, PatientHistoryForm.GynaeHistory, PatientHistoryForm.IsAllergy, PatientHistoryForm.AllergyHistory, PatientHistoryForm.IsFamily, 
PatientHistoryForm.FamilyHistory, PatientHistoryForm.IsSmoking, PatientHistoryForm.SmokingDuration, PatientHistoryForm.SmokingQty, PatientHistoryForm.IsAlco, PatientHistoryForm.AlcoDuration, 
PatientHistoryForm.AlcoQty, PatientHistoryForm.CreatedBy, PatientHistoryForm.CreatedOn
FROM            PatientInformation INNER JOIN
IpdRegistration ON PatientInformation.PatRegId = IpdRegistration.PatRegId INNER JOIN
PatientHistoryForm ON PatientInformation.PatRegId = PatientHistoryForm.PatregId LEFT OUTER JOIN
HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId LEFT OUTER JOIN
DepartmentMst ON IpdRegistration.DeptId = DepartmentMst.DeptId LEFT OUTER JOIN
Initial ON PatientInformation.TitleId = Initial.TitleId LEFT OUTER JOIN
Gender ON PatientInformation.GenderId = Gender.GenderId  where PatientHistoryForm.PatRegId=178320 and PatientHistoryForm.IpdNo=16974)
GO

ALTER VIEW [dbo].[Vw_GetPatientPhiscalExam] AS (SELECT DISTINCT 
Initial.Title, PatientInformation.PatientInfoId, PatientInformation.PatRegId, PatientInformation.BarcodeId, PatientInformation.TitleId, PatientInformation.FirstName, Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, 
PatientInformation.MiddleName, PatientInformation.LastName, PatientInformation.PatMainTypeId, PatientInformation.PatientInsuTypeId, PatientInformation.PolicyNo, PatientInformation.GenderId, PatientInformation.BirthDate, 
PatientInformation.IsConfirmBirthDate, PatientInformation.BloodGroup, PatientInformation.MaritalStatus, PatientInformation.GuardianTitleId, PatientInformation.GuardianName, PatientInformation.MobileNo, 
PatientInformation.PhoneNo, PatientInformation.PatientAddress, PatientInformation.CountryId, PatientInformation.StateId, PatientInformation.CityId, PatientInformation.Email, PatientInformation.EntryDate, 
PatientInformation.ImagePath, PatientInformation.CancelReason, PatientInformation.IsActive, PatientInformation.UpdatedBy, PatientInformation.UpdatedOn, 
PatientInformation.Age, PatientInformation.AgeType, IpdRegistration.IpdNo, Gender.GenderName, HospEmpMst.Title + ' ' + HospEmpMst.Empname AS DrName, 0 AS TokenNo, IpdRegistration.VisitingNo, 
DepartmentMst.DeptName, IpdRegistration.PrimaryDoc AS DrId, PatientInformation.FId, PatientInformation.BranchId, PhysicalExam.Bedsore, PhysicalExam.OpdNo, PhysicalExam.Dentures, 
PhysicalExam.Spectacles, PhysicalExam.CheckPhInj, PhysicalExam.PhysicalInjuries, PhysicalExam.CheckFoleys, PhysicalExam.CheckNGTube, PhysicalExam.CheckIntraCath, PhysicalExam.PhysicalSize, 
PhysicalExam.CheckCentralLine, PhysicalExam.CentralLine, PhysicalExam.CheckImpDevice, PhysicalExam.ImpDevice, PhysicalExam.CheckJewellery, PhysicalExam.CheckJewellerytofami, PhysicalExam.CheckPatfamily, 
PhysicalExam.signature, PhysicalExam.Relationship, PhysicalExam.OtherRemark, PhysicalExam.NurseRemark, PhysicalExam.CreatedBy, PhysicalExam.CreatedOn 
FROM            PatientInformation INNER JOIN
IpdRegistration ON PatientInformation.PatRegId = IpdRegistration.PatRegId INNER JOIN
PhysicalExam ON PatientInformation.PatRegId = PhysicalExam.PatregId LEFT OUTER JOIN
HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId LEFT OUTER JOIN
DepartmentMst ON IpdRegistration.DeptId = DepartmentMst.DeptId LEFT OUTER JOIN
Initial ON PatientInformation.TitleId = Initial.TitleId LEFT OUTER JOIN
Gender ON PatientInformation.GenderId = Gender.GenderId  where PhysicalExam.PatRegId=141556 and PhysicalExam.IpdNo=15135)
GO

ALTER VIEW [dbo].[VW_GetPrescription] AS (SELECT        tbl_Treatment.TreatmentId, tbl_Treatment.FollowUpDate, tbl_Treatment.PatientRegId, tbl_Treatment.Opd, tbl_Treatment.Ipd, tbl_Treatment.BranchId, tbl_Treatment.CreatedBy, tbl_Treatment.CreatedOn, tbl_Treatment.UpdatedBy,     tbl_Treatment.UpdatedOn, tbl_Treatment.DrId, Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, Initial.Title, Gender.GenderName, PatientInformation.MobileNo, PatientInformation.PhoneNo,    PatientInformation.PatientAddress, PatientInformation.Age, PatientInformation.AgeType, tbl_TreatmentTransaction.DrugName, tbl_TreatmentTransaction.FrequencyType, tbl_TreatmentTransaction.Qty,    tbl_TreatmentTransaction.Days, tbl_TreatmentTransaction.StartDate, tbl_TreatmentTransaction.EndDate, tbl_TreatmentTransaction.Note, tbl_TreatmentTransaction.Dose,    HospEmpMst.Title + ' ' + HospEmpMst.Empname AS DrName, DepartmentMst.DeptName, HospEmpMst.EmployeeType, tbl_GeneralEmrTransaction.Diagnosis, HospEmpMst.DrSignature    FROM   Mercy_Pharma_New.dbo.PatientIssueVoucher INNER JOIN    tbl_Treatment INNER JOIN    PatientInformation ON tbl_Treatment.PatientRegId = PatientInformation.PatRegId AND tbl_Treatment.BranchId = PatientInformation.BranchId INNER JOIN    Initial ON PatientInformation.TitleId = Initial.TitleId INNER JOIN    Gender ON PatientInformation.GenderId = Gender.GenderId INNER JOIN    tbl_TreatmentTransaction ON tbl_Treatment.TreatmentId = tbl_TreatmentTransaction.TreatmentId INNER JOIN    HospEmpMst ON tbl_Treatment.DrId = HospEmpMst.DrId INNER JOIN    DepartmentMst ON HospEmpMst.DeptId = DepartmentMst.DeptId ON Mercy_Pharma_New.dbo.PatientIssueVoucher.TreatmentId = tbl_Treatment.TreatmentId LEFT OUTER JOIN    tbl_GeneralEmrTransaction INNER JOIN   tbl_GeneralEMR ON tbl_GeneralEmrTransaction.EmrId = tbl_GeneralEMR.EmrId ON tbl_Treatment.PatientRegId = tbl_GeneralEMR.Patientregid AND tbl_Treatment.Opd = tbl_GeneralEMR.opd AND     tbl_Treatment.Ipd = tbl_GeneralEMR.ipd AND tbl_Treatment.BranchId = tbl_GeneralEMR.branchid  where tbl_Treatment.PatientRegId= 0 and tbl_Treatment.branchid=1 and (tbl_Treatment.TreatmentId = 0)    )
GO

CREATE VIEW [dbo].[Vw_InsuranceCompTransactionLedge_ForOPD] AS (SELECT dbo.InsuranceCompPaymentTransactions_ForOPD.CreditAmount, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentMode,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.ReceiptNo, dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser, dbo.PatientInsuType.PatientInsuType,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.ChequeNo, dbo.InsuranceCompPaymentTransactions_ForOPD.ChequeDate,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.BankName, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentDate,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.TransactionType, dbo.InsuranceCompPaymentTransactions_ForOPD.FId,   
				dbo.InsuranceCompPaymentTransactions_ForOPD.BranchId,dbo.InsuranceCompPaymentTransactions_ForOPD.CreatedBy, dbo.InsuranceCompPaymentTransactions_ForOPD.DebitAmount  
				FROM    dbo.InsuranceCompPaymentTransactions_ForOPD LEFT OUTER JOIN  
				dbo.PatientInsuType ON dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser = dbo.PatientInsuType.PatientInsuTypeId       
				where   dbo.InsuranceCompPaymentTransactions_ForOPD.FId='1' and   
				dbo.InsuranceCompPaymentTransactions_ForOPD.BranchId='1' and  CONVERT(date, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentDate)  between '2023-03-01'  and '2023-03-17' and dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser='7')
GO

CREATE VIEW [dbo].[Vw_InsurancePaymentReceipt_OPD] AS (SELECT dbo.InsuranceCompPaymentTransactions_ForOPD.CreditAmount, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentMode,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.ReceiptNo, dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser, dbo.PatientInsuType.PatientInsuType,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.ChequeNo, dbo.InsuranceCompPaymentTransactions_ForOPD.ChequeDate,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.BankName, dbo.InsuranceCompPaymentTransactions_ForOPD.PaymentDate,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.TransactionType, dbo.InsuranceCompPaymentTransactions_ForOPD.FId,   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.BranchId,dbo.InsuranceCompPaymentTransactions_ForOPD.CreatedBy, dbo.InsuranceCompPaymentTransactions_ForOPD.DebitAmount  
      FROM    dbo.InsuranceCompPaymentTransactions_ForOPD LEFT OUTER JOIN  
                 dbo.PatientInsuType ON dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser = dbo.PatientInsuType.PatientInsuTypeId 
     where InsuranceCompPaymentTransactions_ForOPD.ReceiptNo=  '1' and   
     dbo.InsuranceCompPaymentTransactions_ForOPD.FId='1' and   
                 dbo.InsuranceCompPaymentTransactions_ForOPD.BranchId='1' and   
     dbo.InsuranceCompPaymentTransactions_ForOPD.TransactionType='Credit' and dbo.InsuranceCompPaymentTransactions_ForOPD.Sponser='43')
GO

ALTER VIEW [dbo].[Vw_InsuranceSummary] AS (SELECT RoomType.RType,IpdRegistration.IpdNo, IpdRegistration.PatRegId, IpdRegistration.IpdId, IpdRegistration.EntryDate, 
                 IpdRegistration.EntryTime, IpdRegistration.IsAdmited, IpdRegistration.FId, IpdRegistration.BranchId, 
                  AlloctnOfBed.PatStatus, AlloctnOfBed.DateOfAdmission, 
                 RoomMst.RTypeId, PatientInformation.FirstName,Initial.Title, ISNULL(IpdBillMaster.BillAmount, 0) AS BillAmount, 
                 ISNULL(IpdBillMaster.InvoiceNo, 0) AS InvoiceNo, IpdRegistration.PatientSubCategoryId, PatientInsuType.PatientInsuType, 
                 ISNULL(InsurancePaymentDetails.Sponsor1Amt, 0) AS Sponsor1Amt, 
                 ISNULL(InsurancePaymentDetails.TotalInsuranceGrand, 0) AS TotalInsuranceGrand, ISNULL(InsurancePaymentDetails.SponsorStatus, '') AS SponsorStatus, 
                 AlloctnOfBed.DateOfDischarge, IpdBillMaster.InsuranceAmt
FROM    IpdBillMaster INNER JOIN
                 IpdRegistration ON IpdBillMaster.IpdId = IpdRegistration.IpdId AND IpdBillMaster.IpdNo = IpdRegistration.IpdNo AND 
                 IpdBillMaster.PatRegId = IpdRegistration.PatRegId INNER JOIN
                 PatientInsuType ON IpdRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN
                 InsurancePaymentDetails ON IpdRegistration.PatRegId = InsurancePaymentDetails.PatRegId AND 
                 IpdRegistration.IpdNo = InsurancePaymentDetails.IPDNo LEFT OUTER JOIN
                 PatientInformation LEFT OUTER JOIN
                 Initial ON PatientInformation.TitleId = Initial.TitleId ON IpdRegistration.PatRegId = PatientInformation.PatRegId LEFT OUTER JOIN
                 BedMst INNER JOIN
                 AlloctnOfBed ON BedMst.BedId = AlloctnOfBed.BedId INNER JOIN
                 RoomMst ON BedMst.RoomId = RoomMst.RoomId INNER JOIN
                 RoomType ON RoomMst.RTypeId = RoomType.RTypeId ON IpdRegistration.IpdId = AlloctnOfBed.IpdId
				 WHERE        (IpdBillMaster.IsDischarge = 1)  AND (AlloctnOfBed.PatStatus = 'Discharged') 
				AND (IpdRegistration.PatientSubCategoryId <> 1)
					and  IpdRegistration.FId='1' and IpdRegistration.BranchId='1' and CONVERT(date, IpdBillMaster.FinalDischargeOn) 	between '2022-11-10'and '2022-12-07' union SELECT RoomType.RType, IpdRegistration.IpdNo, IpdRegistration.PatRegId, IpdRegistration.IpdId, IpdRegistration.EntryDate, 
                 IpdRegistration.EntryTime, IpdRegistration.IsAdmited, IpdRegistration.FId, IpdRegistration.BranchId, 
                  AlloctnOfBed.PatStatus, AlloctnOfBed.DateOfAdmission, 
                 RoomMst.RTypeId, PatientInformation.FirstName, Initial.Title, ISNULL(IpdBillMaster.BillAmount, 0) AS BillAmount, 
                 ISNULL(IpdBillMaster.InvoiceNo, 0) AS InvoiceNo, IpdRegistration.PatientSubCategoryId2 as PatientSubCategoryId, PatientInsuType.PatientInsuType, 
                 ISNULL(InsurancePaymentDetails.Sponsor2Amt, 0) AS Sponsor1Amt, 
                 ISNULL(InsurancePaymentDetails.TotalInsuranceGrand, 0) AS TotalInsuranceGrand, ISNULL(InsurancePaymentDetails.SponsorStatus, '') AS SponsorStatus, 
                 AlloctnOfBed.DateOfDischarge, IpdBillMaster.InsuranceAmt
FROM    IpdBillMaster INNER JOIN
                 IpdRegistration ON IpdBillMaster.IpdId = IpdRegistration.IpdId AND IpdBillMaster.IpdNo = IpdRegistration.IpdNo AND 
                 IpdBillMaster.PatRegId = IpdRegistration.PatRegId INNER JOIN
                 PatientInsuType ON IpdRegistration.PatientSubCategoryId2 = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN
                 InsurancePaymentDetails ON IpdRegistration.PatRegId = InsurancePaymentDetails.PatRegId AND 
                 IpdRegistration.IpdNo = InsurancePaymentDetails.IPDNo LEFT OUTER JOIN
                 PatientInformation LEFT OUTER JOIN
                 Initial ON PatientInformation.TitleId = Initial.TitleId ON IpdRegistration.PatRegId = PatientInformation.PatRegId LEFT OUTER JOIN
                 BedMst INNER JOIN
                 AlloctnOfBed ON BedMst.BedId = AlloctnOfBed.BedId INNER JOIN
                 RoomMst ON BedMst.RoomId = RoomMst.RoomId INNER JOIN
                 RoomType ON RoomMst.RTypeId = RoomType.RTypeId ON IpdRegistration.IpdId = AlloctnOfBed.IpdId
				 
WHERE        (IpdBillMaster.IsDischarge = 1) AND  (AlloctnOfBed.PatStatus = 'Discharged') 
AND (IpdRegistration.PatientSubCategoryId <> 1)
	and  IpdRegistration.FId='1' and IpdRegistration.BranchId='1' and CONVERT(date, IpdRegistration.EntryDate) 	between '2022-11-10'and '2022-12-07')
GO

ALTER VIEW [dbo].[Vw_InsuranceSummaryForLabNew] AS ( SELECT        CASE WHEN LabRegistration.LabPtype = 'P' THEN 'Pathology' WHEN LabRegistration.LabPtype = 'R' THEN 'Radiology' ELSE 'Medical Store' END AS BillGroup,
LabRegistration.LabPtype,LabBillPaymentTrns.PatRegId, PatientInsuType.PatientInsuType,LabBillPaymentTrns.BillAmount,LabBillPaymentTrns.ReceivedAmount as AmtPaid,
LabBillPaymentTrns.DiscountAmt,LabBillPaymentTrns.InsuranceAmount, LabBillPaymentTrns.BillNo,Initial.Title, PatientInformation.FirstName,
LabBillPaymentTrns.PaymentDate,   LabBillPaymentTrns.CreatedBy, 
LabBillPaymentTrns.CreatedOn,
LabBillPaymentTrns.FId, LabBillPaymentTrns.BranchId, 
PatMainType.PatMainType,   
LabRegistration.PatientSubCategoryId FROM            LabBillPaymentTrns INNER JOIN
LabRegistration ON LabBillPaymentTrns.PatRegId = LabRegistration.PatRegId AND LabBillPaymentTrns.LabNo = LabRegistration.LabNo INNER JOIN
PatMainType ON LabRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId INNER JOIN
PatientInsuType ON PatMainType.PatMainTypeId = PatientInsuType.PatMainTypeId AND LabRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN
Initial RIGHT OUTER JOIN
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON LabBillPaymentTrns.PatRegId = PatientInformation.PatientInfoId

						WHERE (LabRegistration.CancelBill <> 1) 	AND (LabRegistration.PatientSubCategoryId <> 1)
	                   and  LabBillPaymentTrns.FId='1' and LabBillPaymentTrns.BranchId='1' and CONVERT(date, LabBillPaymentTrns.CreatedOn) 	between '2023-03-01'and '2023-03-22')
GO

CREATE VIEW [dbo].[Vw_InsuranceSummaryForLabNew_Child] AS ( SELECT        LabRegistration.LabNo, LabRegistration.BillNo, LabRegistration.TokenNo, LabRegistration.PatRegId, LabRegistration.DrId, LabRegistration.VisitingNo, LabRegistration.Entrydate, LabRegistration.RegistrationType, 
LabRegistration.ReferenceDoc, LabRegistration.DeptId, LabRegistration.PatientComplaints, LabRegistration.PatientMainCategoryId, LabRegistration.PatientSubCategoryId, LabRegistration.FId, LabRegistration.BranchId, 
LabRegistration.CreatedBy, LabRegistration.CreatedOn, LabRegistration.UpdatedBy, LabRegistration.UpdatedOn, LabRegistration.IsPatientChecked, LabRegistration.ReferBy, LabRegistration.LabPtype, 
LabRegistration.CancelBill, LabRegistration.CancelBy, LabRegistration.CancelRemark, LabRegistration.CancelOn, LabRegistration.MainDoctor, LabRegistration.QRImage, LabRegistration.ClinicalHistory, LabRegistration.IPDNO,
LabRegistration.AfterHrs, LabRegistration.InsuranceChargeCompany, LabRegistration.LetterNo, LabServiceDetails.ServiceName
FROM            LabRegistration INNER JOIN
LabServiceDetails ON LabRegistration.PatRegId = LabServiceDetails.PatRegId AND LabRegistration.LabNo = LabServiceDetails.LabNo
  
      WHERE (LabRegistration.CancelBill <> 1)  AND (LabRegistration.PatientSubCategoryId <> 1)    and CONVERT(date, LabRegistration.CreatedOn)  between '2023-03-01'and '2023-03-22')
GO

ALTER VIEW [dbo].[Vw_InsuranceSummaryForProcedure] AS ( SELECT ProcedureBillMaster.PatRegId, PatientInsuType.PatientInsuType, ProcedureBillMaster.BillAmount, ProcedureBillMaster.AmountPaid, 
						ProcedureBillMaster.Discount, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.BillGroup, ProcedureBillMaster.BillNo, ProcedureBillMaster.FId, 
						ProcedureBillMaster.BranchId, ProcedureBillMaster.CreatedBy, ProcedureBillMaster.CreatedOn, ProcedureBillMaster.PatientSubType, Initial.Title +' '+ 
						PatientInformation.FirstName as FirstName , ProcedureBillMaster.CancelBill,dbo.ProcedureBillMaster.Details FROM  Initial RIGHT OUTER JOIN
						PatientInformation ON Initial.TitleId = PatientInformation.TitleId RIGHT OUTER JOIN
						ProcedureBillMaster ON PatientInformation.PatRegId = ProcedureBillMaster.PatRegId LEFT OUTER JOIN
						PatientInsuType ON ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId
						WHERE (ProcedureBillMaster.CancelBill <> 1) 	AND (ProcedureBillMaster.PatientSubType <> 1)
	                   and  ProcedureBillMaster.FId='1' and ProcedureBillMaster.BranchId='1' and CONVERT(date, ProcedureBillMaster.CreatedOn) 	between '2023-03-09'and '2023-03-09' and ProcedureBillMaster.PatRegId = '133653' and ProcedureBillMaster.PatientSubType = '186')
GO

ALTER VIEW [dbo].[Vw_IntakeOutputSheet] AS (SELECT dbo.CTuser.Name, dbo.tbl_IntakeOutputChart.* FROM  dbo.tbl_IntakeOutputChart LEFT OUTER JOIN dbo.CTuser ON dbo.tbl_IntakeOutputChart.UserId = dbo.CTuser.CUId where tbl_IntakeOutputChart.PatRegId=178320 and tbl_IntakeOutputChart.IpdNo=16974 and tbl_IntakeOutputChart.OpdNo=0)
GO

ALTER VIEW [dbo].[Vw_IpdAdmissionRegister] AS (SELECT RoomType.RType, RoomMst.RoomName, IpdRegistration.IpdNo, IpdRegistration.PatRegId, IpdRegistration.IpdId, IpdRegistration.EntryDate, 
                 IpdRegistration.EntryTime, IpdRegistration.DeptId, IpdRegistration.PrimaryDoc, IpdRegistration.ReferenceDoc, IpdRegistration.PatientMainCategoryId, 
                  dbo.AlloctnOfBed.BedId,IpdRegistration.IsAdmited, IpdRegistration.CreatedBy, IpdRegistration.CreatedOn, IpdRegistration.FId, IpdRegistration.BranchId, 
                 IpdRegistration.UpdatedBy, IpdRegistration.UpdatedOn, IpdRegistration.IsUniversalPrecaution, IpdRegistration.IsEmergency, BedMst.BedName, 
                 AlloctnOfBed.PatStatus, RoomMst.RTypeId, Initial.Title + ' ' + PatientInformation.FirstName AS PatientName, 
                 HospEmpMst.Title + ' ' + HospEmpMst.Empname AS DoctorName, ISNULL(IpdBillMaster.BillAmount, 0) AS BillAmount, ISNULL(IpdBillMaster.InvoiceNo, 0) 
                 AS InvoiceNo, ISNULL(IpdBillMaster.AmountReceived, 0) AS AmountReceived, ISNULL(IpdBillMaster.BillAmount, 0) - (ISNULL(IpdBillMaster.AmountReceived, 0) 
                 + ISNULL(IpdBillMaster.Discount, 0)) AS Balance, IpdBillMaster.Discount, IpdBillMaster.InsuranceAmt, IpdBillMaster.IsDischarge, PatMainType.PatMainType, 
                 PatientInsuType.PatientInsuType, AlloctnOfBed.DateOfDischarge, AlloctnOfBed.DischargeTime, AlloctnOfBed.ReasonforDischarge, AlloctnOfBed.DischargedBy, 
                 IpdBillMaster.BillNo, IpdRegistration.PatientSubCategoryId,dbo.PatientInformation.PatientAddress, 
                 dbo.PatientInformation.MobileNo
FROM    BedMst INNER JOIN
                 AlloctnOfBed ON BedMst.BedId = AlloctnOfBed.BedId INNER JOIN
                 RoomMst ON BedMst.RoomId = RoomMst.RoomId INNER JOIN
                 RoomType ON RoomMst.RTypeId = RoomType.RTypeId LEFT OUTER JOIN
                 IpdRegistration ON AlloctnOfBed.IpdId = IpdRegistration.IpdId LEFT OUTER JOIN
                 PatientInsuType ON IpdRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN
                 PatMainType ON IpdRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN
                 IpdBillMaster ON IpdRegistration.IpdId = IpdBillMaster.IpdId LEFT OUTER JOIN
                 PatientInformation LEFT OUTER JOIN
                 Initial ON PatientInformation.TitleId = Initial.TitleId ON IpdRegistration.PatRegId = PatientInformation.PatRegId LEFT OUTER JOIN
                 HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId where AlloctnOfBed.PatStatus<>'Shifted' and IpdRegistration.CancelAdmission<>1 and
				  IpdRegistration.FId='1' and IpdRegistration.BranchId='1' and (CAST(CAST(YEAR( dbo.IpdRegistration.EntryDate) AS varchar(4)) + '/' + CAST(MONTH( dbo.IpdRegistration.EntryDate) AS varchar(2)) + '/' + CAST(DAY( dbo.IpdRegistration.EntryDate) AS varchar(2)) AS datetime)) between '2022-11-01'  and '2022-11-30' and IpdRegistration.PrimaryDoc = '3' and RoomMst.RTypeId = '7')
GO

ALTER VIEW [dbo].[Vw_IpdBillPaymentReceipt] AS (SELECT DISTINCT 
BillPaymentTrns.BillNo, BillPaymentTrns.ReceiptNo, Vw_IPDPatientDetails.FirstName AS PatientName, Vw_IPDPatientDetails.PatRegId, BillPaymentTrns.ReceivedAmount, BillPaymentTrns.DiscountAmt, 
BillPaymentTrns.BalanceAmt, BillPaymentTrns.BankName, BillPaymentTrns.ChequeDate, BillPaymentTrns.ChequeNo, BillPaymentTrns.PaymentMode, BillPaymentTrns.PaymentDate, Vw_IPDPatientDetails.EntryDate, 
Vw_IPDPatientDetails.ReferenceDoc, BillPaymentTrns.CreatedBy, BillPaymentTrns.DiscGivenBy, BillPaymentTrns.ReasonForBalance, BillPaymentTrns.ReasonForDisc, BillPaymentTrns.UpdatedOn, 
HospEmpMst.Empname AS DiscountGivenBy, DiscountTypeMst.DiscType, ReasonForBalance.ReasonForBalanceName, BillPaymentTrns.BranchId, BillPaymentTrns.FId, ModeOfPayment.ModeOfPaymentName, 
BillPaymentTrns.OpdNo, BillPaymentTrns.IpdNo, BillPaymentTrns.BillType, BillPaymentTrns.CreatedOn, Vw_IPDPatientDetails.Age, Vw_IPDPatientDetails.AgeType, Vw_IPDPatientDetails.GenderName, BillPaymentTrns.Remark, 
Vw_IPDPatientDetails.PatientAddress, HospEmpMst.Empname as DrName
FROM            Vw_IPDPatientDetails INNER JOIN
BillPaymentTrns ON Vw_IPDPatientDetails.PatRegId = BillPaymentTrns.PatRegId AND Vw_IPDPatientDetails.IpdNo = BillPaymentTrns.IpdNo INNER JOIN
ModeOfPayment ON BillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId LEFT OUTER JOIN
HospEmpMst ON BillPaymentTrns.DrId = HospEmpMst.DrId LEFT OUTER JOIN
DiscountTypeMst ON BillPaymentTrns.ReasonForDisc = DiscountTypeMst.DiscTypeId LEFT OUTER JOIN
ReasonForBalance ON BillPaymentTrns.ReasonForBalance = ReasonForBalance.ReasonForBalanceId
                 where BillPaymentTrns.BillNo='18356' and dbo.BillPaymentTrns.ReceiptNo= '38455' and 
				 BillPaymentTrns.IpdNo='18356' and dbo.BillPaymentTrns.PatRegId='76430' and dbo.BillPaymentTrns.FId='1'
				  and dbo.BillPaymentTrns.BranchId='1')
GO

ALTER VIEW [dbo].[Vw_IpdBillTransactionReport] AS (SELECT dbo.BillPaymentTrns.BillPaymentId, dbo.BillPaymentTrns.BillNo, dbo.BillPaymentTrns.ReceiptNo, dbo.BillPaymentTrns.PatRegId, 
                 dbo.BillPaymentTrns.PaymentDate, dbo.fn_ReceivedAmount(dbo.BillPaymentTrns.BillPaymentId, dbo.BillPaymentTrns.ReceivedAmount) AS ReceivedAmount, 
                 dbo.BillPaymentTrns.OpdNo, dbo.BillPaymentTrns.IpdNo, dbo.BillPaymentTrns.IsOpd, dbo.BillPaymentTrns.IsIpd, dbo.BillPaymentTrns.BillType, 
                 dbo.BillPaymentTrns.FId, dbo.BillPaymentTrns.PaymentMode, dbo.BillPaymentTrns.BranchId, dbo.BillPaymentTrns.CreatedBy, dbo.BillPaymentTrns.UpdatedBy, 
                 dbo.BillPaymentTrns.UpdatedOn, dbo.BillPaymentTrns.CreatedOn, dbo.ModeOfPayment.ModeOfPaymentName, dbo.BillPaymentTrns.CancelAdmission, 
                 dbo.BillPaymentTrns.IsDeposit, dbo.BillPaymentTrns.DrId, dbo.HospEmpMst.Empname, dbo.Initial.Title + ' ' + dbo.PatientInformation.FirstName AS PatientName, 
                 dbo.fn_PaymentType(dbo.BillPaymentTrns.BillPaymentId) AS PaymentType
FROM    dbo.Initial RIGHT OUTER JOIN
                 dbo.PatientInformation ON dbo.Initial.TitleId = dbo.PatientInformation.TitleId RIGHT OUTER JOIN
                 dbo.BillPaymentTrns ON dbo.PatientInformation.PatRegId = dbo.BillPaymentTrns.PatRegId LEFT OUTER JOIN
                 dbo.HospEmpMst ON dbo.BillPaymentTrns.DrId = dbo.HospEmpMst.DrId LEFT OUTER JOIN
                 dbo.ModeOfPayment ON dbo.BillPaymentTrns.PaymentMode = dbo.ModeOfPayment.ModeOfPaymentId
WHERE (dbo.BillPaymentTrns.IsOpd <> 1) and  dbo.BillPaymentTrns.FId='1' and  dbo.BillPaymentTrns.BranchId='1' and (CAST(CAST(YEAR(dbo.BillPaymentTrns.PaymentDate) AS varchar(4)) + '/' + CAST(MONTH(dbo.BillPaymentTrns.PaymentDate) AS varchar(2)) + '/' + CAST(DAY(dbo.BillPaymentTrns.PaymentDate) AS varchar(2)) AS datetime)) between '2022-12-13'  and '2022-12-13' and dbo.BillPaymentTrns.CreatedBy = 'natasha')
GO

ALTER VIEW [dbo].[Vw_IpdInfoForBillServiceDetail] AS (SELECT dbo.IpdRegistration.IpdNo, dbo.Initial.Title + ' ' + dbo.PatientInformation.FirstName AS PatientName, dbo.PatientInformation.MobileNo,
			 dbo.IpdRegistration.IpdId,dbo.IpdRegistration.PatRegId, ISNULL(dbo.IpdBillMaster.AmountReceived, 0) AS AmountReceived, ISNULL(dbo.IpdBillMaster.BillAmount, 0) AS BillAmount, 
                 ISNULL(dbo.IpdBillMaster.Discount, 0) AS Discount, ISNULL(dbo.IpdBillMaster.InsuranceAmt, 0) AS InsuranceAmt, ISNULL(dbo.IpdBillMaster.BillAmount, 0) 
                 - (ISNULL(dbo.IpdBillMaster.AmountReceived, 0) + ISNULL(dbo.IpdBillMaster.Discount, 0)+ ISNULL(dbo.IpdBillMaster.InsuranceAmt, 0)) AS Balance, ISNULL(dbo.IpdBillMaster.InvoiceNo, 0) AS InvoiceNo, 
                 dbo.IpdBillMaster.BillNo, dbo.PatMainType.PatMainType, dbo.PatientInsuType.PatientInsuType, dbo.IpdRegistration.EntryDate, dbo.IpdRegistration.EntryTime, 
                 dbo.HospEmpMst.Title + ' ' + dbo.HospEmpMst.Empname AS PrimaryDocName, dbo.DepartmentMst.DeptName, dbo.IpdRegistration.DeptId, 
                 dbo.AlloctnOfBed.PatStatus, dbo.AlloctnOfBed.DateOfAdmission, dbo.AlloctnOfBed.DateOfDischarge as FinalDischargeOn, dbo.IpdBillMaster.FinalDischargeBy, 
                 dbo.RoomType.RType, dbo.IpdRegistration.FId, dbo.IpdRegistration.BranchId, dbo.AlloctnOfBed.ReasonforDischarge ,
				 PatientInformation.PatientAddress, IpdRegistration.ProcedureName, IpdRegistration.VisitingNo, IpdRegistration.Sponsor AS Diagnosis, InsurancePaymentDetails.Sponsor1Amt, InsurancePaymentDetails.Sponsor2Amt, 
PatientInsuType_2.PatientInsuType AS Sponsor1, PatientInsuType.PatientInsuType AS Sponsor2
             FROM            IpdRegistration INNER JOIN
IpdBillMaster ON IpdRegistration.IpdId = IpdBillMaster.IpdId AND IpdRegistration.PatRegId = IpdBillMaster.PatRegId AND IpdRegistration.BranchId = IpdBillMaster.BranchId LEFT OUTER JOIN
PatientInsuType ON IpdRegistration.PatientSubCategoryId2 = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN
PatientInsuType AS PatientInsuType_2 ON IpdRegistration.PatientSubCategoryId = PatientInsuType_2.PatientInsuTypeId LEFT OUTER JOIN
InsurancePaymentDetails ON IpdRegistration.PatRegId = InsurancePaymentDetails.PatRegId AND IpdRegistration.IpdNo = InsurancePaymentDetails.IPDNo LEFT OUTER JOIN
RoomType INNER JOIN
RoomMst INNER JOIN
AlloctnOfBed INNER JOIN
BedMst ON AlloctnOfBed.BedId = BedMst.BedId ON RoomMst.RoomId = BedMst.RoomId ON RoomType.RTypeId = RoomMst.RTypeId ON IpdRegistration.IpdId = AlloctnOfBed.IpdId LEFT OUTER JOIN
DepartmentMst ON IpdRegistration.DeptId = DepartmentMst.DeptId LEFT OUTER JOIN
HospEmpMst ON IpdRegistration.PrimaryDoc = HospEmpMst.DrId LEFT OUTER JOIN
PatientInsuType AS PatientInsuType_1 ON IpdRegistration.PatientSubCategoryId = PatientInsuType_1.PatientInsuTypeId LEFT OUTER JOIN
PatMainType ON IpdRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN
Initial RIGHT OUTER JOIN
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON IpdRegistration.PatRegId = PatientInformation.PatRegId
				 WHERE (dbo.AlloctnOfBed.PatStatus = 'Admitted' OR dbo.AlloctnOfBed.PatStatus = 'Discharged') and dbo.IpdRegistration.IpdId= '18298' and IpdRegistration.FId='1'
				and IpdBillMaster.Branchid>0 and IpdRegistration.BranchId='1' and dbo.IpdRegistration.PatRegId= '38964')
GO

ALTER VIEW [dbo].[VW_IpdLabServicedetails] AS (SELECT        IpdBillServiceDetails.IpdBillServiceDetailId, IpdBillServiceDetails.IpdNo, IpdBillServiceDetails.IpdId, IpdBillServiceDetails.PatRegId, IpdBillServiceDetails.BillGroupId, IpdBillServiceDetails.BillServiceId, 
IpdBillServiceDetails.BillServiceCharges, IpdBillServiceDetails.Qty, IpdBillServiceDetails.TotalCharges, IpdBillServiceDetails.DrId, IpdBillServiceDetails.FId, IpdBillServiceDetails.BillNo, IpdBillServiceDetails.BranchId, 
IpdBillServiceDetails.CreatedBy, IpdBillServiceDetails.CreatedOn, IpdBillServiceDetails.UpdatedBy, IpdBillServiceDetails.UpdatedOn, IpdBillServiceDetails.DeptId, IpdBillServiceDetails.Description, 
IpdBillServiceDetails.BillServiceType, IpdBillServiceDetails.IsDischarge, IpdBillServiceDetails.IsClose, IpdBillServiceDetails.CancelAdmission, IpdBillServiceDetails.OT, IpdBillServiceDetails.MTCode, 
IpdBillServiceDetails.ServiceName, Initial.Title + ' ' + PatientInformation.FirstName AS PatientNAme, PatientInformation.Age, PatientInformation.AgeType,PatientInformation.MobileNo,
IpdBillServiceDetails.MainDoctor,LabRegistration.LabPtype
,case when LabRegistration.LabPtype='P' then 'Pathlogy' when LabRegistration.LabPtype='R' then 'Radiology' else 'Medical Lab' end as PatientDept
FROM            IpdBillServiceDetails INNER JOIN
PatientInformation ON IpdBillServiceDetails.PatRegId = PatientInformation.PatRegId INNER JOIN
Initial ON PatientInformation.TitleId = Initial.TitleId INNER JOIN
LabRegistration ON IpdBillServiceDetails.LABNO = LabRegistration.LabNo AND IpdBillServiceDetails.PatRegId = LabRegistration.PatRegId 
WHERE  LabRegistration.CancelBill=0  and dbo.IpdBillServiceDetails.FId='1' and  dbo.IpdBillServiceDetails.BranchId='1' and (CAST(CAST(YEAR(dbo.IpdBillServiceDetails.Createdon) AS varchar(4)) + '/' + CAST(MONTH(dbo.IpdBillServiceDetails.Createdon) AS varchar(2)) + '/' + CAST(DAY(dbo.IpdBillServiceDetails.Createdon) AS varchar(2)) AS datetime)) between '2022-12-10'  and '2022-12-11' and LabRegistration.LabPtype = 'R')
GO

ALTER VIEW [dbo].[Vw_IpdPatientBillServices] AS (SELECT dbo.IpdBillServiceDetails.IpdId, dbo.IpdBillServiceDetails.IpdNo, dbo.IpdBillServiceDetails.PatRegId, dbo.IpdBillServiceDetails.BillGroupId, 
           dbo.IpdBillServiceDetails.TotalCharges, dbo.IpdBillServiceDetails.BillNo, dbo.BillGroup.GroupName, case  WHEN IpdBillServiceDetails.ItemId <> 0 THEN IpdBillServiceDetails.ItemName when IpdBillServiceDetails.MtCode<>'' then IpdBillServiceDetails.ServiceName else dbo.BillService.ServiceName end as ServiceName , 
           dbo.IpdBillServiceDetails.BillServiceCharges, dbo.IpdBillServiceDetails.Qty, ISNULL(dbo.HospEmpMst.Title, '') + ' ' + ISNULL(dbo.HospEmpMst.Empname, '') 
           AS ServiceDoctoName, ISNULL(dbo.IpdBillServiceDetails.DrId, 0) AS DrId, dbo.IpdBillServiceDetails.BillServiceType, dbo.IpdBillServiceDetails.Description , IpdBillServiceDetails.CreatedOn as ServiceEntryDate
		   FROM    dbo.HospEmpMst RIGHT OUTER JOIN
			dbo.IpdBillServiceDetails ON dbo.HospEmpMst.DrId = dbo.IpdBillServiceDetails.DrId LEFT OUTER JOIN
			dbo.BillService ON dbo.IpdBillServiceDetails.BillServiceId = dbo.BillService.BillServiceId LEFT OUTER JOIN
			dbo.BillGroup ON dbo.IpdBillServiceDetails.BillGroupId = dbo.BillGroup.BillGroupId
			where dbo.IpdBillServiceDetails.PatRegId= '38964' and  dbo.IpdBillServiceDetails.IpdId= '18298')
GO

ALTER VIEW [dbo].[Vw_IPDPatientDetailsNew] AS (SELECT        dbo.Initial.Title + ' ' + dbo.PatientInformation.FirstName AS FirstName, dbo.IpdRegistration.PatRegId, dbo.IpdRegistration.EntryDate, dbo.IpdRegistration.ReferenceDoc, dbo.IpdRegistration.CreatedBy, 
                         dbo.IpdRegistration.FId, dbo.IpdRegistration.BranchId, dbo.PatientInformation.Age, dbo.PatientInformation.AgeType, dbo.Gender.GenderName, dbo.PatientInformation.PatientAddress, 
                         dbo.IpdRegistration.IpdNo
FROM            dbo.IpdRegistration INNER JOIN
                         dbo.PatientInformation ON dbo.IpdRegistration.PatRegId = dbo.PatientInformation.PatRegId AND dbo.IpdRegistration.BranchId = dbo.PatientInformation.BranchId INNER JOIN
                         dbo.Initial ON dbo.PatientInformation.TitleId = dbo.Initial.TitleId INNER JOIN
                         dbo.Gender ON dbo.PatientInformation.GenderId = dbo.Gender.GenderId where
								 dbo.IpdRegistration.CancelAdmission<>1 and
				 IpdRegistration.FId='1' and IpdRegistration.BranchId='1'	
	             and (CAST(CAST(YEAR( dbo.IpdRegistration.EntryDate) AS varchar(4)) + '/' + CAST(MONTH( dbo.IpdRegistration.EntryDate) AS varchar(2)) + '/' + CAST(DAY( dbo.IpdRegistration.EntryDate) AS varchar(2)) AS datetime)) between '2022-11-01'  and '2022-11-30')
GO

ALTER VIEW [dbo].[Vw_LabBillReport] AS (SELECT        Vw_LabBillServiceDetails.BillNo, LabBillPaymentTrns.ReceiptNo, Vw_LabBillServiceDetails.FirstName AS PatientName, Vw_LabBillServiceDetails.PatRegId, Vw_LabBillServiceDetails.LabNo,   
                         Vw_LabBillServiceDetails.ServiceName, LabBillPaymentTrns.ReceivedAmount, LabBillPaymentTrns.DiscountAmt, LabBillPaymentTrns.BalanceAmt, LabBillPaymentTrns.BankName, LabBillPaymentTrns.ChequeDate,   
                         LabBillPaymentTrns.ChequeNo, LabBillPaymentTrns.PaymentMode, Vw_LabBillServiceDetails.BillServiceCharges, LabBillPaymentTrns.PaymentDate, Vw_LabBillServiceDetails.Entrydate,   
                         Vw_LabBillServiceDetails.RegistrationType, Vw_LabBillServiceDetails.ReferenceDoc, LabBillPaymentTrns.PaymentReceivedBy AS CreatedBy, Vw_LabBillServiceDetails.PatientComplaints, Vw_LabBillServiceDetails.Empname,   
                         Vw_LabBillServiceDetails.DrId, LabBillPaymentTrns.DiscGivenBy, LabBillPaymentTrns.ReasonForBalance, LabBillPaymentTrns.ReasonForDisc, LabBillPaymentTrns.UpdatedOn, HospEmpMst.Empname AS DiscountGivenBy,   
                         DiscountTypeMst.DiscType, ReasonForBalance.ReasonForBalanceName, LabBillPaymentTrns.BranchId, LabBillPaymentTrns.FId, ModeOfPayment.ModeOfPaymentName, Vw_LabBillServiceDetails.Qty,   
                         Vw_LabBillServiceDetails.SingleBillServiceCharges, LabBillPaymentTrns.InsuranceCompId, LabBillPaymentTrns.InsuranceAmount, LabBillPaymentTrns.IsInsurance, Vw_LabBillServiceDetails.GenderName,   
                         Vw_LabBillServiceDetails.PatientAddress, Vw_LabBillServiceDetails.MobileNo, Vw_LabBillServiceDetails.PatMainType, Vw_LabBillServiceDetails.ReferBy, Vw_LabBillServiceDetails.LabPtype,   
                         Vw_LabBillServiceDetails.AgeType, Vw_LabBillServiceDetails.Age, Vw_LabBillServiceDetails.PatientMainCategoryId, Vw_LabBillServiceDetails.PatientSubCategoryId, PatientInsuType.PatientInsuType,   
                         CAST(Vw_LabBillServiceDetails.QRImage AS VARBINARY(8000)) AS QRImage, Vw_LabBillServiceDetails.LetterNo, Vw_LabBillServiceDetails.InsuranceChargeCompany, Vw_LabBillServiceDetails.AfterHrs ,LabBillPaymentTrns.ChargeNumber 
FROM            Vw_LabBillServiceDetails INNER JOIN  
                         LabBillPaymentTrns ON Vw_LabBillServiceDetails.BillNo = LabBillPaymentTrns.BillNo AND Vw_LabBillServiceDetails.LabNo = LabBillPaymentTrns.LabNo AND   
                         Vw_LabBillServiceDetails.ReceiptNo = LabBillPaymentTrns.ReceiptNo INNER JOIN  
                         ModeOfPayment ON LabBillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId INNER JOIN  
                         PatientInsuType ON Vw_LabBillServiceDetails.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId INNER JOIN  
                         PatMainType ON Vw_LabBillServiceDetails.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN  
                         HospEmpMst ON LabBillPaymentTrns.DiscGivenBy = HospEmpMst.DrId LEFT OUTER JOIN  
                         DiscountTypeMst ON LabBillPaymentTrns.ReasonForDisc = DiscountTypeMst.DiscTypeId LEFT OUTER JOIN  
                         ReasonForBalance ON LabBillPaymentTrns.ReasonForBalance = ReasonForBalance.ReasonForBalanceId  
    
                 where Vw_LabBillServiceDetails.BillNo='3927' and dbo.LabBillPaymentTrns.ReceiptNo= '8298' and     
     Vw_LabBillServiceDetails.Labno='8287' and dbo.Vw_LabBillServiceDetails.PatRegId='134679' and dbo.LabBillPaymentTrns.FId='1' and dbo.LabBillPaymentTrns.BranchId='1')
GO

ALTER VIEW [dbo].[Vw_LabBillServiceDetails] AS SELECT        Initial.Title + ' ' + PatientInformation.FirstName AS FirstName, LabRegistration.PatRegId, LabRegistration.Entrydate, LabRegistration.RegistrationType, LabRegistration.ReferenceDoc, LabRegistration.CreatedBy, 
                         LabRegistration.FId, LabRegistration.BranchId, LabRegistration.PatientComplaints, LabRegistration.LabNo, LabServiceDetails.BillServiceId, 
                         LabServiceDetails.ServiceName + '' + CASE WHEN LabServiceDetails.CancelBill = 1 THEN ' [Cancel Service]' ELSE '' END AS ServiceName, LabServiceDetails.DrId, 
                         HospEmpMst.Title + ' ' + HospEmpMst.Empname AS Empname, LabServiceDetails.BillServiceCharges, LabServiceDetails.BillNo, LabServiceDetails.Qty, LabServiceDetails.BillServiceCharges AS SingleBillServiceCharges, 
                         LabRegistration.TokenNo, Initial.Title, Gender.GenderName, DepartmentMst.DeptName, HospEmpMst.Title AS DrInitial, PatientInformation.PatientAddress, PatientInformation.MobileNo, PatMainType.PatMainType, 
                         LabServiceDetails.ReceiptNo, PatientInformation.Age, PatientInformation.AgeType, LabRegistration.LabPtype, LabRegistration.ReferBy, LabRegistration.PatientMainCategoryId, LabRegistration.PatientSubCategoryId, 
                         LabRegistration.QRImage, LabRegistration.LetterNo, LabRegistration.InsuranceChargeCompany, LabRegistration.AfterHrs
FROM            LabRegistration INNER JOIN
                         LabServiceDetails ON LabRegistration.LabNo = LabServiceDetails.LabNo INNER JOIN
                         PatientInformation ON LabRegistration.PatRegId = PatientInformation.PatRegId INNER JOIN
                         Initial ON PatientInformation.TitleId = Initial.TitleId LEFT OUTER JOIN
                         Gender ON PatientInformation.GenderId = Gender.GenderId LEFT OUTER JOIN
                         PatMainType ON LabRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN
                         DepartmentMst ON LabRegistration.DeptId = DepartmentMst.DeptId LEFT OUTER JOIN
                         HospEmpMst ON LabServiceDetails.DrId = HospEmpMst.DrId
GO

ALTER VIEW [dbo].[Vw_LabEditPatients] AS SELECT DISTINCT 
                         Vw_LabOutstanding.BillNo, Vw_LabOutstanding.PatientName, Vw_LabOutstanding.Entrydate, Vw_LabOutstanding.OPDNo, Vw_LabOutstanding.PatRegId, Vw_LabOutstanding.MobileNo, Vw_LabOutstanding.FId, 
                         Vw_LabOutstanding.BranchId, Vw_LabOutstanding.Age, Vw_LabOutstanding.AgeType, Vw_LabOutstanding.GenderName, Vw_LabOutstanding.Empname, LabBillPaymentTrns.IsInsurance, LabBillPaymentTrns.LabNo, 
                         Vw_LabOutstanding.ReferBy, Vw_LabOutstanding.LabPtype, LabBillPaymentTrns.CreatedBy,LabBillPaymentTrns.PaymentReceivedBy
FROM            Vw_LabOutstanding INNER JOIN
                         LabBillPaymentTrns ON Vw_LabOutstanding.BillNo = LabBillPaymentTrns.BillNo AND Vw_LabOutstanding.PatRegId = LabBillPaymentTrns.PatRegId AND
						  Vw_LabOutstanding.LabNo = LabBillPaymentTrns.LabNo
--GROUP BY Vw_LabOutstanding.BillNo, Vw_LabOutstanding.PatientName, Vw_LabOutstanding.BillServiceCharges, Vw_LabOutstanding.Entrydate, Vw_LabOutstanding.OPDNo, Vw_LabOutstanding.PatRegId, Vw_LabOutstanding.MobileNo, 
--Vw_LabOutstanding.FId, Vw_LabOutstanding.BranchId, Vw_LabOutstanding.Age, Vw_LabOutstanding.AgeType, Vw_LabOutstanding.GenderName, Vw_LabOutstanding.Empname, LabBillPaymentTrns.InsuranceAmount, 
--LabBillPaymentTrns.InsuranceCompId, LabBillPaymentTrns.IsInsurance, LabBillPaymentTrns.LabNo, Vw_LabOutstanding.ReferBy, Vw_LabOutstanding.LabPtype, LabBillPaymentTrns.CreatedBy
GO

ALTER VIEW [dbo].[Vw_LabIPDBillReport] AS (SELECT        LabRegistration.ID, LabRegistration.LabNo,  LabRegistration.TokenNo, LabRegistration.PatRegId, LabRegistration.DrId, LabRegistration.VisitingNo, LabRegistration.Entrydate, 
LabRegistration.RegistrationType, LabRegistration.ReferenceDoc, LabRegistration.DeptId, LabRegistration.PatientComplaints, LabRegistration.PatientMainCategoryId, LabRegistration.PatientSubCategoryId, LabRegistration.FId, 
LabRegistration.BranchId, LabRegistration.CreatedBy, LabRegistration.CreatedOn, LabRegistration.UpdatedBy, LabRegistration.UpdatedOn, LabRegistration.IsPatientChecked, LabRegistration.ReferBy, 
LabRegistration.LabPtype, LabRegistration.CancelBill, LabRegistration.CancelBy, LabRegistration.CancelRemark, LabRegistration.CancelOn, IpdBillServiceDetails.MainDoctor, IpdBillServiceDetails.ServiceName, 
IpdBillServiceDetails.MTCode, Initial.Title +' '+PatientInformation.FirstName as PatientName,  PatientInformation.PhoneNo, PatientInformation.MobileNo,
 PatientInformation.PatientAddress, PatientInformation.Age, IpdBillServiceDetails.IpdNo,PatientInformation.AgeType ,
IpdBillServiceDetails.BillNo
FROM            LabRegistration INNER JOIN
IpdBillServiceDetails ON LabRegistration.LabNo = IpdBillServiceDetails.LABNO AND LabRegistration.PatRegId = IpdBillServiceDetails.PatRegId INNER JOIN
PatientInformation ON LabRegistration.PatRegId = PatientInformation.PatRegId INNER JOIN
Initial ON PatientInformation.TitleId = Initial.TitleId

                 where IpdBillServiceDetails.IpdNo='18347'  and 
				 LabRegistration.Labno='287671' and dbo.IpdBillServiceDetails.PatRegId='214830' and dbo.IpdBillServiceDetails.FId='1' and dbo.IpdBillServiceDetails.BranchId='1')
GO

ALTER VIEW [dbo].[Vw_LabPaymentTransactionRpt_UserWise] AS (SELECT       
case when ModeOfPayment.ModeOfPaymentName='Cash' then LabBillPaymentTrns.ReceivedAmount else 0 end as CashAmt,     
case when ModeOfPayment.ModeOfPaymentName='Cheque' then LabBillPaymentTrns.ReceivedAmount else 0 end as ChequeAmt,     
case when ModeOfPayment.ModeOfPaymentName='RBL Card' then LabBillPaymentTrns.ReceivedAmount else 0 end as RBLAmt,     
case when ModeOfPayment.ModeOfPaymentName='Charge To Account' then LabBillPaymentTrns.ReceivedAmount else 0 end as CTAmt,      ModeOfPayment.ModeOfPaymentName,    
case when LabRegistration.LabPtype='P' then 'Pathology' when LabRegistration.LabPtype='R' then 'Radiology' else 'Medical LAB' end as BillGroup,    
LabRegistration.LabPtype,     
LabBillPaymentTrns.ReceivedAmount,    
LabBillPaymentTrns.PaymentReceivedon as PaymentDate, LabBillPaymentTrns.PatRegId, Initial.Title,     
PatientInformation.FirstName, LabBillPaymentTrns.CancelAdmission, LabBillPaymentTrns.BillPaymentid,    
    
 case when isnull(PaymentReceivedBy,'') ='' then  LabBillPaymentTrns.PaymentReceivedBy else PaymentReceivedBy end as CreatedBy,    
  LabBillPaymentTrns.CreatedOn, LabBillPaymentTrns.ChequeNo,     
LabBillPaymentTrns.PaymentMode, LabBillPaymentTrns.ChequeDate, LabBillPaymentTrns.BankName, LabBillPaymentTrns.FId, LabBillPaymentTrns.BranchId, LabBillPaymentTrns.BillNo,     
    
PatMainType.PatMainType, LabBillPaymentTrns.BillAmount, LabBillPaymentTrns.InsuranceAmount, LabBillPaymentTrns.DiscountAmt,     
LabRegistration.PatientSubCategoryId, PatientInsuType.PatientInsuType,LabRegistration.MainDoctor, VW_GetLabeServiceName.SerVicesName    
FROM            LabBillPaymentTrns INNER JOIN    
LabRegistration ON LabBillPaymentTrns.PatRegId = LabRegistration.PatRegId AND LabBillPaymentTrns.LabNo = LabRegistration.LabNo INNER JOIN    
PatMainType ON LabRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId INNER JOIN    
PatientInsuType ON PatMainType.PatMainTypeId = PatientInsuType.PatMainTypeId AND LabRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN    
VW_GetLabeServiceName ON LabBillPaymentTrns.LabNo = VW_GetLabeServiceName.labno AND LabBillPaymentTrns.PatRegId = VW_GetLabeServiceName.Patregid LEFT OUTER JOIN    
Initial RIGHT OUTER JOIN    
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON LabBillPaymentTrns.PatRegId = PatientInformation.PatientInfoId LEFT OUTER JOIN    
ModeOfPayment ON LabBillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId    
WHERE  LabRegistration.CancelBill=0  and dbo.LabBillPaymentTrns.FId='1' and  dbo.LabBillPaymentTrns.BranchId='1' and dbo.LabBillPaymentTrns.PaymentDate between 'Mar 22 2023  7:45AM'  and 'Mar 22 2023 12:00PM' and dbo.LabBillPaymentTrns.PaymentReceivedBy = 'CECILY HUGHES')
GO

ALTER VIEW [dbo].[Vw_LABPaymentTransactionRpt_UserWise_Cancel] AS (SELECT   
case when ModeOfPayment.ModeOfPaymentName='Cash' then LabBillPaymentTrns.ReceivedAmount else 0 end as CashAmt, 
case when ModeOfPayment.ModeOfPaymentName='Cheque' then LabBillPaymentTrns.ReceivedAmount else 0 end as ChequeAmt, 
case when ModeOfPayment.ModeOfPaymentName='RBL Card' then LabBillPaymentTrns.ReceivedAmount else 0 end as RBLAmt, 
case when ModeOfPayment.ModeOfPaymentName='Charge To Account' then LabBillPaymentTrns.ReceivedAmount else 0 end as CTAmt,      ModeOfPayment.ModeOfPaymentName,
case when LabRegistration.LabPtype='P' then 'Pathology' when LabRegistration.LabPtype='R' then 'Radiology' else 'Medical LAB' end as BillGroup,
LabRegistration.LabPtype,LabBillPaymentTrns.ReceivedAmount,LabBillPaymentTrns.PaymentDate, LabBillPaymentTrns.PatRegId, Initial.Title, 
PatientInformation.FirstName, LabBillPaymentTrns.CancelAdmission, LabBillPaymentTrns.BillPaymentid, LabBillPaymentTrns.CreatedBy, LabBillPaymentTrns.CreatedOn, LabBillPaymentTrns.ChequeNo, 
LabBillPaymentTrns.PaymentMode, LabBillPaymentTrns.ChequeDate, LabBillPaymentTrns.BankName, LabBillPaymentTrns.FId, LabBillPaymentTrns.BranchId, LabBillPaymentTrns.BillNo,LabBillPaymentTrns.LabNo,
PatMainType.PatMainType, LabBillPaymentTrns.BillAmount, LabBillPaymentTrns.InsuranceAmount, LabBillPaymentTrns.DiscountAmt, 
LabRegistration.PatientSubCategoryId, PatientInsuType.PatientInsuType, LabRegistration.CancelBy,LabRegistration.CancelRemark,LabRegistration.CancelOn
FROM            LabBillPaymentTrns INNER JOIN
LabRegistration ON LabBillPaymentTrns.PatRegId = LabRegistration.PatRegId AND LabBillPaymentTrns.LabNo = LabRegistration.Labno INNER JOIN
PatMainType ON LabRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId INNER JOIN
PatientInsuType ON PatMainType.PatMainTypeId = PatientInsuType.PatMainTypeId AND LabRegistration.PatientSubCategoryId = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN
Initial RIGHT OUTER JOIN
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON LabBillPaymentTrns.PatRegId = PatientInformation.PatientInfoId LEFT OUTER JOIN
ModeOfPayment ON LabBillPaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId
WHERE  LabRegistration.CancelBill=1  and dbo.LabBillPaymentTrns.FId='1' and  dbo.LabBillPaymentTrns.BranchId='1' and (CAST(CAST(YEAR(dbo.LabBillPaymentTrns.PaymentDate) AS varchar(4)) + '/' + CAST(MONTH(dbo.LabBillPaymentTrns.PaymentDate) AS varchar(2)) + '/' + CAST(DAY(dbo.LabBillPaymentTrns.PaymentDate) AS varchar(2)) AS datetime)) between '2023-03-20'  and '2023-03-20')
GO

ALTER VIEW [dbo].[Vw_MealsFigureReport] AS (SELECT IpdRegistration.EntryDate, IpdBillServiceDetails.IpdNo,IpdBillServiceDetails.Qty,Cast(IpdBillServiceDetails.Qty as Int) as Qty1,
			Case when IsNull(ABS(IpdBillServiceDetails.Qty)-CAST(ABS(IpdBillServiceDetails.Qty) As INT ),0) > 0 then Cast( ABS(IpdBillServiceDetails.Qty)-CAST(ABS(IpdBillServiceDetails.Qty) As INT) as Int) +1 else 0 end as dqty , BillGroup.GroupName, IpdBillServiceDetails.BillGroupId, 
            IpdBillServiceDetails.BillServiceId, BillService.ServiceName, IpdRegistration.IsAdmited
			FROM    BillService RIGHT OUTER JOIN
            IpdBillServiceDetails ON BillService.BillServiceId = IpdBillServiceDetails.BillServiceId LEFT OUTER JOIN
			BillGroup ON IpdBillServiceDetails.BillGroupId = BillGroup.BillGroupId LEFT OUTER JOIN
			IpdRegistration ON IpdBillServiceDetails.IpdNo = IpdRegistration.IpdNo 
			WHERE (BillGroup.BillGroupId = 1) AND (BillService.ServiceName <> 'Day Case Unit') AND  IpdRegistration.CancelAdmission<>1
		   and (CAST(CAST(YEAR( dbo.IpdRegistration.EntryDate) AS varchar(4)) + '/' + CAST(MONTH( dbo.IpdRegistration.EntryDate) AS varchar(2)) + '/' + CAST(DAY( dbo.IpdRegistration.EntryDate) AS varchar(2)) AS datetime)) between '2022-11-01'  and '2022-11-30'
		   and  IpdRegistration.FId='1' and IpdRegistration.BranchId='1')
GO

CREATE VIEW [dbo].[Vw_OpdBillOutStandingPayment_Proce] AS SELECT        ProcedureBillMaster.ProcedureId, ProcedureBillMaster.PatRegId, ProcedureBillMaster.PatientMainType, ProcedureBillMaster.PatientSubType, ProcedureBillMaster.BillAmount, ProcedureBillMaster.AmountPaid,   
                         ProcedureBillMaster.Discount, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.BillAmount - (ProcedureBillMaster.AmountPaid + ProcedureBillMaster.Discount + ProcedureBillMaster.InsuranceAmt) AS BalanceAmt,   
                         ProcedureBillMaster.BillGroup, ProcedureBillMaster.BillNo, ProcedureBillMaster.FId, ProcedureBillMaster.BranchId, ProcedureBillMaster.CreatedBy, ProcedureBillMaster.CreatedOn,   
                         ProcedureBillMaster.CreatedOn AS EntryDate, ProcedureBillMaster.UpdatedBy, ProcedureBillMaster.UpdatedOn, ProcedureBillMaster.CancelBill, ProcedureBillMaster.DiscountGivenById,   
                         ProcedureBillMaster.ReasonForBalanceId, ProcedureBillMaster.ReasonForDiscountId, ProcedureBillMaster.CancelBy, ProcedureBillMaster.CancelOn, ProcedureBillMaster.Details, ProcedureBillMaster.ProcedureNo,   
                         ProcedureBillMaster.OPDNo, ProcedureBillMaster.BillGroupId, ProcedureBillMaster.InsuranceChargeCompamt, ProcedureBillMaster.LetterNo, ProcedureBillMaster.TypeOfVisit, PatientInsuType.PatientInsuType,   
                         PatientInsu_SubType.ChildCompanyName, PatMainType.PatMainType, PatientInformation.FirstName, PatientInformation.LastName, PatientInformation.BirthDate, Gender.GenderName, PatientInformation.PolicyNo,   
                         PatientInformation.MaritalStatus, PatientInformation.BloodGroup, PatientInformation.GuardianName, PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress,   
                         PatientInformation.CancelReason, PatientInformation.Age, PatientInformation.AgeType, PatientInformation.Nationality, PatientInformation.BirthPlace, PatientInformation.VaccinationStatus, PatientInformation.Allergy,   
                         PatientInformation.ChiefComplant, PatientInformation.HealthCardNo, PatientInformation.PassportNo, PatientInformation.Relation, PatientInformation.FirstName + '  ' + ISNULL(PatientInformation.LastName, '') AS PatientName,   
                        HospEmpMst.Title+'.'+ HospEmpMst.Empname AS DrName  
FROM            ProcedureBillMaster INNER JOIN  
                         PatientInsuType ON ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId INNER JOIN  
                         PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId INNER JOIN  
                         PatientInformation ON ProcedureBillMaster.PatRegId = PatientInformation.PatRegId INNER JOIN  
                         Gender ON PatientInformation.GenderId = Gender.GenderId INNER JOIN  
                         OpdRegistration ON ProcedureBillMaster.OPDNo = OpdRegistration.OpdNo AND ProcedureBillMaster.PatRegId = OpdRegistration.PatRegId INNER JOIN  
                         HospEmpMst ON OpdRegistration.DrId = HospEmpMst.DrId LEFT OUTER JOIN  
                         PatientInsu_SubType ON ProcedureBillMaster.InsuranceChargeCompamt = PatientInsu_SubType.ID  
WHERE        (ProcedureBillMaster.OPDNo > 0)
GO

ALTER VIEW [dbo].[Vw_OpdBillReport] AS (SELECT dbo.Vw_OPDBillServiceDetails.BillNo, dbo.BillPaymentTrns.ReceiptNo, dbo.Vw_OPDBillServiceDetails.FirstName AS PatientName,
                dbo.Vw_OPDBillServiceDetails.PatRegId, dbo.Vw_OPDBillServiceDetails.OpdNo, dbo.Vw_OPDBillServiceDetails.ServiceName,
                dbo.BillPaymentTrns.ReceivedAmount, dbo.BillPaymentTrns.DiscountAmt, dbo.BillPaymentTrns.BalanceAmt, dbo.BillPaymentTrns.BankName,
                dbo.BillPaymentTrns.ChequeDate, dbo.BillPaymentTrns.ChequeNo, dbo.BillPaymentTrns.PaymentMode, dbo.Vw_OPDBillServiceDetails.BillServiceCharges,
                 dbo.BillPaymentTrns.PaymentDate, dbo.Vw_OPDBillServiceDetails.Entrydate, dbo.Vw_OPDBillServiceDetails.RegistrationType,
                 dbo.Vw_OPDBillServiceDetails.ReferenceDoc, dbo.BillPaymentTrns.CreatedBy, dbo.Vw_OPDBillServiceDetails.PatientComplaints,
                 dbo.Vw_OPDBillServiceDetails.Empname, dbo.Vw_OPDBillServiceDetails.DrId, dbo.BillPaymentTrns.DiscGivenBy, dbo.BillPaymentTrns.ReasonForBalance, 
                 dbo.BillPaymentTrns.ReasonForDisc, dbo.BillPaymentTrns.UpdatedOn, dbo.HospEmpMst.Empname AS DiscountGivenBy, dbo.DiscountTypeMst.DiscType, 
                 dbo.ReasonForBalance.ReasonForBalanceName, dbo.BillPaymentTrns.BranchId, dbo.BillPaymentTrns.FId, dbo.ModeOfPayment.ModeOfPaymentName, 
				  dbo.Vw_OPDBillServiceDetails.Qty, dbo.Vw_OPDBillServiceDetails.SingleBillServiceCharges
                 FROM dbo.Vw_OPDBillServiceDetails INNER JOIN
                 dbo.BillPaymentTrns ON dbo.Vw_OPDBillServiceDetails.BillNo = dbo.BillPaymentTrns.BillNo AND 
                 dbo.Vw_OPDBillServiceDetails.OpdNo = dbo.BillPaymentTrns.OpdNo INNER JOIN 
                 dbo.ModeOfPayment ON dbo.BillPaymentTrns.PaymentMode = dbo.ModeOfPayment.ModeOfPaymentId LEFT OUTER JOIN 
                 dbo.HospEmpMst ON dbo.BillPaymentTrns.DiscGivenBy = dbo.HospEmpMst.DrId LEFT OUTER JOIN 
                 dbo.DiscountTypeMst ON dbo.BillPaymentTrns.ReasonForDisc = dbo.DiscountTypeMst.DiscTypeId LEFT OUTER JOIN 
                 dbo.ReasonForBalance ON dbo.BillPaymentTrns.ReasonForBalance = dbo.ReasonForBalance.ReasonForBalanceId 
                 where Vw_OPDBillServiceDetails.BillNo='3927' and dbo.BillPaymentTrns.ReceiptNo= '8298' and 
				 Vw_OPDBillServiceDetails.OpdNo='0' and dbo.Vw_OPDBillServiceDetails.PatRegId='134679' and dbo.BillPaymentTrns.FId='1' and dbo.BillPaymentTrns.BranchId='1')
GO

ALTER VIEW [dbo].[VW_OPDCasePaper] AS (SELECT DISTINCT   Initial.Title + ' ' + PatientInformation.FirstName AS FirstName, OpdRegistration.PatRegId, OpdRegistration.Entrydate, OpdRegistration.RegistrationType, OpdRegistration.ReferenceDoc, OpdRegistration.CreatedBy,     OpdRegistration.FId, OpdRegistration.BranchId, OpdRegistration.PatientComplaints, OpdRegistration.OpdNo, OpdIpdBillServiceDetails.BillServiceId, BillService.ServiceName, OpdIpdBillServiceDetails.DrId,    HospEmpMst.Title + ' ' + HospEmpMst.Empname AS Empname, OpdIpdBillServiceDetails.BillServiceCharges, OpdIpdBillServiceDetails.BillNo, OpdIpdBillServiceDetails.Qty, OpdIpdBillServiceDetails.SingleBillServiceCharges,    OpdRegistration.TokenNo, Initial.Title, Gender.GenderName, DepartmentMst.DeptName, HospEmpMst.Title AS DrInitial, PatientInformation.PatientAddress, PatientInformation.MobileNo, PatMainType.PatMainType  ,cast(PatientInformation.Age as nvarchar(50))+' '+ PatientInformation.AgeType as AgeType    FROM            OpdRegistration INNER JOIN    OpdIpdBillServiceDetails ON OpdRegistration.OpdNo = OpdIpdBillServiceDetails.OpdNo INNER JOIN    PatientInformation ON OpdRegistration.PatRegId = PatientInformation.PatRegId INNER JOIN    BillService ON OpdIpdBillServiceDetails.BillServiceId = BillService.BillServiceId INNER JOIN    Initial ON PatientInformation.TitleId = Initial.TitleId INNER JOIN    Gender ON PatientInformation.GenderId = Gender.GenderId INNER JOIN     DepartmentMst ON OpdRegistration.DeptId = DepartmentMst.DeptId INNER JOIN    PatMainType ON OpdRegistration.PatientMainCategoryId = PatMainType.PatMainTypeId LEFT OUTER JOIN    HospEmpMst ON OpdIpdBillServiceDetails.DrId = HospEmpMst.DrId  where OpdRegistration.branchid=1  and OpdRegistration.OpdNo= 148582 and  OpdRegistration.PatRegId= 122107)
GO

CREATE VIEW [dbo].[VW_OPDCasePaper_New] AS (SELECT DISTINCT    Initial.Title + ' ' + PatientInformation.FirstName AS FirstName, ProcedureBillMaster.ChargeNumber as RegistrationType, OpdRegistration.ReferenceDoc, OpdRegistration.FId, OpdRegistration.BranchId, OpdRegistration.PatientComplaints,   OpdRegistration.OpdNo, HospEmpMst.Title + ' ' + HospEmpMst.Empname AS Empname, OpdRegistration.TokenNo, Initial.Title, Gender.GenderName, DepartmentMst.DeptName, HospEmpMst.Title AS DrInitial,   PatientInformation.PatientAddress, PatientInformation.MobileNo, PatMainType.PatMainType, CAST(PatientInformation.Age AS nvarchar(50)) + ' ' + PatientInformation.AgeType AS AgeType, OpdRegistration.VaccinationStatus,    ProcedureBillMaster.BillAmount, ProcedureBillMaster.AmountPaid, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.BillNo, ProcedureBillMaster.LetterNo, ProcedureBillMaster.TypeOfVisit,    ProcedureServiceDetails.BillServiceCharges, ProcedureServiceDetails.Qty, ProcedureServiceDetails.TotalCharges, BillService.ServiceName, ProcedureServiceDetails.CreatedOn, ProcedureServiceDetails.CreatedBy,    ProcedureBillMaster.PatRegId, ProcedureBillMaster.BillGroup, PatientInsuType.PatientInsuType, PatientInsu_SubType.ChildCompanyName, PatientInsu_SubType.CompanyDescription, PatientInformation.BirthDate,    PatientInformation.Email,PatientInformation.ChiefComplant,ProcedureBillMaster.ProcedureId   FROM            ProcedureServiceDetails INNER JOIN       ProcedureBillMaster INNER JOIN      ProcedurePaymentTrns ON ProcedureBillMaster.ProcedureId = ProcedurePaymentTrns.ProcedureId AND ProcedureBillMaster.PatRegId = ProcedurePaymentTrns.PatRegId ON      ProcedureServiceDetails.PatRegId = ProcedureBillMaster.PatRegId AND ProcedureServiceDetails.ProcedureId = ProcedureBillMaster.ProcedureId INNER JOIN      BillService ON ProcedureServiceDetails.BillServiceId = BillService.BillServiceId INNER JOIN      PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId INNER JOIN      Initial INNER JOIN      PatientInformation ON Initial.TitleId = PatientInformation.TitleId INNER JOIN      Gender ON PatientInformation.GenderId = Gender.GenderId ON ProcedureBillMaster.PatRegId = PatientInformation.PatRegId INNER JOIN      PatientInsuType ON ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN      ChargeBill_Master ON ProcedureBillMaster.PatRegId = ChargeBill_Master.Patregid LEFT OUTER JOIN      HospEmpMst ON ProcedureServiceDetails.DrId = HospEmpMst.DrId LEFT OUTER JOIN      PatientInsu_SubType ON ProcedureBillMaster.InsuranceChargeCompamt = PatientInsu_SubType.ID LEFT OUTER JOIN      DepartmentMst INNER JOIN      OpdRegistration ON DepartmentMst.DeptId = OpdRegistration.DeptId ON ProcedureBillMaster.OPDNo = OpdRegistration.OpdNo AND      ProcedureBillMaster.PatRegId = OpdRegistration.PatRegId   where   CAST(CAST(YEAR(ProcedureBillMaster.Createdon) AS varchar(4)) + '/' + CAST(MONTH(ProcedureBillMaster.Createdon) AS varchar(2)) + '/' + CAST(DAY(ProcedureBillMaster.Createdon) AS varchar(2))  AS datetime)  =  CAST(CAST(YEAR(getdate()) AS varchar(4)) + '-' + CAST(MONTH(getdate()) AS varchar(2)) + '-' + CAST(DAY(getdate()) AS varchar(2)) AS datetime))
GO

ALTER VIEW [dbo].[Vw_OpdFinalBillReport] AS (SELECT dbo.Vw_OPDOutstanding.BillNo, dbo.Vw_OPDOutstanding.PatientName, dbo.Vw_OPDOutstanding.BillServiceCharges, dbo.Vw_OPDOutstanding.Entrydate,  dbo.Vw_OPDOutstanding.OpdNo, dbo.Vw_OPDOutstanding.PatRegId, SUM(dbo.BillPaymentTrns.ReceivedAmount) AS ReceivedAmount,  SUM(dbo.BillPaymentTrns.DiscountAmt) AS DiscountAmt, dbo.Vw_OPDOutstanding.BillServiceCharges - (SUM(dbo.BillPaymentTrns.DiscountAmt)  + SUM(dbo.BillPaymentTrns.ReceivedAmount)) AS BalanceAmt, dbo.Vw_OPDOutstanding.MobileNo, dbo.Vw_OPDOutstanding.FId,  dbo.Vw_OPDOutstanding.BranchId, dbo.Vw_OPDOutstanding.Age, dbo.Vw_OPDOutstanding.AgeType, dbo.Vw_OPDOutstanding.GenderName,  dbo.Vw_OPDOutstanding.Empname, dbo.Vw_OPDOutstanding.PatientInsuType, dbo.Vw_OPDOutstanding.PatMainType, dbo.Vw_OPDOutstanding.BloodGroup,  dbo.Vw_OPDOutstanding.BirthDate, dbo.OpdIpdBillServiceDetails.Qty, dbo.OpdIpdBillServiceDetails.SingleBillServiceCharges, dbo.BillService.ServiceName, dbo.OpdIpdBillServiceDetails.BillServiceId, dbo.OpdIpdBillServiceDetails.BillServiceCharges AS TotalCharges  FROM    dbo.Vw_OPDOutstanding INNER JOIN dbo.BillPaymentTrns ON dbo.Vw_OPDOutstanding.BillNo = dbo.BillPaymentTrns.BillNo AND  dbo.Vw_OPDOutstanding.PatRegId = dbo.BillPaymentTrns.PatRegId AND dbo.Vw_OPDOutstanding.OpdNo = dbo.BillPaymentTrns.OpdNo INNER JOIN  dbo.OpdIpdBillServiceDetails ON dbo.Vw_OPDOutstanding.PatRegId = dbo.OpdIpdBillServiceDetails.PatRegId AND  dbo.Vw_OPDOutstanding.OpdNo = dbo.OpdIpdBillServiceDetails.OpdNo AND dbo.Vw_OPDOutstanding.BillNo = dbo.OpdIpdBillServiceDetails.BillNo INNER JOIN  dbo.BillService ON dbo.OpdIpdBillServiceDetails.BillServiceId = dbo.BillService.BillServiceId  where Vw_OPDOutstanding.BillNo=2  and Vw_OPDOutstanding.OpdNo=2 and  dbo.Vw_OPDOutstanding.PatRegId=900 and dbo.BillPaymentTrns.FId=1 and dbo.BillPaymentTrns.BranchId=1   GROUP BY dbo.Vw_OPDOutstanding.BillNo, dbo.Vw_OPDOutstanding.PatientName, dbo.Vw_OPDOutstanding.BillServiceCharges, dbo.Vw_OPDOutstanding.Entrydate,  dbo.Vw_OPDOutstanding.OpdNo, dbo.Vw_OPDOutstanding.PatRegId, dbo.Vw_OPDOutstanding.MobileNo, dbo.Vw_OPDOutstanding.FId,  dbo.Vw_OPDOutstanding.BranchId, dbo.Vw_OPDOutstanding.Age, dbo.Vw_OPDOutstanding.AgeType, dbo.Vw_OPDOutstanding.GenderName, dbo.Vw_OPDOutstanding.Empname, dbo.Vw_OPDOutstanding.PatientInsuType, dbo.Vw_OPDOutstanding.PatMainType, dbo.Vw_OPDOutstanding.BloodGroup,  dbo.Vw_OPDOutstanding.BirthDate, dbo.OpdIpdBillServiceDetails.Qty, dbo.OpdIpdBillServiceDetails.SingleBillServiceCharges, dbo.BillService.ServiceName, dbo.OpdIpdBillServiceDetails.BillServiceId, dbo.OpdIpdBillServiceDetails.BillServiceCharges )
GO

ALTER VIEW [dbo].[Vw_OTPatientListReport] AS (SELECT        OTRegisterDetails.OTId, OTRegisterDetails.Patregid, OTRegisterDetails.IPDNO, OTRegisterDetails.Surgan, OTRegisterDetails.ANAESTHETIST,  
                               OTRegisterDetails.Disease, OTRegisterDetails.Operation, 
                               OTRegisterDetails.OperationStartTime, OTRegisterDetails.OperationEndTime, OTRegisterDetails.AnisticTime, OTRegisterDetails.Remark, OTRegisterDetails.GeneralOT, OTRegisterDetails.Branchid, OTRegisterDetails.FID,  OTRegisterDetails.OperationStartDate, OTRegisterDetails.OperationEndDate, OTRegisterDetails.Createdby, OTRegisterDetails.CreatedOn, OTRegisterDetails.UpdatedBy, OTRegisterDetails.UpdatedOn, OperationMst.OperationName, DiseaseMst.DiseaseName, HospEmpMst.Empname AS SurganName,  
                         ISNULL(HospEmpMst_1.Empname, '') AS ANAESTHETISTName, ISNULL(HospEmpMst_2.Empname, '') AS FirstAssistant, ISNULL(OTRegisterDetails.SecondAssistant, '') AS SecondAssistant, ISNULL(HospEmpMst_4.Empname, '') 
                         AS TrollyNurse, ISNULL(HospEmpMst_5.Empname,'') AS SteriNurse, ISNULL(HospEmpMst_6.Empname, '') AS SwabCountNurse, ISNULL(HospEmpMst_7.Empname, '') AS InstrumentCountNurse,
						  Initial.Title +' '+PatientInformation.FirstName as FirstName, 
                         PatientInformation.TitleId
FROM            OTRegisterDetails INNER JOIN
                         OperationMst ON OTRegisterDetails.Operation = OperationMst.OperationId INNER JOIN
                         DiseaseMst ON OTRegisterDetails.Disease = DiseaseMst.DiseaseId INNER JOIN
                         IpdRegistration ON OTRegisterDetails.Patregid = IpdRegistration.PatRegId AND OTRegisterDetails.IPDNO = IpdRegistration.IpdNo INNER JOIN
                         PatientInformation ON OTRegisterDetails.Patregid = PatientInformation.PatRegId INNER JOIN
                         Initial ON PatientInformation.TitleId = Initial.TitleId LEFT OUTER JOIN
                         HospEmpMst AS HospEmpMst_7 ON OTRegisterDetails.InstrumentCountNurse = HospEmpMst_7.DrId LEFT OUTER JOIN
                         HospEmpMst AS HospEmpMst_6 ON OTRegisterDetails.SwabCountNurse = HospEmpMst_6.DrId LEFT OUTER JOIN
                         HospEmpMst AS HospEmpMst_5 ON OTRegisterDetails.SteriNurse = HospEmpMst_5.DrId LEFT OUTER JOIN
                         HospEmpMst AS HospEmpMst_4 ON OTRegisterDetails.TrollyNurse = HospEmpMst_4.DrId LEFT OUTER JOIN                        
                         HospEmpMst AS HospEmpMst_2 ON OTRegisterDetails.FirstAssistant = HospEmpMst_2.DrId LEFT OUTER JOIN
                         HospEmpMst AS HospEmpMst_1 ON OTRegisterDetails.ANAESTHETIST = HospEmpMst_1.DrId LEFT OUTER JOIN
                         HospEmpMst ON OTRegisterDetails.Surgan = HospEmpMst.DrId
WHERE      IpdRegistration.BranchId='1'
	and  IpdRegistration.FId='1'   and CONVERT(date, OTRegisterDetails.CreatedOn) 	between '2022-12-07'and '2022-12-09')
GO

CREATE VIEW [dbo].[Vw_PatientInsuranceDetailsForInvoice_ForOPD] AS (SELECT        PatientInvoiceDetails_ForOPD.InvoiceNo, PatientInvoiceDetails_ForOPD.PatRegId, PatientInvoiceDetails_ForOPD.InsuranceAmount, PatientInvoiceDetails_ForOPD.Sponser,
PatientInvoiceDetails_ForOPD.TransactionDate,   
PatientInvoiceDetails_ForOPD.FId, PatientInvoiceDetails_ForOPD.BranchId, PatientInvoiceDetails_ForOPD.ChargeNo, PatientInsuType.PatientInsuType, PatientInformation.FirstName as PatientName  
FROM  PatientInsuType RIGHT OUTER JOIN  
PatientInvoiceDetails_ForOPD LEFT OUTER JOIN  
PatientInformation ON PatientInvoiceDetails_ForOPD.PatRegId = PatientInformation.PatRegId ON 
PatientInsuType.PatientInsuTypeId = PatientInvoiceDetails_ForOPD.Sponser where  
      PatientInvoiceDetails_ForOPD.FId='1' and PatientInvoiceDetails_ForOPD.BranchId='1'  
     and dbo.PatientInvoiceDetails_ForOPD.InvoiceNo ='1' and PatientInvoiceDetails_ForOPD.Sponser='7')
GO

CREATE VIEW [dbo].[Vw_PatientInsuranceDetailsForInvoice_ForOPD_Report] AS (SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt
    
, ChargeBill_Master.InsuranceAmt,             
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, BillService.ServiceName, HospEmpMst.Empname, ChargeBill_Details.BillServiceId,             
ChargeBill_Details.MTCode, PatientInsuType.PatientInsuType,'' as LabServiceName  ,ChargeBill_Details.BillGroupName,ChargeBill_Details.BillNo,ChargeBill_Details.Charges ,        
PatientInformation.FirstName , PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress   ,ChargeBill_Details.Qty   
,ChargeBill_Master.Discount,DiscountAmt,DiscountGivenBy,DiscountGivenOn,ActualInsuAmt,DiscountRemark,ChargeBill_Details.ID AS ChdetId  
FROM            ChargeBill_Master INNER JOIN        
ChargeBill_Details ON ChargeBill_Master.ID = ChargeBill_Details.ChargeId INNER JOIN        
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN        
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN        
HospEmpMst ON ChargeBill_Details.DrId = HospEmpMst.DrId LEFT OUTER JOIN        
BillService ON ChargeBill_Details.BillServiceId = BillService.BillServiceId          
              
     where ChargeBill_Details.BillServiceId>0 and ChargeBill_Master.ID ='1356'             
 union all            
SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,         
 ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, LabServiceDetails.ServiceName, HospEmpMst.Empname, ChargeBill_Details.BillServiceId,         
 ChargeBill_Details.MTCode, PatientInsuType.PatientInsuType, '' AS LabServiceName, ChargeBill_Details.BillGroupName, ChargeBill_Details.BillNo, ChargeBill_Details.Charges,        
       PatientInformation.FirstName  ,PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress   ,ChargeBill_Details.Qty     
    ,ChargeBill_Master.Discount,DiscountAmt,DiscountGivenBy,DiscountGivenOn,ActualInsuAmt,DiscountRemark  ,ChargeBill_Details.ID AS ChdetId
FROM            ChargeBill_Master INNER JOIN        
ChargeBill_Details ON ChargeBill_Master.ID = ChargeBill_Details.ChargeId INNER JOIN        
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN        
LabServiceDetails ON ChargeBill_Details.MTCode = LabServiceDetails.MTCode AND ChargeBill_Details.BillServiceId = LabServiceDetails.BillServiceId AND ChargeBill_Details.PatRegId = LabServiceDetails.PatRegId AND         
ChargeBill_Details.BillNo = LabServiceDetails.BillNo INNER JOIN        
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN        
HospEmpMst ON ChargeBill_Details.DrId = HospEmpMst.DrId        
 where  ChargeBill_Master.ID ='1356'     
 union all    
 SELECT        ChargeBill_Master.ID, ChargeBill_Master.ChargeId, ChargeBill_Master.ChargeNo, ChargeBill_Master.InsuranceCompId, ChargeBill_Master.Patregid, ChargeBill_Master.BillAmt, ChargeBill_Master.InsuranceAmt,     
ChargeBill_Master.CreatedBy, ChargeBill_Master.CreatedOn, ChargeBill_Master.CancelBill, ChargeBill_Master.GenerateInvoice, ChargeBill_Details.DrugName AS ServiceName, HospEmpMst.Empname,     
ChargeBill_Details.BillServiceId, ChargeBill_Details.MTCode, PatientInsuType.PatientInsuType, '' AS LabServiceName, ChargeBill_Details.BillGroupName, ChargeBill_Details.BillNo, ChargeBill_Details.Charges,     
PatientInformation.FirstName, PatientInformation.MobileNo, PatientInformation.PhoneNo, PatientInformation.PatientAddress ,ChargeBill_Details.Qty   
,ChargeBill_Master.Discount,DiscountAmt,DiscountGivenBy,DiscountGivenOn,ActualInsuAmt,DiscountRemark , ChargeBill_Details.ID AS ChdetId
FROM            ChargeBill_Master INNER JOIN    
ChargeBill_Details ON ChargeBill_Master.ID = ChargeBill_Details.ChargeId INNER JOIN    
PatientInsuType ON ChargeBill_Master.InsuranceCompId = PatientInsuType.PatientInsuTypeId INNER JOIN    
PatientInformation ON ChargeBill_Master.Patregid = PatientInformation.PatRegId LEFT OUTER JOIN    
HospEmpMst ON ChargeBill_Details.DrId = HospEmpMst.DrId where  ChargeBill_Details.DrugId>0 and ChargeBill_Master.ID ='1356' )
GO

ALTER VIEW [dbo].[Vw_PatientwiseBillGroupIncome] AS (SELECT dbo.IpdBillServiceDetails.PatRegId, dbo.BillService.ServiceName, dbo.BillGroup.GroupName, dbo.IpdBillServiceDetails.BillGroupId, 
                 dbo.IpdBillServiceDetails.TotalCharges, dbo.IpdBillServiceDetails.CreatedOn, dbo.Initial.Title + ' ' + dbo.PatientInformation.FirstName AS PatientName, 
                 dbo.IpdBillServiceDetails.Qty, dbo.IpdBillServiceDetails.BillServiceCharges, dbo.IpdBillServiceDetails.FId, dbo.IpdBillServiceDetails.BranchId, 
                 dbo.IpdBillMaster.IsDischarge, dbo.IpdBillMaster.IsClose, dbo.IpdBillMaster.FinalDischargeOn, dbo.IpdBillMaster.FinalDischargeBy,
				 dbo.IpdBillServiceDetails.DrId, ISNULL(dbo.HospEmpMst.Title + ' ' + dbo.HospEmpMst.Empname, ' ') AS DoctorName
                 FROM    dbo.IpdBillServiceDetails LEFT OUTER JOIN
                 dbo.HospEmpMst ON dbo.IpdBillServiceDetails.DrId = dbo.HospEmpMst.DrId LEFT OUTER JOIN				 
                 dbo.IpdBillMaster ON dbo.IpdBillServiceDetails.IpdNo = dbo.IpdBillMaster.IpdNo LEFT OUTER JOIN
                 dbo.Initial RIGHT OUTER JOIN
                 dbo.PatientInformation ON dbo.Initial.TitleId = dbo.PatientInformation.TitleId ON 
                 dbo.IpdBillServiceDetails.PatRegId = dbo.PatientInformation.PatRegId LEFT OUTER JOIN
                 dbo.BillService ON dbo.IpdBillServiceDetails.BillServiceId = dbo.BillService.BillServiceId LEFT OUTER JOIN
                 dbo.BillGroup ON dbo.IpdBillServiceDetails.BillGroupId = dbo.BillGroup.BillGroupId
				 where  dbo.IpdBillMaster.IsDischarge=1  and
				 dbo.IpdBillServiceDetails.BillGroupId ='8' and  dbo.IpdBillServiceDetails.FId='1' and  dbo.IpdBillServiceDetails.BranchId='1' 
				and (CAST(CAST(YEAR(IpdBillMaster.FinalDischargeOn) AS varchar(4)) + '/' + CAST(MONTH(IpdBillMaster.FinalDischargeOn) AS varchar(2)) + '/' + CAST(DAY(IpdBillMaster.FinalDischargeOn) AS varchar(2)) AS datetime))
				between '2022-11-01'  and '2022-11-30')
GO

ALTER VIEW [dbo].[Vw_procedureBillMaster] AS ( SELECT        ProcedureBillMaster.PatRegId, Initial.Title, PatientInformation.FirstName, PatientInsuType.PatientInsuType, ProcedureBillMaster.PatientSubType, ProcedureBillMaster.PatientMainType, ProcedureBillMaster.BillAmount,   
ProcedureBillMaster.AmountPaid, ProcedureBillMaster.Discount, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.BillGroup, ProcedureBillMaster.BillNo, ProcedureBillMaster.CreatedBy, ProcedureBillMaster.CreatedOn,   
ProcedureBillMaster.BranchId, ProcedureBillMaster.FId, PatMainType.PatMainType, ProcedureBillMaster.ProcedureId, ProcedurePaymentTrns.ChequeNo, ProcedurePaymentTrns.ChequeDate,   
ProcedurePaymentTrns.BankName, ProcedurePaymentTrns.PaymentMode, ProcedurePaymentTrns.ReceivedAmount, ProcedurePaymentTrns.PaymentDate, ModeOfPayment.ModeOfPaymentName, PatientInformation.MobileNo,   
cast( PatientInformation.Age as varchar(50)) +' '+ PatientInformation.AgeType as AgeType, Gender.GenderName ,ProcedureBillMaster.ChargeNumber ,ProcedureBillMaster.LetterNo
FROM            Initial RIGHT OUTER JOIN  
PatientInformation INNER JOIN  
Gender ON PatientInformation.GenderId = Gender.GenderId ON Initial.TitleId = PatientInformation.TitleId RIGHT OUTER JOIN  
ProcedurePaymentTrns INNER JOIN  
ProcedureBillMaster ON ProcedurePaymentTrns.BillNo = ProcedureBillMaster.BillNo AND ProcedurePaymentTrns.PatRegId = ProcedureBillMaster.PatRegId AND   
ProcedurePaymentTrns.ProcedureId = ProcedureBillMaster.ProcedureId LEFT OUTER JOIN  
ModeOfPayment ON ProcedurePaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId LEFT OUTER JOIN  
PatientInsuType ON ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId ON PatientInformation.PatRegId = ProcedureBillMaster.PatRegId LEFT OUTER JOIN  
PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId  
     where ProcedureBillMaster.BillNo='1267' and ProcedureBillMaster.PatRegId ='91230'  
    and  ProcedureBillMaster.FId='1' and ProcedureBillMaster.BranchId ='1'  
     and ProcedureBillMaster.ProcedureId ='6858')
GO

ALTER VIEW [dbo].[Vw_ProcedureBillServiceDetails] AS (SELECT dbo.ProcedureServiceDetails.PatRegId, dbo.BillService.ServiceName, dbo.ProcedureServiceDetails.BillServiceId,   
                 dbo.ProcedureServiceDetails.BillServiceCharges, dbo.ProcedureServiceDetails.Qty, dbo.ProcedureServiceDetails.TotalCharges,   
                 dbo.ProcedureServiceDetails.FId, dbo.ProcedureServiceDetails.BillNo, dbo.ProcedureServiceDetails.BranchId, dbo.ProcedureServiceDetails.CreatedBy,   
                 dbo.ProcedureServiceDetails.CreatedOn, dbo.ProcedureServiceDetails.BillGroup, dbo.ProcedureServiceDetails.ProcedureId,   
                 dbo.HospEmpMst.Title + ' ' + dbo.HospEmpMst.Empname AS DoctorName  
    FROM    dbo.ProcedureServiceDetails LEFT OUTER JOIN  
                 dbo.HospEmpMst ON dbo.ProcedureServiceDetails.DrId = dbo.HospEmpMst.DrId LEFT OUTER JOIN  
                 dbo.BillService ON dbo.ProcedureServiceDetails.BillServiceId = dbo.BillService.BillServiceId  
      where dbo.ProcedureServiceDetails.BillNo='1267' and dbo.ProcedureServiceDetails.PatRegId ='91230'  
    and  dbo.ProcedureServiceDetails.FId='1' and dbo.ProcedureServiceDetails.BranchId ='1'  
     and ProcedureServiceDetails.ProcedureId ='6858')
GO

ALTER VIEW [dbo].[VW_ProcedurePayment_AllServiceWise] AS SELECT  distinct Patregid,ProcedureId,Branchid,    
 ServiceName = STUFF(    (SELECT ',' + ServiceName    FROM VW_ProcedurePaymentServiceWise t1    WHERE t1.ProcedureId = t2.ProcedureId     
  and t1.Patregid = t2.Patregid   FOR XML PATH (''))   , 1, 1, '') from VW_ProcedurePaymentServiceWise t2      
  group by Patregid,ProcedureId,Branchid
GO

ALTER VIEW [dbo].[VW_ProcedurePaymentServiceWise] AS SELECT        ProcedureServiceDetails.PatRegId, ProcedureServiceDetails.BranchId, ProcedureServiceDetails.ProcedureId, BillService.ServiceName    
FROM            ProcedureServiceDetails INNER JOIN BillService ON ProcedureServiceDetails.BillServiceId = BillService.BillServiceId     
WHERE   dbo.ProcedureServiceDetails.FId='1' and  dbo.ProcedureServiceDetails.BranchId='1' and (CAST(CAST(YEAR(dbo.ProcedureServiceDetails.CreatedOn) AS varchar(4)) + '/' + CAST(MONTH(dbo.ProcedureServiceDetails.CreatedOn) AS varchar(2)) + '/' + CAST(DAY(dbo.ProcedureServiceDetails.CreatedOn) AS varchar(2)) AS datetime)) between '2023-02-17'  and '2023-02-17'
GO

ALTER VIEW [dbo].[Vw_ProcedurePaymentTransactionRpt_UserWise] AS (SELECT             
   case when ModeOfPayment.ModeOfPaymentName='Cash' then ProcedurePaymentTrns.ReceivedAmount else 0 end as CashAmt,           
case when ModeOfPayment.ModeOfPaymentName='Cheque' then ProcedurePaymentTrns.ReceivedAmount else 0 end as ChequeAmt,           
case when ModeOfPayment.ModeOfPaymentName='RBL Card' then ProcedurePaymentTrns.ReceivedAmount else 0 end as RBLAmt,           
case when ModeOfPayment.ModeOfPaymentName='Charge To Account' then ProcedurePaymentTrns.ReceivedAmount else 0 end as CTAmt,      ModeOfPayment.ModeOfPaymentName, ProcedurePaymentTrns.BillGroup, ProcedurePaymentTrns.ReceivedAmount,      
ProcedurePaymentTrns.PaymentDate, ProcedurePaymentTrns.PatRegId, Initial.Title,           
PatientInformation.FirstName, ProcedurePaymentTrns.CancelBill, ProcedurePaymentTrns.ProcedureId, ProcedurePaymentTrns.CreatedBy, ProcedurePaymentTrns.CreatedOn, ProcedurePaymentTrns.ChequeNo,           
ProcedurePaymentTrns.PaymentMode, ProcedurePaymentTrns.ChequeDate, ProcedurePaymentTrns.BankName, ProcedurePaymentTrns.FId, ProcedurePaymentTrns.BranchId, ProcedurePaymentTrns.BillNo,           
PatMainType.PatMainType, ProcedureBillMaster.BillAmount, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.Discount, ProcedureBillMaster.PatientSubType, PatientInsuType.PatientInsuType          
FROM            ProcedurePaymentTrns INNER JOIN          
ProcedureBillMaster ON ProcedurePaymentTrns.PatRegId = ProcedureBillMaster.PatRegId AND ProcedurePaymentTrns.ProcedureId = ProcedureBillMaster.ProcedureId INNER JOIN          
PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId INNER JOIN          
PatientInsuType ON PatMainType.PatMainTypeId = PatientInsuType.PatMainTypeId AND ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId LEFT OUTER JOIN          
Initial RIGHT OUTER JOIN          
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON ProcedurePaymentTrns.PatRegId = PatientInformation.PatientInfoId LEFT OUTER JOIN          
ModeOfPayment ON ProcedurePaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId          
WHERE  ProcedureBillMaster.CancelBill=0  and dbo.ProcedurePaymentTrns.FId='1' and  dbo.ProcedurePaymentTrns.BranchId='1' and dbo.ProcedurePaymentTrns.PaymentDate between 'Mar 22 2023 12:00AM'  and 'Mar 22 2023 11:59PM' and dbo.ProcedurePaymentTrns.CreatedBy = 'Kelle')
GO

ALTER VIEW [dbo].[Vw_ProcedurePaymentTransactionRpt_UserWise_service] AS (SELECT   
   case when ModeOfPayment.ModeOfPaymentName='Cash' then ProcedurePaymentTrns.ReceivedAmount else 0 end as CashAmt, 
case when ModeOfPayment.ModeOfPaymentName='Cheque' then ProcedurePaymentTrns.ReceivedAmount else 0 end as ChequeAmt, 
case when ModeOfPayment.ModeOfPaymentName='RBL Card' then ProcedurePaymentTrns.ReceivedAmount else 0 end as RBLAmt, 
case when ModeOfPayment.ModeOfPaymentName='Charge To Account' then ProcedurePaymentTrns.ReceivedAmount else 0 end as CTAmt,      ModeOfPayment.ModeOfPaymentName, ProcedurePaymentTrns.BillGroup, ProcedurePaymentTrns.ReceivedAmount, ProcedurePaymentTrns.PaymentDate, ProcedurePaymentTrns.PatRegId, Initial.Title, 
PatientInformation.FirstName, ProcedurePaymentTrns.CancelBill, ProcedurePaymentTrns.ProcedureId, ProcedurePaymentTrns.CreatedBy, ProcedurePaymentTrns.CreatedOn, ProcedurePaymentTrns.ChequeNo, 
ProcedurePaymentTrns.PaymentMode, ProcedurePaymentTrns.ChequeDate, ProcedurePaymentTrns.BankName, ProcedurePaymentTrns.FId, ProcedurePaymentTrns.BranchId, ProcedurePaymentTrns.BillNo, 
PatMainType.PatMainType, ProcedureBillMaster.BillAmount, ProcedureBillMaster.InsuranceAmt, ProcedureBillMaster.Discount, ProcedureBillMaster.PatientSubType, PatientInsuType.PatientInsuType,
VW_ProcedurePayment_AllServiceWise.ServiceName
FROM            ProcedurePaymentTrns INNER JOIN
ProcedureBillMaster ON ProcedurePaymentTrns.PatRegId = ProcedureBillMaster.PatRegId AND ProcedurePaymentTrns.ProcedureId = ProcedureBillMaster.ProcedureId INNER JOIN
PatMainType ON ProcedureBillMaster.PatientMainType = PatMainType.PatMainTypeId INNER JOIN
PatientInsuType ON PatMainType.PatMainTypeId = PatientInsuType.PatMainTypeId AND ProcedureBillMaster.PatientSubType = PatientInsuType.PatientInsuTypeId INNER JOIN
VW_ProcedurePayment_AllServiceWise ON ProcedureBillMaster.PatRegId = VW_ProcedurePayment_AllServiceWise.Patregid AND 
ProcedureBillMaster.ProcedureId = VW_ProcedurePayment_AllServiceWise.ProcedureId LEFT OUTER JOIN
Initial RIGHT OUTER JOIN
PatientInformation ON Initial.TitleId = PatientInformation.TitleId ON ProcedurePaymentTrns.PatRegId = PatientInformation.PatientInfoId LEFT OUTER JOIN
ModeOfPayment ON ProcedurePaymentTrns.PaymentMode = ModeOfPayment.ModeOfPaymentId
WHERE  ProcedureBillMaster.CancelBill=0  and dbo.ProcedurePaymentTrns.FId='1' and  dbo.ProcedurePaymentTrns.BranchId='1' and (CAST(CAST(YEAR(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(4)) + '/' + CAST(MONTH(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(2)) + '/' + CAST(DAY(dbo.ProcedurePaymentTrns.PaymentDate) AS varchar(2)) AS datetime)) between '2022-12-07'  and '2022-12-07' and dbo.ProcedurePaymentTrns.CreatedBy = 'leslie')
GO

ALTER VIEW [dbo].[Vw_ServiceWiseIncomeReport] AS (SELECT dbo.BillService.ServiceName, dbo.IpdBillServiceDetails.IpdNo, dbo.IpdBillServiceDetails.PatRegId, 
			dbo.Initial.Title + ' ' + dbo.PatientInformation.FirstName AS PatientName, dbo.IpdBillServiceDetails.BillServiceId, SUM(dbo.IpdBillServiceDetails.TotalCharges) 
			AS TotalCharges, SUM(dbo.IpdBillServiceDetails.Qty) AS Qty, dbo.IpdBillServiceDetails.DrId, 
			dbo.HospEmpMst.Title + ' ' + dbo.HospEmpMst.Empname AS Empname, dbo.IpdBillMaster.FId, dbo.IpdBillMaster.BranchId, 
			dbo.IpdBillMaster.FinalDischargeOn
			FROM dbo.HospEmpMst RIGHT OUTER JOIN
			dbo.IpdBillServiceDetails ON dbo.HospEmpMst.DrId = dbo.IpdBillServiceDetails.DrId LEFT OUTER JOIN
			dbo.PatientInformation LEFT OUTER JOIN
			dbo.Initial ON dbo.PatientInformation.TitleId = dbo.Initial.TitleId ON dbo.IpdBillServiceDetails.PatRegId = dbo.PatientInformation.PatRegId LEFT OUTER JOIN
			dbo.IpdBillMaster ON dbo.IpdBillServiceDetails.IpdNo = dbo.IpdBillMaster.IpdNo LEFT OUTER JOIN
			dbo.BillService ON dbo.IpdBillServiceDetails.BillServiceId = dbo.BillService.BillServiceId
			WHERE (IpdBillMaster.IsDischarge = 1) 
			and dbo.IpdBillMaster.FId ='1' and  dbo.IpdBillMaster.BranchId='1'
		   and  IpdBillServiceDetails.BillServiceId='1785'
		   and (CAST(CAST(YEAR(IpdBillMaster.FinalDischargeOn) AS varchar(4)) + '/' + CAST(MONTH(IpdBillMaster.FinalDischargeOn) AS varchar(2)) + '/' + CAST(DAY(IpdBillMaster.FinalDischargeOn) AS varchar(2)) AS datetime))
			between '2022-11-01'  and '2022-11-30'
		   GROUP BY dbo.BillService.ServiceName, dbo.IpdBillServiceDetails.IpdNo, dbo.IpdBillServiceDetails.PatRegId, dbo.Initial.Title, dbo.PatientInformation.FirstName, 
			dbo.IpdBillServiceDetails.BillServiceId, dbo.IpdBillServiceDetails.DrId, dbo.HospEmpMst.Title, dbo.HospEmpMst.Empname, dbo.IpdBillMaster.FId, 
			dbo.IpdBillMaster.BranchId, dbo.IpdBillMaster.FinalDischargeOn)
GO

ALTER VIEW [dbo].[Vw_ServiceWiseIncomeReport_Procedure] AS (SELECT dbo.BillService.ServiceName, dbo.Initial.Title + ' ' + dbo.PatientInformation.FirstName AS PatientName, 
                 ISNULL(dbo.HospEmpMst.Title + ' ' + dbo.HospEmpMst.Empname, '') AS Empname, dbo.ProcedureServiceDetails.PatRegId, 
                 SUM(dbo.ProcedureServiceDetails.Qty) AS Qty, SUM(dbo.ProcedureServiceDetails.TotalCharges) AS TotalCharges, dbo.ProcedureBillMaster.CreatedOn,
                  dbo.ProcedureServiceDetails.BillServiceId FROM    dbo.ProcedureBillMaster LEFT OUTER JOIN
                 dbo.ProcedureServiceDetails ON dbo.ProcedureBillMaster.BillNo = dbo.ProcedureServiceDetails.BillNo AND 
                 dbo.ProcedureBillMaster.PatRegId = dbo.ProcedureServiceDetails.PatRegId LEFT OUTER JOIN
                 dbo.HospEmpMst ON dbo.ProcedureServiceDetails.DrId = dbo.HospEmpMst.DrId LEFT OUTER JOIN
                 dbo.BillService ON dbo.ProcedureServiceDetails.BillServiceId = dbo.BillService.BillServiceId LEFT OUTER JOIN
                 dbo.PatientInformation ON dbo.ProcedureServiceDetails.PatRegId = dbo.PatientInformation.PatRegId LEFT OUTER JOIN
                 dbo.Initial ON dbo.PatientInformation.TitleId = dbo.Initial.TitleId
				 where ProcedureBillMaster.CancelBill <> 1
				 and dbo.ProcedureBillMaster.FId ='1' and  dbo.ProcedureBillMaster.BranchId='1'
				 and  ProcedureServiceDetails.BillServiceId='35'
				 and (CAST(CAST(YEAR(ProcedureBillMaster.CreatedOn) AS varchar(4)) + '/' + CAST(MONTH(ProcedureBillMaster.CreatedOn) AS varchar(2)) + '/' + CAST(DAY(ProcedureBillMaster.CreatedOn) AS varchar(2)) AS datetime))
				 between '2023-02-01'  and '2023-02-28'GROUP BY dbo.BillService.ServiceName, dbo.Initial.Title, dbo.PatientInformation.FirstName, dbo.HospEmpMst.Title, dbo.ProcedureServiceDetails.PatRegId, 
                 dbo.HospEmpMst.Empname, dbo.ProcedureBillMaster.CreatedOn,dbo.ProcedureServiceDetails.BillServiceId)
GO

DROP PROCEDURE [dbo].[SP_GetAttendentdata1]
GO

DROP PROCEDURE [dbo].[Sp_Delete_IPD_LabService]
GO

DROP PROCEDURE [dbo].[Sp_GetAdmissionType]
GO

DROP PROCEDURE [dbo].[Sp_GetBankName]
GO

DROP PROCEDURE [dbo].[Sp_GetInvestigationDetailsPatho_New]
GO

DROP PROCEDURE [dbo].[Sp_GetInvestigationDetailsRadio_New]
GO

DROP PROCEDURE [dbo].[Sp_GetInvestigationDetails_New]
GO

DROP TABLE IF EXISTS [dbo].[BankMaster]
GO
